<style>
  :root {
    --kpi-verde: #1E7F4F;
    --kpi-amarillo: #C79200;
    --kpi-rojo: #B00020;
    --kpi-gris: #6B7280;
  }

  .kpi {
    display: inline-flex;
    align-items: center;
    gap: 0.5em;
    margin: 0.2em 0.5em 0.2em 0;
    border-radius: 0.5em;
    padding: 0.2em 0.6em 0.2em 0.4em;
  }

  .kpi__valor {
    font-weight: bold;
    margin-left: 0.2em;
  }

  .kpi__estado {
    display: inline-block;
    margin-left: 0.5em;
    padding: 0.1em 0.7em;
    border-radius: 1em;
    font-size: 0.95em;
    font-weight: 600;
    letter-spacing: 0.01em;
    color: #fff;
    vertical-align: middle;
    min-width: 4.5em;
    text-align: center;
  }

  .kpi--verde {
    background: rgba(30, 127, 79, 0.08);
  }

  .kpi--amarillo {
    background: rgba(199, 146, 0, 0.08);
  }

  .kpi--rojo {
    background: rgba(176, 0, 32, 0.08);
  }

  .kpi--gris {
    background: rgba(107, 114, 128, 0.08);
  }

  .kpi--verde .kpi__estado {
    background: var(--kpi-verde);
  }

  .kpi--amarillo .kpi__estado {
    background: var(--kpi-amarillo);
  }

  .kpi--rojo .kpi__estado {
    background: var(--kpi-rojo);
  }

  .kpi--gris .kpi__estado {
    background: var(--kpi-gris);
  }

  /* Resaltado de filas predictivo cuando NO cumplen la meta */
  .predictivo-fail {
    background: rgba(255, 249, 235, 0.9);
    border-left: 4px solid #f59e0b;
  }

  .predictivo-fail td {
    background: transparent;
  }

  /* Cuando no cumplen PROM y TEND (ambas) */
  .predictivo-fail-both {
    background: rgba(254, 242, 242, 0.95);
    border-left: 4px solid #dc2626;
  }

  .predictivo-fail-both td {
    background: transparent;
  }

  .predictivo-legend {
    font-size: 0.85em;
    color: var(--kpi-gris);
    margin-top: 0.4rem;
    display: flex;
    gap: 1rem;
    align-items: center;
  }

  .predictivo-legend .item {
    display: inline-flex;
    gap: 0.4rem;
    align-items: center;
  }

  .predictivo-legend .sw {
    width: 14px;
    height: 12px;
    border-radius: 3px;
    display: inline-block;
  }
</style>
<script>
  (function () {
    // Configuración de umbrales y mapeo de KPI
    const kpiMap = [
      // Descripciones para tooltip
      // Puedes ajustar los textos según tu necesidad
      // Ejemplo: descripcion: 'Porcentaje de satisfacción de SNL'
      {
        keys: ['satisfaccion-snl', 'satisfacción-snl', 'satisfaccion snl', 'satisfacción snl'],
        label: /satisfac[ci][óo]n\\s*snl/i,
        type: 'porcentaje',
        umbrales: { verde: 95, amarillo: 85, rojo: 85, sentido: 'mayor' },
        descripcion: 'Porcentaje de satisfacción de SNL: mide la satisfacción de los usuarios con el servicio SNL.'
      },
      {
        keys: ['satisfaccion-ep', 'satisfacción-ep', 'satisfaccion ep', 'satisfacción ep'],
        label: /satisfac[ci][óo]n\\s*ep/i,
        type: 'porcentaje',
        umbrales: { verde: 95, amarillo: 85, rojo: 85, sentido: 'mayor' },
        descripcion: 'Porcentaje de satisfacción de EP: mide la satisfacción de los usuarios con el servicio EP.'
      },
      {
        keys: ['resolucion-snl', 'resolución-snl', 'resolucion snl', 'resolución snl'],
        label: /resoluci[óo]n\\s*snl/i,
        type: 'porcentaje',
        umbrales: { verde: 95, amarillo: 94, rojo: 80, sentido: 'mayor' },
        descripcion: 'Porcentaje de resolución SNL: mide la cantidad de casos resueltos en SNL.'
      },
      {
        keys: ['resolucion-ep', 'resolución-ep', 'resolucion ep', 'resolución ep'],
        label: /resoluci[óo]n\\s*ep/i,
        type: 'porcentaje',
        umbrales: { verde: 95, amarillo: 94, rojo: 80, sentido: 'mayor' },
        descripcion: 'Porcentaje de resolución EP: mide la cantidad de casos resueltos en EP.'
      },
      {
        keys: ['tmo', 'tiempo-medio-operacion', 'tiempo medio de operacion', 'tiempo medio de operación'],
        label: /tmo|tiempo\\s*medio\\s*de\\s*operaci[óo]n/i,
        type: 'minutos',
        umbrales: { verde: 3.00, amarillo: 5.00, rojo: 5.00, sentido: 'menor' },
        descripcion: 'Tiempo Medio de Operación (TMO): tiempo promedio de atención por caso.'
      },
      {
        keys: ['transferencia-epa', 'transferencia a epa'],
        label: /transferencia\\s*a\\s*epa/i,
        type: 'porcentaje',
        umbrales: { verde: 85, amarillo: 70, rojo: 70, sentido: 'mayor' },
        descripcion: 'Porcentaje de transferencias a EPA: mide cuántos casos se transfieren a EPA.'
      },
      {
        keys: ['tipificaciones', 'tipificacion'],
        label: /tipificaci[óo]n|tipificaciones/i,
        type: 'porcentaje',
        umbrales: { verde: 95, amarillo: 94, rojo: 80, sentido: 'mayor' },
        descripcion: 'Porcentaje de tipificaciones correctas: mide la calidad del registro de tipificaciones.'
      }
    ];

    // Utilidades de parseo
    function parsePorcentaje(str) {
      if (!str) return null;
      let val = str.replace(',', '.').replace('%', '').trim();
      let num = parseFloat(val);
      return isNaN(num) ? null : num;
    }
    function parseMinutos(str) {
      if (!str) return null;
      str = str.replace(',', '.');
      if (/^[0-9]+([\\.,][0-9]+)?$/.test(str)) return parseFloat(str); // decimal
      let partes = str.split(':').map(s => parseFloat(s.replace(',', '.')));
      if (partes.length === 2) return partes[0] + (partes[1] / 60);
      if (partes.length === 3) return partes[0] * 60 + (partes[1]) + (partes[2] / 60);
      return null;
    }
    function normalizaTexto(txt) {
      return txt.normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase();
    }
    function getKpiType(el) {
      // Estrategia A: data-kpi
      let kpi = el.getAttribute('data-kpi');
      if (kpi) {
        kpi = normalizaTexto(kpi);
        for (const def of kpiMap) {
          if (def.keys.some(key => normalizaTexto(key) === kpi)) return def;
        }
      }
      // Estrategia B: clase
      for (const def of kpiMap) {
        if (def.keys.some(key => el.classList.contains('kpi--' + key))) return def;
      }
      // Estrategia C: label cercano
      let label = '';
      let labelEl = el.querySelector('.kpi__label');
      if (labelEl) label = labelEl.textContent || '';
      else label = el.textContent || '';
      label = normalizaTexto(label);
      for (const def of kpiMap) {
        if (def.keys.some(key => label.includes(normalizaTexto(key)))) return def;
        if (def.label && def.label.test(label)) return def;
      }
      return null;
    }
    function getValorKpi(el, tipo) {
      // data-kpi-value
      let valEl = el.querySelector('[data-kpi-value]') || el.querySelector('.kpi__valor') || el;
      let raw = valEl.textContent || '';
      if (tipo === 'porcentaje') return parsePorcentaje(raw);
      if (tipo === 'minutos') return parseMinutos(raw);
      return null;
    }
    function getEstadoKpi(valor, def) {
      if (valor === null || valor === undefined || isNaN(valor)) return { estado: 'gris', texto: '', emoji: '' };
      if (def.type === 'porcentaje') {
        if (valor >= def.umbrales.verde) return { estado: 'verde', texto: 'Verde', emoji: '🟢' };
        if (valor >= def.umbrales.amarillo) return { estado: 'amarillo', texto: 'Amarillo', emoji: '🟡' };
        return { estado: 'rojo', texto: 'Rojo', emoji: '🔴' };
      }
      if (def.type === 'minutos') {
        if (valor <= def.umbrales.verde) return { estado: 'verde', texto: 'Verde', emoji: '🟢' };
        if (valor <= def.umbrales.amarillo) return { estado: 'amarillo', texto: 'Amarillo', emoji: '🟡' };
        return { estado: 'rojo', texto: 'Rojo', emoji: '🔴' };
      }
      return { estado: 'gris', texto: '', emoji: '' };
    }

    // 1. Buscar todos los posibles contenedores KPI
    let kpiEls = Array.from(document.querySelectorAll('.kpi, [data-kpi]'));
    // Eliminar duplicados
    kpiEls = kpiEls.filter((el, i, arr) => arr.indexOf(el) === i);

    kpiEls.forEach(el => {
      // 2. Inferir tipo de KPI
      const def = getKpiType(el);
      // 3. Extraer valor
      const valor = def ? getValorKpi(el, def.type) : null;
      // 4. Evaluar estado
      const estado = def ? getEstadoKpi(valor, def) : { estado: 'gris', texto: '', emoji: '' };
      // 5. Limpiar clases previas de estado
      el.classList.remove('kpi--verde', 'kpi--amarillo', 'kpi--rojo', 'kpi--gris');
      el.classList.add('kpi--' + estado.estado);
      // 6. Insertar/actualizar badget de estado
      let chip = el.querySelector('.kpi__estado');
      if (estado.texto) {
        if (!chip) {
          chip = document.createElement('span');
          chip.className = 'kpi__estado';
          el.appendChild(chip);
        }
        chip.textContent = estado.emoji ? (estado.emoji + ' ' + estado.texto) : estado.texto;
        chip.setAttribute('aria-label', 'Estado: ' + estado.texto);
        chip.setAttribute('title', 'Estado: ' + estado.texto);
      } else {
        if (chip) chip.remove();
      }
      // Tooltip explicativo
      if (def && def.descripcion) {
        el.setAttribute('title', def.descripcion);
      }
    });
  })();
</script>
<style>
  :root {
    --kpi-verde: #1E7F4F;
    --kpi-amarillo: #C79200;
    --kpi-rojo: #B00020;
    --kpi-gris: #6B7280;
  }

  .kpi {
    display: inline-flex;
    align-items: center;
    gap: 0.5em;
    margin: 0.2em 0.5em 0.2em 0;
    border-radius: 0.5em;
    padding: 0.2em 0.6em 0.2em 0.4em;
  }

  .kpi__valor {
    font-weight: bold;
    margin-left: 0.2em;
  }

  .kpi__estado {
    display: inline-block;
    margin-left: 0.5em;
    padding: 0.1em 0.7em;
    border-radius: 1em;
    font-size: 0.95em;
    font-weight: 600;
    letter-spacing: 0.01em;
    color: #fff;
    vertical-align: middle;
    min-width: 4.5em;
    text-align: center;
  }

  .kpi--verde {
    background: rgba(30, 127, 79, 0.08);
  }

  .kpi--amarillo {
    background: rgba(199, 146, 0, 0.08);
  }

  .kpi--rojo {
    background: rgba(176, 0, 32, 0.08);
  }

  .kpi--gris {
    background: rgba(107, 114, 128, 0.08);
  }

  .kpi--verde .kpi__estado {
    background: var(--kpi-verde);
  }

  .kpi--amarillo .kpi__estado {
    background: var(--kpi-amarillo);
  }

  .kpi--rojo .kpi__estado {
    background: var(--kpi-rojo);
  }

  .kpi--gris .kpi__estado {
    background: var(--kpi-gris);
  }
</style>
<script>
  (function () {
    // Configuración de umbrales y mapeo de KPI
    const kpiMap = [
      {
        keys: ['satisfaccion-snl', 'satisfacción-snl', 'satisfaccion snl', 'satisfacción snl'],
        label: /satisfac[ci][óo]n\\s*snl/i,
        type: 'porcentaje',
        umbrales: { verde: 95, amarillo: 85, rojo: 85, sentido: 'mayor' }
      },
      {
        keys: ['satisfaccion-ep', 'satisfacción-ep', 'satisfaccion ep', 'satisfacción ep'],
        label: /satisfac[ci][óo]n\\s*ep/i,
        type: 'porcentaje',
        umbrales: { verde: 95, amarillo: 85, rojo: 85, sentido: 'mayor' }
      },
      {
        keys: ['resolucion-snl', 'resolución-snl', 'resolucion snl', 'resolución snl'],
        label: /resoluci[óo]n\\s*snl/i,
        type: 'porcentaje',
        umbrales: { verde: 95, amarillo: 94, rojo: 80, sentido: 'mayor' }
      },
      {
        keys: ['resolucion-ep', 'resolución-ep', 'resolucion ep', 'resolución ep'],
        label: /resoluci[óo]n\\s*ep/i,
        type: 'porcentaje',
        umbrales: { verde: 95, amarillo: 94, rojo: 80, sentido: 'mayor' }
      },
      {
        keys: ['tmo', 'tiempo-medio-operacion', 'tiempo medio de operacion', 'tiempo medio de operación'],
        label: /tmo|tiempo\\s*medio\\s*de\\s*operaci[óo]n/i,
        type: 'minutos',
        umbrales: { verde: 3.00, amarillo: 5.00, rojo: 5.00, sentido: 'menor' }
      },
      {
        keys: ['transferencia-epa', 'transferencia a epa'],
        label: /transferencia\\s*a\\s*epa/i,
        type: 'porcentaje',
        umbrales: { verde: 85, amarillo: 70, rojo: 70, sentido: 'mayor' }
      },
      {
        keys: ['tipificaciones', 'tipificacion'],
        label: /tipificaci[óo]n|tipificaciones/i,
        type: 'porcentaje',
        umbrales: { verde: 95, amarillo: 94, rojo: 80, sentido: 'mayor' }
      }
    ];

    // Utilidades de parseo
    function parsePorcentaje(str) {
      if (!str) return null;
      let val = str.replace(',', '.').replace('%', '').trim();
      let num = parseFloat(val);
      return isNaN(num) ? null : num;
    }
    function parseMinutos(str) {
      if (!str) return null;
      str = str.replace(',', '.');
      if (/^[0-9]+([\\.,][0-9]+)?$/.test(str)) return parseFloat(str); // decimal
      let partes = str.split(':').map(s => parseFloat(s.replace(',', '.')));
      if (partes.length === 2) return partes[0] + (partes[1] / 60);
      if (partes.length === 3) return partes[0] * 60 + (partes[1]) + (partes[2] / 60);
      return null;
    }
    function normalizaTexto(txt) {
      return txt.normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase();
    }
    function getKpiType(el) {
      // Estrategia A: data-kpi
      let kpi = el.getAttribute('data-kpi');
      if (kpi) {
        kpi = normalizaTexto(kpi);
        for (const def of kpiMap) {
          if (def.keys.some(key => normalizaTexto(key) === kpi)) return def;
        }
      }
      // Estrategia B: clase
      for (const def of kpiMap) {
        if (def.keys.some(key => el.classList.contains('kpi--' + key))) return def;
      }
      // Estrategia C: label cercano
      let label = '';
      let labelEl = el.querySelector('.kpi__label');
      if (labelEl) label = labelEl.textContent || '';
      else label = el.textContent || '';
      label = normalizaTexto(label);
      for (const def of kpiMap) {
        if (def.keys.some(key => label.includes(normalizaTexto(key)))) return def;
        if (def.label && def.label.test(label)) return def;
      }
      return null;
    }
    function getValorKpi(el, tipo) {
      // data-kpi-value
      let valEl = el.querySelector('[data-kpi-value]') || el.querySelector('.kpi__valor') || el;
      let raw = valEl.textContent || '';
      if (tipo === 'porcentaje') return parsePorcentaje(raw);
      if (tipo === 'minutos') return parseMinutos(raw);
      return null;
    }
    function getEstadoKpi(valor, def) {
      if (valor === null || valor === undefined || isNaN(valor)) return { estado: 'gris', texto: '', emoji: '' };
      if (def.type === 'porcentaje') {
        if (valor >= def.umbrales.verde) return { estado: 'verde', texto: 'Verde', emoji: '🟢' };
        if (valor >= def.umbrales.amarillo) return { estado: 'amarillo', texto: 'Amarillo', emoji: '🟡' };
        return { estado: 'rojo', texto: 'Rojo', emoji: '🔴' };
      }
      if (def.type === 'minutos') {
        if (valor <= def.umbrales.verde) return { estado: 'verde', texto: 'Verde', emoji: '🟢' };
        if (valor <= def.umbrales.amarillo) return { estado: 'amarillo', texto: 'Amarillo', emoji: '🟡' };
        return { estado: 'rojo', texto: 'Rojo', emoji: '🔴' };
      }
      return { estado: 'gris', texto: '', emoji: '' };
    }

    // 1. Buscar todos los posibles contenedores KPI
    let kpiEls = Array.from(document.querySelectorAll('.kpi, [data-kpi]'));
    // Eliminar duplicados
    kpiEls = kpiEls.filter((el, i, arr) => arr.indexOf(el) === i);

    kpiEls.forEach(el => {
      // 2. Inferir tipo de KPI
      const def = getKpiType(el);
      // 3. Extraer valor
      const valor = def ? getValorKpi(el, def.type) : null;
      // 4. Evaluar estado
      const estado = def ? getEstadoKpi(valor, def) : { estado: 'gris', texto: '', emoji: '' };
      // 5. Limpiar clases previas de estado
      el.classList.remove('kpi--verde', 'kpi--amarillo', 'kpi--rojo', 'kpi--gris');
      el.classList.add('kpi--' + estado.estado);
      // 6. Insertar/actualizar badge de estado (solo si hay texto)
      let chip = el.querySelector('.kpi__estado');
      if (estado.texto) {
        if (!chip) {
          chip = document.createElement('span');
          chip.className = 'kpi__estado';
          el.appendChild(chip);
        }
        chip.textContent = estado.emoji ? (estado.emoji + ' ' + estado.texto) : estado.texto;
        chip.setAttribute('aria-label', 'Estado: ' + estado.texto);
        chip.setAttribute('title', 'Estado: ' + estado.texto);
      } else {
        if (chip) chip.remove();
      }
    });
  })();
</script>
<style>
  :root {
    --kpi-verde: #1E7F4F;
    --kpi-amarillo: #C79200;
    --kpi-rojo: #B00020;
    --kpi-gris: #6B7280;
  }

  .kpi {
    display: inline-flex;
    align-items: center;
    gap: 0.5em;
    margin: 0.2em 0.5em 0.2em 0;
    border-radius: 0.5em;
    padding: 0.2em 0.6em 0.2em 0.4em;
  }

  .kpi__valor {
    font-weight: bold;
    margin-left: 0.2em;
  }

  .kpi__estado {
    display: inline-block;
    margin-left: 0.5em;
    padding: 0.1em 0.7em;
    border-radius: 1em;
    font-size: 0.95em;
    font-weight: 600;
    letter-spacing: 0.01em;
    color: #fff;
    vertical-align: middle;
    min-width: 4.5em;
    text-align: center;
  }

  .kpi--verde {
    background: rgba(30, 127, 79, 0.08);
  }

  .kpi--amarillo {
    background: rgba(199, 146, 0, 0.08);
  }

  .kpi--rojo {
    background: rgba(176, 0, 32, 0.08);
  }

  .kpi--gris {
    background: rgba(107, 114, 128, 0.08);
  }

  .kpi--verde .kpi__estado {
    background: var(--kpi-verde);
  }

  .kpi--amarillo .kpi__estado {
    background: var(--kpi-amarillo);
  }

  .kpi--rojo .kpi__estado {
    background: var(--kpi-rojo);
  }

  .kpi--gris .kpi__estado {
    background: var(--kpi-gris);
  }
</style>
<script>
  (function () {
    // Configuración de umbrales y mapeo de KPI
    const kpiMap = [
      {
        keys: ['satisfaccion-snl', 'satisfacción-snl', 'satisfaccion snl', 'satisfacción snl'],
        label: /satisfac[ci][óo]n\\s*snl/i,
        type: 'porcentaje',
        umbrales: { verde: 95, amarillo: 85, rojo: 85, sentido: 'mayor' }
      },
      {
        keys: ['satisfaccion-ep', 'satisfacción-ep', 'satisfaccion ep', 'satisfacción ep'],
        label: /satisfac[ci][óo]n\\s*ep/i,
        type: 'porcentaje',
        umbrales: { verde: 95, amarillo: 85, rojo: 85, sentido: 'mayor' }
      },
      {
        keys: ['resolucion-snl', 'resolución-snl', 'resolucion snl', 'resolución snl'],
        label: /resoluci[óo]n\\s*snl/i,
        type: 'porcentaje',
        umbrales: { verde: 95, amarillo: 94, rojo: 80, sentido: 'mayor' }
      },
      {
        keys: ['resolucion-ep', 'resolución-ep', 'resolucion ep', 'resolución ep'],
        label: /resoluci[óo]n\\s*ep/i,
        type: 'porcentaje',
        umbrales: { verde: 95, amarillo: 94, rojo: 80, sentido: 'mayor' }
      },
      {
        keys: ['tmo', 'tiempo-medio-operacion', 'tiempo medio de operacion', 'tiempo medio de operación'],
        label: /tmo|tiempo\\s*medio\\s*de\\s*operaci[óo]n/i,
        type: 'minutos',
        umbrales: { verde: 3.00, amarillo: 5.00, rojo: 5.00, sentido: 'menor' }
      },
      {
        keys: ['transferencia-epa', 'transferencia a epa'],
        label: /transferencia\\s*a\\s*epa/i,
        type: 'porcentaje',
        umbrales: { verde: 85, amarillo: 70, rojo: 70, sentido: 'mayor' }
      },
      {
        keys: ['tipificaciones', 'tipificacion'],
        label: /tipificaci[óo]n|tipificaciones/i,
        type: 'porcentaje',
        umbrales: { verde: 95, amarillo: 94, rojo: 80, sentido: 'mayor' }
      }
    ];

    // Utilidades de parseo
    function parsePorcentaje(str) {
      if (!str) return null;
      let val = str.replace(',', '.').replace('%', '').trim();
      let num = parseFloat(val);
      return isNaN(num) ? null : num;
    }
    function parseMinutos(str) {
      if (!str) return null;
      str = str.replace(',', '.');
      if (/^[0-9]+([\\.,][0-9]+)?$/.test(str)) return parseFloat(str); // decimal
      let partes = str.split(':').map(s => parseFloat(s.replace(',', '.')));
      if (partes.length === 2) return partes[0] + (partes[1] / 60);
      if (partes.length === 3) return partes[0] * 60 + (partes[1]) + (partes[2] / 60);
      return null;
    }
    function normalizaTexto(txt) {
      return txt.normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase();
    }
    function getKpiType(el) {
      // Estrategia A: data-kpi
      let kpi = el.getAttribute('data-kpi');
      if (kpi) {
        kpi = normalizaTexto(kpi);
        for (const def of kpiMap) {
          if (def.keys.some(key => normalizaTexto(key) === kpi)) return def;
        }
      }
      // Estrategia B: clase
      for (const def of kpiMap) {
        if (def.keys.some(key => el.classList.contains('kpi--' + key))) return def;
      }
      // Estrategia C: label cercano
      let label = '';
      let labelEl = el.querySelector('.kpi__label');
      if (labelEl) label = labelEl.textContent || '';
      else label = el.textContent || '';
      label = normalizaTexto(label);
      for (const def of kpiMap) {
        if (def.keys.some(key => label.includes(normalizaTexto(key)))) return def;
        if (def.label && def.label.test(label)) return def;
      }
      return null;
    }
    function getValorKpi(el, tipo) {
      // data-kpi-value
      let valEl = el.querySelector('[data-kpi-value]') || el.querySelector('.kpi__valor') || el;
      let raw = valEl.textContent || '';
      if (tipo === 'porcentaje') return parsePorcentaje(raw);
      if (tipo === 'minutos') return parseMinutos(raw);
      return null;
    }
    function getEstadoKpi(valor, def) {
      if (valor === null || valor === undefined || isNaN(valor)) return { estado: 'gris', texto: '', emoji: '' };
      if (def.type === 'porcentaje') {
        if (valor >= def.umbrales.verde) return { estado: 'verde', texto: 'Verde', emoji: '🟢' };
        if (valor >= def.umbrales.amarillo) return { estado: 'amarillo', texto: 'Amarillo', emoji: '🟡' };
        return { estado: 'rojo', texto: 'Rojo', emoji: '🔴' };
      }
      if (def.type === 'minutos') {
        if (valor <= def.umbrales.verde) return { estado: 'verde', texto: 'Verde', emoji: '🟢' };
        if (valor <= def.umbrales.amarillo) return { estado: 'amarillo', texto: 'Amarillo', emoji: '🟡' };
        return { estado: 'rojo', texto: 'Rojo', emoji: '🔴' };
      }
      return { estado: 'gris', texto: 'Sin dato', emoji: '⚪' };
    }

    // 1. Buscar todos los posibles contenedores KPI
    let kpiEls = Array.from(document.querySelectorAll('.kpi, [data-kpi]'));
    // Eliminar duplicados
    kpiEls = kpiEls.filter((el, i, arr) => arr.indexOf(el) === i);

    kpiEls.forEach(el => {
      // 2. Inferir tipo de KPI
      const def = getKpiType(el);
      // 3. Extraer valor
      const valor = def ? getValorKpi(el, def.type) : null;
      // 4. Evaluar estado
      const estado = def ? getEstadoKpi(valor, def) : { estado: 'gris', texto: 'Sin dato', emoji: '⚪' };
      // 5. Limpiar clases previas de estado
      el.classList.remove('kpi--verde', 'kpi--amarillo', 'kpi--rojo', 'kpi--gris');
      el.classList.add('kpi--' + estado.estado);
      // 6. Insertar/actualizar badge de estado (solo si hay texto)
      let chip = el.querySelector('.kpi__estado');
      if (estado.texto) {
        if (!chip) {
          chip = document.createElement('span');
          chip.className = 'kpi__estado';
          el.appendChild(chip);
        }
        chip.textContent = estado.emoji ? (estado.emoji + ' ' + estado.texto) : estado.texto;
        chip.setAttribute('aria-label', 'Estado: ' + estado.texto);
        chip.setAttribute('title', 'Estado: ' + estado.texto);
      } else {
        if (chip) chip.remove();
      }
    });
  })();
</script>
<style>
  :root {
    --kpi-verde: #1E7F4F;
    --kpi-amarillo: #C79200;
    --kpi-rojo: #B00020;
    --kpi-gris: #6B7280;
  }

  .kpi {
    display: inline-flex;
    align-items: center;
    gap: 0.5em;
    margin: 0.2em 0.5em 0.2em 0;
    border-radius: 0.5em;
    padding: 0.2em 0.6em 0.2em 0.4em;
  }

  .kpi__valor {
    font-weight: bold;
    margin-left: 0.2em;
  }

  .kpi__estado {
    display: inline-block;
    margin-left: 0.5em;
    padding: 0.1em 0.7em;
    border-radius: 1em;
    font-size: 0.95em;
    font-weight: 600;
    letter-spacing: 0.01em;
    color: #fff;
    vertical-align: middle;
    min-width: 4.5em;
    text-align: center;
  }

  .kpi--verde {
    background: rgba(30, 127, 79, 0.08);
  }

  .kpi--amarillo {
    background: rgba(199, 146, 0, 0.08);
  }

  .kpi--rojo {
    background: rgba(176, 0, 32, 0.08);
  }

  .kpi--gris {
    background: rgba(107, 114, 128, 0.08);
  }

  .kpi--verde .kpi__estado {
    background: var(--kpi-verde);
  }

  .kpi--amarillo .kpi__estado {
    background: var(--kpi-amarillo);
  }

  .kpi--rojo .kpi__estado {
    background: var(--kpi-rojo);
  }

  .kpi--gris .kpi__estado {
    background: var(--kpi-gris);
  }
</style>
<script>
  (function () {
    // Configuración de umbrales y mapeo de KPI
    const kpiMap = [
      {
        keys: ['satisfaccion-snl', 'satisfacción-snl', 'satisfaccion snl', 'satisfacción snl'],
        label: /satisfac[ci][óo]n\\s*snl/i,
        type: 'porcentaje',
        umbrales: { verde: 95, amarillo: 85, rojo: 85, sentido: 'mayor' }
      },
      {
        keys: ['satisfaccion-ep', 'satisfacción-ep', 'satisfaccion ep', 'satisfacción ep'],
        label: /satisfac[ci][óo]n\\s*ep/i,
        type: 'porcentaje',
        umbrales: { verde: 95, amarillo: 85, rojo: 85, sentido: 'mayor' }
      },
      {
        keys: ['resolucion-snl', 'resolución-snl', 'resolucion snl', 'resolución snl'],
        label: /resoluci[óo]n\\s*snl/i,
        type: 'porcentaje',
        umbrales: { verde: 95, amarillo: 94, rojo: 80, sentido: 'mayor' }
      },
      {
        keys: ['resolucion-ep', 'resolución-ep', 'resolucion ep', 'resolución ep'],
        label: /resoluci[óo]n\\s*ep/i,
        type: 'porcentaje',
        umbrales: { verde: 95, amarillo: 94, rojo: 80, sentido: 'mayor' }
      },
      {
        keys: ['tmo', 'tiempo-medio-operacion', 'tiempo medio de operacion', 'tiempo medio de operación'],
        label: /tmo|tiempo\\s*medio\\s*de\\s*operaci[óo]n/i,
        type: 'minutos',
        umbrales: { verde: 3.00, amarillo: 5.00, rojo: 5.00, sentido: 'menor' }
      },
      {
        keys: ['transferencia-epa', 'transferencia a epa'],
        label: /transferencia\\s*a\\s*epa/i,
        type: 'porcentaje',
        umbrales: { verde: 85, amarillo: 70, rojo: 70, sentido: 'mayor' }
      },
      {
        keys: ['tipificaciones', 'tipificacion'],
        label: /tipificaci[óo]n|tipificaciones/i,
        type: 'porcentaje',
        umbrales: { verde: 95, amarillo: 94, rojo: 80, sentido: 'mayor' }
      }
    ];

    // Utilidades de parseo
    function parsePorcentaje(str) {
      if (!str) return null;
      let val = str.replace(',', '.').replace('%', '').trim();
      let num = parseFloat(val);
      return isNaN(num) ? null : num;
    }
    function parseMinutos(str) {
      if (!str) return null;
      str = str.replace(',', '.');
      if (/^[0-9]+([\\.,][0-9]+)?$/.test(str)) return parseFloat(str); // decimal
      let partes = str.split(':').map(s => parseFloat(s.replace(',', '.')));
      if (partes.length === 2) return partes[0] + (partes[1] / 60);
      if (partes.length === 3) return partes[0] * 60 + (partes[1]) + (partes[2] / 60);
      return null;
    }
    function normalizaTexto(txt) {
      return txt.normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase();
    }
    function getKpiType(el) {
      // Estrategia A: data-kpi
      let kpi = el.getAttribute('data-kpi');
      if (kpi) {
        kpi = normalizaTexto(kpi);
        for (const def of kpiMap) {
          if (def.keys.some(key => normalizaTexto(key) === kpi)) return def;
        }
      }
      // Estrategia B: clase
      for (const def of kpiMap) {
        if (def.keys.some(key => el.classList.contains('kpi--' + key))) return def;
      }
      // Estrategia C: label cercano
      let label = '';
      let labelEl = el.querySelector('.kpi__label');
      if (labelEl) label = labelEl.textContent || '';
      else label = el.textContent || '';
      label = normalizaTexto(label);
      for (const def of kpiMap) {
        if (def.keys.some(key => label.includes(normalizaTexto(key)))) return def;
        if (def.label && def.label.test(label)) return def;
      }
      return null;
    }
    function getValorKpi(el, tipo) {
      // data-kpi-value
      let valEl = el.querySelector('[data-kpi-value]') || el.querySelector('.kpi__valor') || el;
      let raw = valEl.textContent || '';
      if (tipo === 'porcentaje') return parsePorcentaje(raw);
      if (tipo === 'minutos') return parseMinutos(raw);
      return null;
    }
    function getEstadoKpi(valor, def) {
      if (valor === null || valor === undefined || isNaN(valor)) return { estado: 'gris', texto: 'Sin dato', emoji: '⚪' };
      if (def.type === 'porcentaje') {
        if (valor >= def.umbrales.verde) return { estado: 'verde', texto: 'Verde', emoji: '🟢' };
        if (valor >= def.umbrales.amarillo) return { estado: 'amarillo', texto: 'Amarillo', emoji: '🟡' };
        return { estado: 'rojo', texto: 'Rojo', emoji: '🔴' };
      }
      if (def.type === 'minutos') {
        if (valor <= def.umbrales.verde) return { estado: 'verde', texto: 'Verde', emoji: '🟢' };
        if (valor <= def.umbrales.amarillo) return { estado: 'amarillo', texto: 'Amarillo', emoji: '🟡' };
        return { estado: 'rojo', texto: 'Rojo', emoji: '🔴' };
      }
      return { estado: 'gris', texto: 'Sin dato', emoji: '⚪' };
    }

    // 1. Buscar todos los posibles contenedores KPI
    let kpiEls = Array.from(document.querySelectorAll('.kpi, [data-kpi]'));
    // Eliminar duplicados
    kpiEls = kpiEls.filter((el, i, arr) => arr.indexOf(el) === i);

    kpiEls.forEach(el => {
      // 2. Inferir tipo de KPI
      const def = getKpiType(el);
      // 3. Extraer valor
      const valor = def ? getValorKpi(el, def.type) : null;
      // 4. Evaluar estado
      const estado = def ? getEstadoKpi(valor, def) : { estado: 'gris', texto: 'Sin dato', emoji: '⚪' };
      // 5. Limpiar clases previas de estado
      el.classList.remove('kpi--verde', 'kpi--amarillo', 'kpi--rojo', 'kpi--gris');
      el.classList.add('kpi--' + estado.estado);
      // 6. Insertar/actualizar badget de estado
      let chip = el.querySelector('.kpi__estado');
      if (!chip) {
        chip = document.createElement('span');
        chip.className = 'kpi__estado';
        el.appendChild(chip);
      }
      chip.textContent = estado.texto;
      chip.setAttribute('aria-label', 'Estado: ' + estado.texto);
      chip.setAttribute('title', 'Estado: ' + estado.texto);
      chip.innerText = estado.emoji + ' ' + estado.texto;
    });
  })();
</script>
<style>
  :root {
    --kpi-verde: #1E7F4F;
    --kpi-amarillo: #C79200;
    --kpi-rojo: #B00020;
    --kpi-gris: #6B7280;
  }

  .kpi {
    display: inline-flex;
    align-items: center;
    gap: 0.5em;
    margin: 0.2em 0.5em 0.2em 0;
    border-radius: 0.5em;
    padding: 0.2em 0.6em 0.2em 0.4em;
  }

  .kpi__valor {
    font-weight: bold;
    margin-left: 0.2em;
  }

  .kpi__estado {
    display: inline-block;
    margin-left: 0.5em;
    padding: 0.1em 0.7em;
    border-radius: 1em;
    font-size: 0.95em;
    font-weight: 600;
    letter-spacing: 0.01em;
    color: #fff;
    vertical-align: middle;
    min-width: 4.5em;
    text-align: center;
  }

  .kpi--verde {
    background: rgba(30, 127, 79, 0.08);
  }

  .kpi--amarillo {
    background: rgba(199, 146, 0, 0.08);
  }

  .kpi--rojo {
    background: rgba(176, 0, 32, 0.08);
  }

  .kpi--gris {
    background: rgba(107, 114, 128, 0.08);
  }

  .kpi--verde .kpi__estado {
    background: var(--kpi-verde);
  }

  .kpi--amarillo .kpi__estado {
    background: var(--kpi-amarillo);
  }

  .kpi--rojo .kpi__estado {
    background: var(--kpi-rojo);
  }

  .kpi--gris .kpi__estado {
    background: var(--kpi-gris);
  }
</style>
<script>
  (function () {
    // Configuración de umbrales y mapeo de KPI
    const kpiMap = [
      {
        keys: ['satisfaccion-snl', 'satisfacción-snl', 'satisfaccion snl', 'satisfacción snl'],
        label: /satisfac[ci][óo]n\\s*snl/i,
        type: 'porcentaje',
        umbrales: { verde: 95, amarillo: 85, rojo: 85, sentido: 'mayor' }
      },
      {
        keys: ['satisfaccion-ep', 'satisfacción-ep', 'satisfaccion ep', 'satisfacción ep'],
        label: /satisfac[ci][óo]n\\s*ep/i,
        type: 'porcentaje',
        umbrales: { verde: 95, amarillo: 85, rojo: 85, sentido: 'mayor' }
      },
      {
        keys: ['resolucion-snl', 'resolución-snl', 'resolucion snl', 'resolución snl'],
        label: /resoluci[óo]n\\s*snl/i,
        type: 'porcentaje',
        umbrales: { verde: 95, amarillo: 94, rojo: 80, sentido: 'mayor' }
      },
      {
        keys: ['resolucion-ep', 'resolución-ep', 'resolucion ep', 'resolución ep'],
        label: /resoluci[óo]n\\s*ep/i,
        type: 'porcentaje',
        umbrales: { verde: 95, amarillo: 94, rojo: 80, sentido: 'mayor' }
      },
      {
        keys: ['tmo', 'tiempo-medio-operacion', 'tiempo medio de operacion', 'tiempo medio de operación'],
        label: /tmo|tiempo\\s*medio\\s*de\\s*operaci[óo]n/i,
        type: 'minutos',
        umbrales: { verde: 3.00, amarillo: 5.00, rojo: 5.00, sentido: 'menor' }
      },
      {
        keys: ['transferencia-epa', 'transferencia a epa'],
        label: /transferencia\\s*a\\s*epa/i,
        type: 'porcentaje',
        umbrales: { verde: 85, amarillo: 70, rojo: 70, sentido: 'mayor' }
      },
      {
        keys: ['tipificaciones', 'tipificacion'],
        label: /tipificaci[óo]n|tipificaciones/i,
        type: 'porcentaje',
        umbrales: { verde: 95, amarillo: 94, rojo: 80, sentido: 'mayor' }
      }
    ];

    // Utilidades de parseo
    function parsePorcentaje(str) {
      if (!str) return null;
      let val = str.replace(',', '.').replace('%', '').trim();
      let num = parseFloat(val);
      return isNaN(num) ? null : num;
    }
    function parseMinutos(str) {
      if (!str) return null;
      str = str.replace(',', '.');
      if (/^[0-9]+([\\.,][0-9]+)?$/.test(str)) return parseFloat(str); // decimal
      let partes = str.split(':').map(s => parseFloat(s.replace(',', '.')));
      if (partes.length === 2) return partes[0] + (partes[1] / 60);
      if (partes.length === 3) return partes[0] * 60 + (partes[1]) + (partes[2] / 60);
      return null;
    }
    function normalizaTexto(txt) {
      return txt.normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase();
    }
    function getKpiType(el) {
      // Estrategia A: data-kpi
      let kpi = el.getAttribute('data-kpi');
      if (kpi) {
        kpi = normalizaTexto(kpi);
        for (const def of kpiMap) {
          if (def.keys.some(key => normalizaTexto(key) === kpi)) return def;
        }
      }
      // Estrategia B: clase
      for (const def of kpiMap) {
        if (def.keys.some(key => el.classList.contains('kpi--' + key))) return def;
      }
      // Estrategia C: label cercano
      let label = '';
      let labelEl = el.querySelector('.kpi__label');
      if (labelEl) label = labelEl.textContent || '';
      else label = el.textContent || '';
      label = normalizaTexto(label);
      for (const def of kpiMap) {
        if (def.keys.some(key => label.includes(normalizaTexto(key)))) return def;
        if (def.label && def.label.test(label)) return def;
      }
      return null;
    }
    function getValorKpi(el, tipo) {
      // data-kpi-value
      let valEl = el.querySelector('[data-kpi-value]') || el.querySelector('.kpi__valor') || el;
      let raw = valEl.textContent || '';
      if (tipo === 'porcentaje') return parsePorcentaje(raw);
      if (tipo === 'minutos') return parseMinutos(raw);
      return null;
    }
    function getEstadoKpi(valor, def) {
      if (valor === null || valor === undefined || isNaN(valor)) return { estado: 'gris', texto: 'Sin dato', emoji: '⚪' };
      if (def.type === 'porcentaje') {
        if (valor >= def.umbrales.verde) return { estado: 'verde', texto: 'Verde', emoji: '🟢' };
        if (valor >= def.umbrales.amarillo) return { estado: 'amarillo', texto: 'Amarillo', emoji: '🟡' };
        return { estado: 'rojo', texto: 'Rojo', emoji: '🔴' };
      }
      if (def.type === 'minutos') {
        if (valor <= def.umbrales.verde) return { estado: 'verde', texto: 'Verde', emoji: '🟢' };
        if (valor <= def.umbrales.amarillo) return { estado: 'amarillo', texto: 'Amarillo', emoji: '🟡' };
        return { estado: 'rojo', texto: 'Rojo', emoji: '🔴' };
      }
      return { estado: 'gris', texto: 'Sin dato', emoji: '⚪' };
    }

    // 1. Buscar todos los posibles contenedores KPI
    let kpiEls = Array.from(document.querySelectorAll('.kpi, [data-kpi]'));
    // Eliminar duplicados
    kpiEls = kpiEls.filter((el, i, arr) => arr.indexOf(el) === i);

    kpiEls.forEach(el => {
      // 2. Inferir tipo de KPI
      const def = getKpiType(el);
      // 3. Extraer valor
      const valor = def ? getValorKpi(el, def.type) : null;
      // 4. Evaluar estado
      const estado = def ? getEstadoKpi(valor, def) : { estado: 'gris', texto: 'Sin dato', emoji: '⚪' };
      // 5. Limpiar clases previas de estado
      el.classList.remove('kpi--verde', 'kpi--amarillo', 'kpi--rojo', 'kpi--gris');
      el.classList.add('kpi--' + estado.estado);
      // 6. Insertar/actualizar badget de estado
      let chip = el.querySelector('.kpi__estado');
      if (!chip) {
        chip = document.createElement('span');
        chip.className = 'kpi__estado';
        el.appendChild(chip);
      }
      chip.textContent = estado.texto;
      chip.setAttribute('aria-label', 'Estado: ' + estado.texto);
      chip.setAttribute('title', 'Estado: ' + estado.texto);
      chip.innerText = estado.emoji + ' ' + estado.texto;
    });
  })();
</script>
<style>
  :root {
    --kpi-verde: #1E7F4F;
    --kpi-amarillo: #C79200;
    --kpi-rojo: #B00020;
    --kpi-gris: #6B7280;
  }

  .kpi {
    display: inline-flex;
    align-items: center;
    gap: 0.5em;
    margin: 0.2em 0.5em 0.2em 0;
    border-radius: 0.5em;
    padding: 0.2em 0.6em 0.2em 0.4em;
  }

  .kpi__valor {
    font-weight: bold;
    margin-left: 0.2em;
  }

  .kpi__estado {
    display: inline-block;
    margin-left: 0.5em;
    padding: 0.1em 0.7em;
    border-radius: 1em;
    font-size: 0.95em;
    font-weight: 600;
    letter-spacing: 0.01em;
    color: #fff;
    vertical-align: middle;
    min-width: 4.5em;
    text-align: center;
  }

  .kpi--verde {
    background: rgba(30, 127, 79, 0.08);
  }

  .kpi--amarillo {
    background: rgba(199, 146, 0, 0.08);
  }

  .kpi--rojo {
    background: rgba(176, 0, 32, 0.08);
  }

  .kpi--gris {
    background: rgba(107, 114, 128, 0.08);
  }

  .kpi--verde .kpi__estado {
    background: var(--kpi-verde);
  }

  .kpi--amarillo .kpi__estado {
    background: var(--kpi-amarillo);
  }

  .kpi--rojo .kpi__estado {
    background: var(--kpi-rojo);
  }

  .kpi--gris .kpi__estado {
    background: var(--kpi-gris);
  }
</style>
<script>
  (function () {
    // Configuración de umbrales y mapeo de KPI
    const kpiMap = [
      {
        keys: ['satisfaccion-snl', 'satisfacción-snl', 'satisfaccion snl', 'satisfacción snl'],
        label: /satisfac[ci][óo]n\\s*snl/i,
        type: 'porcentaje',
        umbrales: { verde: 95, amarillo: 85, rojo: 85, sentido: 'mayor' }
      },
      {
        keys: ['satisfaccion-ep', 'satisfacción-ep', 'satisfaccion ep', 'satisfacción ep'],
        label: /satisfac[ci][óo]n\\s*ep/i,
        type: 'porcentaje',
        umbrales: { verde: 95, amarillo: 85, rojo: 85, sentido: 'mayor' }
      },
      {
        keys: ['resolucion-snl', 'resolución-snl', 'resolucion snl', 'resolución snl'],
        label: /resoluci[óo]n\\s*snl/i,
        type: 'porcentaje',
        umbrales: { verde: 95, amarillo: 94, rojo: 80, sentido: 'mayor' }
      },
      {
        keys: ['resolucion-ep', 'resolución-ep', 'resolucion ep', 'resolución ep'],
        label: /resoluci[óo]n\\s*ep/i,
        type: 'porcentaje',
        umbrales: { verde: 95, amarillo: 94, rojo: 80, sentido: 'mayor' }
      },
      {
        keys: ['tmo', 'tiempo-medio-operacion', 'tiempo medio de operacion', 'tiempo medio de operación'],
        label: /tmo|tiempo\\s*medio\\s*de\\s*operaci[óo]n/i,
        type: 'minutos',
        umbrales: { verde: 3.00, amarillo: 5.00, rojo: 5.00, sentido: 'menor' }
      },
      {
        keys: ['transferencia-epa', 'transferencia a epa'],
        label: /transferencia\\s*a\\s*epa/i,
        type: 'porcentaje',
        umbrales: { verde: 85, amarillo: 70, rojo: 70, sentido: 'mayor' }
      },
      {
        keys: ['tipificaciones', 'tipificacion'],
        label: /tipificaci[óo]n|tipificaciones/i,
        type: 'porcentaje',
        umbrales: { verde: 95, amarillo: 94, rojo: 80, sentido: 'mayor' }
      }
    ];

    // Utilidades de parseo
    function parsePorcentaje(str) {
      if (!str) return null;
      let val = str.replace(',', '.').replace('%', '').trim();
      let num = parseFloat(val);
      return isNaN(num) ? null : num;
    }
    function parseMinutos(str) {
      if (!str) return null;
      str = str.replace(',', '.');
      if (/^[0-9]+([\\.,][0-9]+)?$/.test(str)) return parseFloat(str); // decimal
      let partes = str.split(':').map(s => parseFloat(s.replace(',', '.')));
      if (partes.length === 2) return partes[0] + (partes[1] / 60);
      if (partes.length === 3) return partes[0] * 60 + (partes[1]) + (partes[2] / 60);
      return null;
    }
    function normalizaTexto(txt) {
      return txt.normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase();
    }
    function getKpiType(el) {
      // Estrategia A: data-kpi
      let kpi = el.getAttribute('data-kpi');
      if (kpi) {
        kpi = normalizaTexto(kpi);
        for (const def of kpiMap) {
          if (def.keys.some(key => normalizaTexto(key) === kpi)) return def;
        }
      }
      // Estrategia B: clase
      for (const def of kpiMap) {
        if (def.keys.some(key => el.classList.contains('kpi--' + key))) return def;
      }
      // Estrategia C: label cercano
      let label = '';
      let labelEl = el.querySelector('.kpi__label');
      if (labelEl) label = labelEl.textContent || '';
      else label = el.textContent || '';
      label = normalizaTexto(label);
      for (const def of kpiMap) {
        if (def.keys.some(key => label.includes(normalizaTexto(key)))) return def;
        if (def.label && def.label.test(label)) return def;
      }
      return null;
    }
    function getValorKpi(el, tipo) {
      // data-kpi-value
      let valEl = el.querySelector('[data-kpi-value]') || el.querySelector('.kpi__valor') || el;
      let raw = valEl.textContent || '';
      if (tipo === 'porcentaje') return parsePorcentaje(raw);
      if (tipo === 'minutos') return parseMinutos(raw);
      return null;
    }
    function getEstadoKpi(valor, def) {
      if (valor === null || valor === undefined || isNaN(valor)) return { estado: 'gris', texto: 'Sin dato', emoji: '⚪' };
      if (def.type === 'porcentaje') {
        if (valor >= def.umbrales.verde) return { estado: 'verde', texto: 'Verde', emoji: '🟢' };
        if (valor >= def.umbrales.amarillo) return { estado: 'amarillo', texto: 'Amarillo', emoji: '🟡' };
        return { estado: 'rojo', texto: 'Rojo', emoji: '🔴' };
      }
      if (def.type === 'minutos') {
        if (valor <= def.umbrales.verde) return { estado: 'verde', texto: 'Verde', emoji: '🟢' };
        if (valor <= def.umbrales.amarillo) return { estado: 'amarillo', texto: 'Amarillo', emoji: '🟡' };
        return { estado: 'rojo', texto: 'Rojo', emoji: '🔴' };
      }
      return { estado: 'gris', texto: 'Sin dato', emoji: '⚪' };
    }

    // 1. Buscar todos los posibles contenedores KPI
    let kpiEls = Array.from(document.querySelectorAll('.kpi, [data-kpi]'));
    // Eliminar duplicados
    kpiEls = kpiEls.filter((el, i, arr) => arr.indexOf(el) === i);

    kpiEls.forEach(el => {
      // 2. Inferir tipo de KPI
      const def = getKpiType(el);
      // 3. Extraer valor
      const valor = def ? getValorKpi(el, def.type) : null;
      // 4. Evaluar estado
      const estado = def ? getEstadoKpi(valor, def) : { estado: 'gris', texto: 'Sin dato', emoji: '⚪' };
      // 5. Limpiar clases previas de estado
      el.classList.remove('kpi--verde', 'kpi--amarillo', 'kpi--rojo', 'kpi--gris');
      el.classList.add('kpi--' + estado.estado);
      // 6. Insertar/actualizar badget de estado
      let chip = el.querySelector('.kpi__estado');
      if (!chip) {
        chip = document.createElement('span');
        chip.className = 'kpi__estado';
        el.appendChild(chip);
      }
      chip.textContent = estado.texto;
      chip.setAttribute('aria-label', 'Estado: ' + estado.texto);
      chip.setAttribute('title', 'Estado: ' + estado.texto);
      chip.innerText = estado.emoji + ' ' + estado.texto;
    });
  })();
</script>
<style>
  :root {
    --kpi-verde: #1E7F4F;
    --kpi-amarillo: #C79200;
    --kpi-rojo: #B00020;
    --kpi-gris: #6B7280;
  }

  .kpi {
    display: inline-flex;
    align-items: center;
    gap: 0.5em;
    margin: 0.2em 0.5em 0.2em 0;
    border-radius: 0.5em;
    padding: 0.2em 0.6em 0.2em 0.4em;
  }

  .kpi__valor {
    font-weight: bold;
    margin-left: 0.2em;
  }

  .kpi__estado {
    display: inline-block;
    margin-left: 0.5em;
    padding: 0.1em 0.7em;
    border-radius: 1em;
    font-size: 0.95em;
    font-weight: 600;
    letter-spacing: 0.01em;
    color: #fff;
    vertical-align: middle;
    min-width: 4.5em;
    text-align: center;
  }

  .kpi--verde {
    background: rgba(30, 127, 79, 0.08);
  }

  .kpi--amarillo {
    background: rgba(199, 146, 0, 0.08);
  }

  .kpi--rojo {
    background: rgba(176, 0, 32, 0.08);
  }

  .kpi--gris {
    background: rgba(107, 114, 128, 0.08);
  }

  .kpi--verde .kpi__estado {
    background: var(--kpi-verde);
  }

  .kpi--amarillo .kpi__estado {
    background: var(--kpi-amarillo);
  }

  .kpi--rojo .kpi__estado {
    background: var(--kpi-rojo);
  }

  .kpi--gris .kpi__estado {
    background: var(--kpi-gris);
  }
</style>
<script>
  (function () {
    // Configuración de umbrales y mapeo de KPI
    const kpiMap = [
      {
        keys: ['satisfaccion-snl', 'satisfacción-snl', 'satisfaccion snl', 'satisfacción snl'],
        label: /satisfac[ci][óo]n\\s*snl/i,
        type: 'porcentaje',
        umbrales: { verde: 95, amarillo: 85, rojo: 85, sentido: 'mayor' }
      },
      {
        keys: ['satisfaccion-ep', 'satisfacción-ep', 'satisfaccion ep', 'satisfacción ep'],
        label: /satisfac[ci][óo]n\\s*ep/i,
        type: 'porcentaje',
        umbrales: { verde: 95, amarillo: 85, rojo: 85, sentido: 'mayor' }
      },
      {
        keys: ['resolucion-snl', 'resolución-snl', 'resolucion snl', 'resolución snl'],
        label: /resoluci[óo]n\\s*snl/i,
        type: 'porcentaje',
        umbrales: { verde: 95, amarillo: 94, rojo: 80, sentido: 'mayor' }
      },
      {
        keys: ['resolucion-ep', 'resolución-ep', 'resolucion ep', 'resolución ep'],
        label: /resoluci[óo]n\\s*ep/i,
        type: 'porcentaje',
        umbrales: { verde: 95, amarillo: 94, rojo: 80, sentido: 'mayor' }
      },
      {
        keys: ['tmo', 'tiempo-medio-operacion', 'tiempo medio de operacion', 'tiempo medio de operación'],
        label: /tmo|tiempo\\s*medio\\s*de\\s*operaci[óo]n/i,
        type: 'minutos',
        umbrales: { verde: 3.00, amarillo: 5.00, rojo: 5.00, sentido: 'menor' }
      },
      {
        keys: ['transferencia-epa', 'transferencia a epa'],
        label: /transferencia\\s*a\\s*epa/i,
        type: 'porcentaje',
        umbrales: { verde: 85, amarillo: 70, rojo: 70, sentido: 'mayor' }
      },
      {
        keys: ['tipificaciones', 'tipificacion'],
        label: /tipificaci[óo]n|tipificaciones/i,
        type: 'porcentaje',
        umbrales: { verde: 95, amarillo: 94, rojo: 80, sentido: 'mayor' }
      }
    ];

    // Utilidades de parseo
    function parsePorcentaje(str) {
      if (!str) return null;
      let val = str.replace(',', '.').replace('%', '').trim();
      let num = parseFloat(val);
      return isNaN(num) ? null : num;
    }
    function parseMinutos(str) {
      if (!str) return null;
      str = str.replace(',', '.');
      if (/^[0-9]+([\\.,][0-9]+)?$/.test(str)) return parseFloat(str); // decimal
      let partes = str.split(':').map(s => parseFloat(s.replace(',', '.')));
      if (partes.length === 2) return partes[0] + (partes[1] / 60);
      if (partes.length === 3) return partes[0] * 60 + (partes[1]) + (partes[2] / 60);
      return null;
    }
    function normalizaTexto(txt) {
      return txt.normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase();
    }
    function getKpiType(el) {
      // Estrategia A: data-kpi
      let kpi = el.getAttribute('data-kpi');
      if (kpi) {
        kpi = normalizaTexto(kpi);
        for (const def of kpiMap) {
          if (def.keys.some(key => normalizaTexto(key) === kpi)) return def;
        }
      }
      // Estrategia B: clase
      for (const def of kpiMap) {
        if (def.keys.some(key => el.classList.contains('kpi--' + key))) return def;
      }
      // Estrategia C: label cercano
      let label = '';
      let labelEl = el.querySelector('.kpi__label');
      if (labelEl) label = labelEl.textContent || '';
      else label = el.textContent || '';
      label = normalizaTexto(label);
      for (const def of kpiMap) {
        if (def.keys.some(key => label.includes(normalizaTexto(key)))) return def;
        if (def.label && def.label.test(label)) return def;
      }
      return null;
    }
    function getValorKpi(el, tipo) {
      // data-kpi-value
      let valEl = el.querySelector('[data-kpi-value]') || el.querySelector('.kpi__valor') || el;
      let raw = valEl.textContent || '';
      if (tipo === 'porcentaje') return parsePorcentaje(raw);
      if (tipo === 'minutos') return parseMinutos(raw);
      return null;
    }
    function getEstadoKpi(valor, def) {
      if (valor === null || valor === undefined || isNaN(valor)) return { estado: 'gris', texto: 'Sin dato', emoji: '⚪' };
      if (def.type === 'porcentaje') {
        if (valor >= def.umbrales.verde) return { estado: 'verde', texto: 'Verde', emoji: '🟢' };
        if (valor >= def.umbrales.amarillo) return { estado: 'amarillo', texto: 'Amarillo', emoji: '🟡' };
        return { estado: 'rojo', texto: 'Rojo', emoji: '🔴' };
      }
      if (def.type === 'minutos') {
        if (valor <= def.umbrales.verde) return { estado: 'verde', texto: 'Verde', emoji: '🟢' };
        if (valor <= def.umbrales.amarillo) return { estado: 'amarillo', texto: 'Amarillo', emoji: '🟡' };
        return { estado: 'rojo', texto: 'Rojo', emoji: '🔴' };
      }
      return { estado: 'gris', texto: 'Sin dato', emoji: '⚪' };
    }

    // 1. Buscar todos los posibles contenedores KPI
    let kpiEls = Array.from(document.querySelectorAll('.kpi, [data-kpi]'));
    // Eliminar duplicados
    kpiEls = kpiEls.filter((el, i, arr) => arr.indexOf(el) === i);

    kpiEls.forEach(el => {
      // 2. Inferir tipo de KPI
      const def = getKpiType(el);
      // 3. Extraer valor
      const valor = def ? getValorKpi(el, def.type) : null;
      // 4. Evaluar estado
      const estado = def ? getEstadoKpi(valor, def) : { estado: 'gris', texto: 'Sin dato', emoji: '⚪' };
      // 5. Limpiar clases previas de estado
      el.classList.remove('kpi--verde', 'kpi--amarillo', 'kpi--rojo', 'kpi--gris');
      el.classList.add('kpi--' + estado.estado);
      // 6. Insertar/actualizar badget de estado
      let chip = el.querySelector('.kpi__estado');
      if (!chip) {
        chip = document.createElement('span');
        chip.className = 'kpi__estado';
        el.appendChild(chip);
      }
      chip.textContent = estado.texto;
      chip.setAttribute('aria-label', 'Estado: ' + estado.texto);
      chip.setAttribute('title', 'Estado: ' + estado.texto);
      chip.innerText = estado.emoji + ' ' + estado.texto;
    });
  })();
</script>
<style>
  :root {
    --kpi-verde: #1E7F4F;
    --kpi-amarillo: #C79200;
    --kpi-rojo: #B00020;
    --kpi-gris: #6B7280;
  }

  .kpi {
    display: inline-flex;
    align-items: center;
    gap: 0.5em;
    margin: 0.2em 0.5em 0.2em 0;
    border-radius: 0.5em;
    padding: 0.2em 0.6em 0.2em 0.4em;
  }

  .kpi__valor {
    font-weight: bold;
    margin-left: 0.2em;
  }

  .kpi__estado {
    display: inline-block;
    margin-left: 0.5em;
    padding: 0.1em 0.7em;
    border-radius: 1em;
    font-size: 0.95em;
    font-weight: 600;
    letter-spacing: 0.01em;
    color: #fff;
    vertical-align: middle;
    min-width: 4.5em;
    text-align: center;
  }

  .kpi--verde {
    background: rgba(30, 127, 79, 0.08);
  }

  .kpi--amarillo {
    background: rgba(199, 146, 0, 0.08);
  }

  .kpi--rojo {
    background: rgba(176, 0, 32, 0.08);
  }

  .kpi--gris {
    background: rgba(107, 114, 128, 0.08);
  }

  .kpi--verde .kpi__estado {
    background: var(--kpi-verde);
  }

  .kpi--amarillo .kpi__estado {
    background: var(--kpi-amarillo);
  }

  .kpi--rojo .kpi__estado {
    background: var(--kpi-rojo);
  }

  .kpi--gris .kpi__estado {
    background: var(--kpi-gris);
  }
</style>
<script>
  (function () {
    // Configuración de umbrales y mapeo de KPI
    const kpiMap = [
      {
        keys: ['satisfaccion-snl', 'satisfacción-snl', 'satisfaccion snl', 'satisfacción snl'],
        label: /satisfac[ci][óo]n\\s*snl/i,
        type: 'porcentaje',
        umbrales: { verde: 95, amarillo: 85, rojo: 85, sentido: 'mayor' }
      },
      {
        keys: ['satisfaccion-ep', 'satisfacción-ep', 'satisfaccion ep', 'satisfacción ep'],
        label: /satisfac[ci][óo]n\\s*ep/i,
        type: 'porcentaje',
        umbrales: { verde: 95, amarillo: 85, rojo: 85, sentido: 'mayor' }
      },
      {
        keys: ['resolucion-snl', 'resolución-snl', 'resolucion snl', 'resolución snl'],
        label: /resoluci[óo]n\\s*snl/i,
        type: 'porcentaje',
        umbrales: { verde: 95, amarillo: 94, rojo: 80, sentido: 'mayor' }
      },
      {
        keys: ['resolucion-ep', 'resolución-ep', 'resolucion ep', 'resolución ep'],
        label: /resoluci[óo]n\\s*ep/i,
        type: 'porcentaje',
        umbrales: { verde: 95, amarillo: 94, rojo: 80, sentido: 'mayor' }
      },
      {
        keys: ['tmo', 'tiempo-medio-operacion', 'tiempo medio de operacion', 'tiempo medio de operación'],
        label: /tmo|tiempo\\s*medio\\s*de\\s*operaci[óo]n/i,
        type: 'minutos',
        umbrales: { verde: 3.00, amarillo: 5.00, rojo: 5.00, sentido: 'menor' }
      },
      {
        keys: ['transferencia-epa', 'transferencia a epa'],
        label: /transferencia\\s*a\\s*epa/i,
        type: 'porcentaje',
        umbrales: { verde: 85, amarillo: 70, rojo: 70, sentido: 'mayor' }
      },
      {
        keys: ['tipificaciones', 'tipificacion'],
        label: /tipificaci[óo]n|tipificaciones/i,
        type: 'porcentaje',
        umbrales: { verde: 95, amarillo: 94, rojo: 80, sentido: 'mayor' }
      }
    ];

    // Utilidades de parseo
    function parsePorcentaje(str) {
      if (!str) return null;
      let val = str.replace(',', '.').replace('%', '').trim();
      let num = parseFloat(val);
      return isNaN(num) ? null : num;
    }
    function parseMinutos(str) {
      if (!str) return null;
      str = str.replace(',', '.');
      if (/^[0-9]+([\\.,][0-9]+)?$/.test(str)) return parseFloat(str); // decimal
      let partes = str.split(':').map(s => parseFloat(s.replace(',', '.')));
      if (partes.length === 2) return partes[0] + (partes[1] / 60);
      if (partes.length === 3) return partes[0] * 60 + (partes[1]) + (partes[2] / 60);
      return null;
    }
    function normalizaTexto(txt) {
      return txt.normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase();
    }
    function getKpiType(el) {
      // Estrategia A: data-kpi
      let kpi = el.getAttribute('data-kpi');
      if (kpi) {
        kpi = normalizaTexto(kpi);
        for (const def of kpiMap) {
          if (def.keys.some(key => normalizaTexto(key) === kpi)) return def;
        }
      }
      // Estrategia B: clase
      for (const def of kpiMap) {
        if (def.keys.some(key => el.classList.contains('kpi--' + key))) return def;
      }
      // Estrategia C: label cercano
      let label = '';
      let labelEl = el.querySelector('.kpi__label');
      if (labelEl) label = labelEl.textContent || '';
      else label = el.textContent || '';
      label = normalizaTexto(label);
      for (const def of kpiMap) {
        if (def.keys.some(key => label.includes(normalizaTexto(key)))) return def;
        if (def.label && def.label.test(label)) return def;
      }
      return null;
    }
    function getValorKpi(el, tipo) {
      // data-kpi-value
      let valEl = el.querySelector('[data-kpi-value]') || el.querySelector('.kpi__valor') || el;
      let raw = valEl.textContent || '';
      if (tipo === 'porcentaje') return parsePorcentaje(raw);
      if (tipo === 'minutos') return parseMinutos(raw);
      return null;
    }
    function getEstadoKpi(valor, def) {
      if (valor === null || valor === undefined || isNaN(valor)) return { estado: 'gris', texto: 'Sin dato', emoji: '⚪' };
      if (def.type === 'porcentaje') {
        if (valor >= def.umbrales.verde) return { estado: 'verde', texto: 'Verde', emoji: '🟢' };
        if (valor >= def.umbrales.amarillo) return { estado: 'amarillo', texto: 'Amarillo', emoji: '🟡' };
        return { estado: 'rojo', texto: 'Rojo', emoji: '🔴' };
      }
      if (def.type === 'minutos') {
        if (valor <= def.umbrales.verde) return { estado: 'verde', texto: 'Verde', emoji: '🟢' };
        if (valor <= def.umbrales.amarillo) return { estado: 'amarillo', texto: 'Amarillo', emoji: '🟡' };
        return { estado: 'rojo', texto: 'Rojo', emoji: '🔴' };
      }
      return { estado: 'gris', texto: 'Sin dato', emoji: '⚪' };
    }

    // 1. Buscar todos los posibles contenedores KPI
    let kpiEls = Array.from(document.querySelectorAll('.kpi, [data-kpi]'));
    // Eliminar duplicados
    kpiEls = kpiEls.filter((el, i, arr) => arr.indexOf(el) === i);

    kpiEls.forEach(el => {
      // 2. Inferir tipo de KPI
      const def = getKpiType(el);
      // 3. Extraer valor
      const valor = def ? getValorKpi(el, def.type) : null;
      // 4. Evaluar estado
      const estado = def ? getEstadoKpi(valor, def) : { estado: 'gris', texto: 'Sin dato', emoji: '⚪' };
      // 5. Limpiar clases previas de estado
      el.classList.remove('kpi--verde', 'kpi--amarillo', 'kpi--rojo', 'kpi--gris');
      el.classList.add('kpi--' + estado.estado);
      // 6. Insertar/actualizar badget de estado
      let chip = el.querySelector('.kpi__estado');
      if (!chip) {
        chip = document.createElement('span');
        chip.className = 'kpi__estado';
        el.appendChild(chip);
      }
      chip.textContent = estado.texto;
      chip.setAttribute('aria-label', 'Estado: ' + estado.texto);
      chip.setAttribute('title', 'Estado: ' + estado.texto);
      chip.innerText = estado.emoji + ' ' + estado.texto;
    });
  })();
</script>
<style>
  :root {
    --kpi-verde: #1E7F4F;
    --kpi-amarillo: #C79200;
    --kpi-rojo: #B00020;
    --kpi-gris: #6B7280;
  }

  .kpi {
    display: inline-flex;
    align-items: center;
    gap: 0.5em;
    margin: 0.2em 0.5em 0.2em 0;
    border-radius: 0.5em;
    padding: 0.2em 0.6em 0.2em 0.4em;
  }

  .kpi__valor {
    font-weight: bold;
    margin-left: 0.2em;
  }

  .kpi__estado {
    display: inline-block;
    margin-left: 0.5em;
    padding: 0.1em 0.7em;
    border-radius: 1em;
    font-size: 0.95em;
    font-weight: 600;
    letter-spacing: 0.01em;
    color: #fff;
    vertical-align: middle;
    min-width: 4.5em;
    text-align: center;
  }

  .kpi--verde {
    background: rgba(30, 127, 79, 0.08);
  }

  .kpi--amarillo {
    background: rgba(199, 146, 0, 0.08);
  }

  .kpi--rojo {
    background: rgba(176, 0, 32, 0.08);
  }

  .kpi--gris {
    background: rgba(107, 114, 128, 0.08);
  }

  .kpi--verde .kpi__estado {
    background: var(--kpi-verde);
  }

  .kpi--amarillo .kpi__estado {
    background: var(--kpi-amarillo);
  }

  .kpi--rojo .kpi__estado {
    background: var(--kpi-rojo);
  }

  .kpi--gris .kpi__estado {
    background: var(--kpi-gris);
  }
</style>
<script>
  (function () {
    // Configuración de umbrales y mapeo de KPI
    const kpiMap = [
      {
        keys: ['satisfaccion-snl', 'satisfacción-snl', 'satisfaccion snl', 'satisfacción snl'],
        label: /satisfac[ci][óo]n\\s*snl/i,
        type: 'porcentaje',
        umbrales: { verde: 95, amarillo: 85, rojo: 85, sentido: 'mayor' }
      },
      {
        keys: ['satisfaccion-ep', 'satisfacción-ep', 'satisfaccion ep', 'satisfacción ep'],
        label: /satisfac[ci][óo]n\\s*ep/i,
        type: 'porcentaje',
        umbrales: { verde: 95, amarillo: 85, rojo: 85, sentido: 'mayor' }
      },
      {
        keys: ['resolucion-snl', 'resolución-snl', 'resolucion snl', 'resolución snl'],
        label: /resoluci[óo]n\\s*snl/i,
        type: 'porcentaje',
        umbrales: { verde: 95, amarillo: 94, rojo: 80, sentido: 'mayor' }
      },
      {
        keys: ['resolucion-ep', 'resolución-ep', 'resolucion ep', 'resolución ep'],
        label: /resoluci[óo]n\\s*ep/i,
        type: 'porcentaje',
        umbrales: { verde: 95, amarillo: 94, rojo: 80, sentido: 'mayor' }
      },
      {
        keys: ['tmo', 'tiempo-medio-operacion', 'tiempo medio de operacion', 'tiempo medio de operación'],
        label: /tmo|tiempo\\s*medio\\s*de\\s*operaci[óo]n/i,
        type: 'minutos',
        umbrales: { verde: 3.00, amarillo: 5.00, rojo: 5.00, sentido: 'menor' }
      },
      {
        keys: ['transferencia-epa', 'transferencia a epa'],
        label: /transferencia\\s*a\\s*epa/i,
        type: 'porcentaje',
        umbrales: { verde: 85, amarillo: 70, rojo: 70, sentido: 'mayor' }
      },
      {
        keys: ['tipificaciones', 'tipificacion'],
        label: /tipificaci[óo]n|tipificaciones/i,
        type: 'porcentaje',
        umbrales: { verde: 95, amarillo: 94, rojo: 80, sentido: 'mayor' }
      }
    ];

    // Utilidades de parseo
    function parsePorcentaje(str) {
      if (!str) return null;
      let val = str.replace(',', '.').replace('%', '').trim();
      let num = parseFloat(val);
      return isNaN(num) ? null : num;
    }
    function parseMinutos(str) {
      if (!str) return null;
      str = str.replace(',', '.');
      if (/^[0-9]+([\\.,][0-9]+)?$/.test(str)) return parseFloat(str); // decimal
      let partes = str.split(':').map(s => parseFloat(s.replace(',', '.')));
      if (partes.length === 2) return partes[0] + (partes[1] / 60);
      if (partes.length === 3) return partes[0] * 60 + (partes[1]) + (partes[2] / 60);
      return null;
    }
    function normalizaTexto(txt) {
      return txt.normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase();
    }
    function getKpiType(el) {
      // Estrategia A: data-kpi
      let kpi = el.getAttribute('data-kpi');
      if (kpi) {
        kpi = normalizaTexto(kpi);
        for (const def of kpiMap) {
          if (def.keys.some(key => normalizaTexto(key) === kpi)) return def;
        }
      }
      // Estrategia B: clase
      for (const def of kpiMap) {
        if (def.keys.some(key => el.classList.contains('kpi--' + key))) return def;
      }
      // Estrategia C: label cercano
      let label = '';
      let labelEl = el.querySelector('.kpi__label');
      if (labelEl) label = labelEl.textContent || '';
      else label = el.textContent || '';
      label = normalizaTexto(label);
      for (const def of kpiMap) {
        if (def.keys.some(key => label.includes(normalizaTexto(key)))) return def;
        if (def.label && def.label.test(label)) return def;
      }
      return null;
    }
    function getValorKpi(el, tipo) {
      // data-kpi-value
      let valEl = el.querySelector('[data-kpi-value]') || el.querySelector('.kpi__valor') || el;
      let raw = valEl.textContent || '';
      if (tipo === 'porcentaje') return parsePorcentaje(raw);
      if (tipo === 'minutos') return parseMinutos(raw);
      return null;
    }
    function getEstadoKpi(valor, def) {
      if (valor === null || valor === undefined || isNaN(valor)) return { estado: 'gris', texto: 'Sin dato', emoji: '⚪' };
      if (def.type === 'porcentaje') {
        if (valor >= def.umbrales.verde) return { estado: 'verde', texto: 'Verde', emoji: '🟢' };
        if (valor >= def.umbrales.amarillo) return { estado: 'amarillo', texto: 'Amarillo', emoji: '🟡' };
        return { estado: 'rojo', texto: 'Rojo', emoji: '🔴' };
      }
      if (def.type === 'minutos') {
        if (valor <= def.umbrales.verde) return { estado: 'verde', texto: 'Verde', emoji: '🟢' };
        if (valor <= def.umbrales.amarillo) return { estado: 'amarillo', texto: 'Amarillo', emoji: '🟡' };
        return { estado: 'rojo', texto: 'Rojo', emoji: '🔴' };
      }
      return { estado: 'gris', texto: 'Sin dato', emoji: '⚪' };
    }

    // 1. Buscar todos los posibles contenedores KPI
    let kpiEls = Array.from(document.querySelectorAll('.kpi, [data-kpi]'));
    // Eliminar duplicados
    kpiEls = kpiEls.filter((el, i, arr) => arr.indexOf(el) === i);

    kpiEls.forEach(el => {
      // 2. Inferir tipo de KPI
      const def = getKpiType(el);
      // 3. Extraer valor
      const valor = def ? getValorKpi(el, def.type) : null;
      // 4. Evaluar estado
      const estado = def ? getEstadoKpi(valor, def) : { estado: 'gris', texto: 'Sin dato', emoji: '⚪' };
      // 5. Limpiar clases previas de estado
      el.classList.remove('kpi--verde', 'kpi--amarillo', 'kpi--rojo', 'kpi--gris');
      el.classList.add('kpi--' + estado.estado);
      // 6. Insertar/actualizar badget de estado
      let chip = el.querySelector('.kpi__estado');
      if (!chip) {
        chip = document.createElement('span');
        chip.className = 'kpi__estado';
        el.appendChild(chip);
      }
      chip.textContent = estado.texto;
      chip.setAttribute('aria-label', 'Estado: ' + estado.texto);
      chip.setAttribute('title', 'Estado: ' + estado.texto);
      chip.innerText = estado.emoji + ' ' + estado.texto;
    });
  })();
</script>
<style>
  :root {
    --kpi-verde: #1E7F4F;
    --kpi-amarillo: #C79200;
    --kpi-rojo: #B00020;
    --kpi-gris: #6B7280;
  }

  .kpi {
    display: inline-flex;
    align-items: center;
    gap: 0.5em;
    margin: 0.2em 0.5em 0.2em 0;
    border-radius: 0.5em;
    padding: 0.2em 0.6em 0.2em 0.4em;
  }

  .kpi__valor {
    font-weight: bold;
    margin-left: 0.2em;
  }

  .kpi__estado {
    display: inline-block;
    margin-left: 0.5em;
    padding: 0.1em 0.7em;
    border-radius: 1em;
    font-size: 0.95em;
    font-weight: 600;
    letter-spacing: 0.01em;
    color: #fff;
    vertical-align: middle;
    min-width: 4.5em;
    text-align: center;
  }

  .kpi--verde {
    background: rgba(30, 127, 79, 0.08);
  }

  .kpi--amarillo {
    background: rgba(199, 146, 0, 0.08);
  }

  .kpi--rojo {
    background: rgba(176, 0, 32, 0.08);
  }

  .kpi--gris {
    background: rgba(107, 114, 128, 0.08);
  }

  .kpi--verde .kpi__estado {
    background: var(--kpi-verde);
  }

  .kpi--amarillo .kpi__estado {
    background: var(--kpi-amarillo);
  }

  .kpi--rojo .kpi__estado {
    background: var(--kpi-rojo);
  }

  .kpi--gris .kpi__estado {
    background: var(--kpi-gris);
  }
</style>
<script>
  (function () {
    // Configuración de umbrales y mapeo de KPI
    const kpiMap = [
      {
        keys: ['satisfaccion-snl', 'satisfacción-snl', 'satisfaccion snl', 'satisfacción snl'],
        label: /satisfac[ci][óo]n\\s*snl/i,
        type: 'porcentaje',
        umbrales: { verde: 95, amarillo: 85, rojo: 85, sentido: 'mayor' }
      },
      {
        keys: ['satisfaccion-ep', 'satisfacción-ep', 'satisfaccion ep', 'satisfacción ep'],
        label: /satisfac[ci][óo]n\\s*ep/i,
        type: 'porcentaje',
        umbrales: { verde: 95, amarillo: 85, rojo: 85, sentido: 'mayor' }
      },
      {
        keys: ['resolucion-snl', 'resolución-snl', 'resolucion snl', 'resolución snl'],
        label: /resoluci[óo]n\\s*snl/i,
        type: 'porcentaje',
        umbrales: { verde: 95, amarillo: 94, rojo: 80, sentido: 'mayor' }
      },
      {
        keys: ['resolucion-ep', 'resolución-ep', 'resolucion ep', 'resolución ep'],
        label: /resoluci[óo]n\\s*ep/i,
        type: 'porcentaje',
        umbrales: { verde: 95, amarillo: 94, rojo: 80, sentido: 'mayor' }
      },
      {
        keys: ['tmo', 'tiempo-medio-operacion', 'tiempo medio de operacion', 'tiempo medio de operación'],
        label: /tmo|tiempo\\s*medio\\s*de\\s*operaci[óo]n/i,
        type: 'minutos',
        umbrales: { verde: 3.00, amarillo: 5.00, rojo: 5.00, sentido: 'menor' }
      },
      {
        keys: ['transferencia-epa', 'transferencia a epa'],
        label: /transferencia\\s*a\\s*epa/i,
        type: 'porcentaje',
        umbrales: { verde: 85, amarillo: 70, rojo: 70, sentido: 'mayor' }
      },
      {
        keys: ['tipificaciones', 'tipificacion'],
        label: /tipificaci[óo]n|tipificaciones/i,
        type: 'porcentaje',
        umbrales: { verde: 95, amarillo: 94, rojo: 80, sentido: 'mayor' }
      }
    ];

    // Utilidades de parseo
    function parsePorcentaje(str) {
      if (!str) return null;
      let val = str.replace(',', '.').replace('%', '').trim();
      let num = parseFloat(val);
      return isNaN(num) ? null : num;
    }
    function parseMinutos(str) {
      if (!str) return null;
      str = str.replace(',', '.');
      if (/^[0-9]+([\\.,][0-9]+)?$/.test(str)) return parseFloat(str); // decimal
      let partes = str.split(':').map(s => parseFloat(s.replace(',', '.')));
      if (partes.length === 2) return partes[0] + (partes[1] / 60);
      if (partes.length === 3) return partes[0] * 60 + (partes[1]) + (partes[2] / 60);
      return null;
    }
    function normalizaTexto(txt) {
      return txt.normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase();
    }
    function getKpiType(el) {
      // Estrategia A: data-kpi
      let kpi = el.getAttribute('data-kpi');
      if (kpi) {
        kpi = normalizaTexto(kpi);
        for (const def of kpiMap) {
          if (def.keys.some(key => normalizaTexto(key) === kpi)) return def;
        }
      }
      // Estrategia B: clase
      for (const def of kpiMap) {
        if (def.keys.some(key => el.classList.contains('kpi--' + key))) return def;
      }
      // Estrategia C: label cercano
      let label = '';
      let labelEl = el.querySelector('.kpi__label');
      if (labelEl) label = labelEl.textContent || '';
      else label = el.textContent || '';
      label = normalizaTexto(label);
      for (const def of kpiMap) {
        if (def.keys.some(key => label.includes(normalizaTexto(key)))) return def;
        if (def.label && def.label.test(label)) return def;
      }
      return null;
    }
    function getValorKpi(el, tipo) {
      // data-kpi-value
      let valEl = el.querySelector('[data-kpi-value]') || el.querySelector('.kpi__valor') || el;
      let raw = valEl.textContent || '';
      if (tipo === 'porcentaje') return parsePorcentaje(raw);
      if (tipo === 'minutos') return parseMinutos(raw);
      return null;
    }
    function getEstadoKpi(valor, def) {
      if (valor === null || valor === undefined || isNaN(valor)) return { estado: 'gris', texto: 'Sin dato', emoji: '⚪' };
      if (def.type === 'porcentaje') {
        if (valor >= def.umbrales.verde) return { estado: 'verde', texto: 'Verde', emoji: '🟢' };
        if (valor >= def.umbrales.amarillo) return { estado: 'amarillo', texto: 'Amarillo', emoji: '🟡' };
        return { estado: 'rojo', texto: 'Rojo', emoji: '🔴' };
      }
      if (def.type === 'minutos') {
        if (valor <= def.umbrales.verde) return { estado: 'verde', texto: 'Verde', emoji: '🟢' };
        if (valor <= def.umbrales.amarillo) return { estado: 'amarillo', texto: 'Amarillo', emoji: '🟡' };
        return { estado: 'rojo', texto: 'Rojo', emoji: '🔴' };
      }
      return { estado: 'gris', texto: 'Sin dato', emoji: '⚪' };
    }

    // 1. Buscar todos los posibles contenedores KPI
    let kpiEls = Array.from(document.querySelectorAll('.kpi, [data-kpi]'));
    // Eliminar duplicados
    kpiEls = kpiEls.filter((el, i, arr) => arr.indexOf(el) === i);

    kpiEls.forEach(el => {
      // 2. Inferir tipo de KPI
      const def = getKpiType(el);
      // 3. Extraer valor
      const valor = def ? getValorKpi(el, def.type) : null;
      // 4. Evaluar estado
      const estado = def ? getEstadoKpi(valor, def) : { estado: 'gris', texto: 'Sin dato', emoji: '⚪' };
      // 5. Limpiar clases previas de estado
      el.classList.remove('kpi--verde', 'kpi--amarillo', 'kpi--rojo', 'kpi--gris');
      el.classList.add('kpi--' + estado.estado);
      // 6. Insertar/actualizar badget de estado
      let chip = el.querySelector('.kpi__estado');
      if (!chip) {
        chip = document.createElement('span');
        chip.className = 'kpi__estado';
        el.appendChild(chip);
      }
      chip.textContent = estado.texto;
      chip.setAttribute('aria-label', 'Estado: ' + estado.texto);
      chip.setAttribute('title', 'Estado: ' + estado.texto);
      chip.innerText = estado.emoji + ' ' + estado.texto;
    });
  })();
</script>
<style>
  :root {
    --kpi-verde: #1E7F4F;
    --kpi-amarillo: #C79200;
    --kpi-rojo: #B00020;
    --kpi-gris: #6B7280;
  }

  .kpi {
    display: inline-flex;
    align-items: center;
    gap: 0.5em;
    margin: 0.2em 0.5em 0.2em 0;
    border-radius: 0.5em;
    padding: 0.2em 0.6em 0.2em 0.4em;
  }

  .kpi__valor {
    font-weight: bold;
    margin-left: 0.2em;
  }

  .kpi__estado {
    display: inline-block;
    margin-left: 0.5em;
    padding: 0.1em 0.7em;
    border-radius: 1em;
    font-size: 0.95em;
    font-weight: 600;
    letter-spacing: 0.01em;
    color: #fff;
    vertical-align: middle;
    min-width: 4.5em;
    text-align: center;
  }

  .kpi--verde {
    background: rgba(30, 127, 79, 0.08);
  }

  .kpi--amarillo {
    background: rgba(199, 146, 0, 0.08);
  }

  .kpi--rojo {
    background: rgba(176, 0, 32, 0.08);
  }

  .kpi--gris {
    background: rgba(107, 114, 128, 0.08);
  }

  .kpi--verde .kpi__estado {
    background: var(--kpi-verde);
  }

  .kpi--amarillo .kpi__estado {
    background: var(--kpi-amarillo);
  }

  .kpi--rojo .kpi__estado {
    background: var(--kpi-rojo);
  }

  .kpi--gris .kpi__estado {
    background: var(--kpi-gris);
  }
</style>
<script>
  (function () {
    // Configuración de umbrales y mapeo de KPI
    const kpiMap = [
      {
        keys: ['satisfaccion-snl', 'satisfacción-snl', 'satisfaccion snl', 'satisfacción snl'],
        label: /satisfac[ci][óo]n\\s*snl/i,
        type: 'porcentaje',
        umbrales: { verde: 95, amarillo: 85, rojo: 85, sentido: 'mayor' }
      },
      {
        keys: ['satisfaccion-ep', 'satisfacción-ep', 'satisfaccion ep', 'satisfacción ep'],
        label: /satisfac[ci][óo]n\\s*ep/i,
        type: 'porcentaje',
        umbrales: { verde: 95, amarillo: 85, rojo: 85, sentido: 'mayor' }
      },
      {
        keys: ['resolucion-snl', 'resolución-snl', 'resolucion snl', 'resolución snl'],
        label: /resoluci[óo]n\\s*snl/i,
        type: 'porcentaje',
        umbrales: { verde: 95, amarillo: 94, rojo: 80, sentido: 'mayor' }
      },
      {
        keys: ['resolucion-ep', 'resolución-ep', 'resolucion ep', 'resolución ep'],
        label: /resoluci[óo]n\\s*ep/i,
        type: 'porcentaje',
        umbrales: { verde: 95, amarillo: 94, rojo: 80, sentido: 'mayor' }
      },
      {
        keys: ['tmo', 'tiempo-medio-operacion', 'tiempo medio de operacion', 'tiempo medio de operación'],
        label: /tmo|tiempo\\s*medio\\s*de\\s*operaci[óo]n/i,
        type: 'minutos',
        umbrales: { verde: 3.00, amarillo: 5.00, rojo: 5.00, sentido: 'menor' }
      },
      {
        keys: ['transferencia-epa', 'transferencia a epa'],
        label: /transferencia\\s*a\\s*epa/i,
        type: 'porcentaje',
        umbrales: { verde: 85, amarillo: 70, rojo: 70, sentido: 'mayor' }
      },
      {
        keys: ['tipificaciones', 'tipificacion'],
        label: /tipificaci[óo]n|tipificaciones/i,
        type: 'porcentaje',
        umbrales: { verde: 95, amarillo: 94, rojo: 80, sentido: 'mayor' }
      }
    ];

    // Utilidades de parseo
    function parsePorcentaje(str) {
      if (!str) return null;
      let val = str.replace(',', '.').replace('%', '').trim();
      let num = parseFloat(val);
      return isNaN(num) ? null : num;
    }
    function parseMinutos(str) {
      if (!str) return null;
      str = str.replace(',', '.');
      if (/^[0-9]+([\\.,][0-9]+)?$/.test(str)) return parseFloat(str); // decimal
      let partes = str.split(':').map(s => parseFloat(s.replace(',', '.')));
      if (partes.length === 2) return partes[0] + (partes[1] / 60);
      if (partes.length === 3) return partes[0] * 60 + (partes[1]) + (partes[2] / 60);
      return null;
    }
    function normalizaTexto(txt) {
      return txt.normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase();
    }
    function getKpiType(el) {
      // Estrategia A: data-kpi
      let kpi = el.getAttribute('data-kpi');
      if (kpi) {
        kpi = normalizaTexto(kpi);
        for (const def of kpiMap) {
          if (def.keys.some(key => normalizaTexto(key) === kpi)) return def;
        }
      }
      // Estrategia B: clase
      for (const def of kpiMap) {
        if (def.keys.some(key => el.classList.contains('kpi--' + key))) return def;
      }
      // Estrategia C: label cercano
      let label = '';
      let labelEl = el.querySelector('.kpi__label');
      if (labelEl) label = labelEl.textContent || '';
      else label = el.textContent || '';
      label = normalizaTexto(label);
      for (const def of kpiMap) {
        if (def.keys.some(key => label.includes(normalizaTexto(key)))) return def;
        if (def.label && def.label.test(label)) return def;
      }
      return null;
    }
    function getValorKpi(el, tipo) {
      // data-kpi-value
      let valEl = el.querySelector('[data-kpi-value]') || el.querySelector('.kpi__valor') || el;
      let raw = valEl.textContent || '';
      if (tipo === 'porcentaje') return parsePorcentaje(raw);
      if (tipo === 'minutos') return parseMinutos(raw);
      return null;
    }
    function getEstadoKpi(valor, def) {
      if (valor === null || valor === undefined || isNaN(valor)) return { estado: 'gris', texto: 'Sin dato', emoji: '⚪' };
      if (def.type === 'porcentaje') {
        if (valor >= def.umbrales.verde) return { estado: 'verde', texto: 'Verde', emoji: '🟢' };
        if (valor >= def.umbrales.amarillo) return { estado: 'amarillo', texto: 'Amarillo', emoji: '🟡' };
        return { estado: 'rojo', texto: 'Rojo', emoji: '🔴' };
      }
      if (def.type === 'minutos') {
        if (valor <= def.umbrales.verde) return { estado: 'verde', texto: 'Verde', emoji: '🟢' };
        if (valor <= def.umbrales.amarillo) return { estado: 'amarillo', texto: 'Amarillo', emoji: '🟡' };
        return { estado: 'rojo', texto: 'Rojo', emoji: '🔴' };
      }
      return { estado: 'gris', texto: 'Sin dato', emoji: '⚪' };
    }

    // 1. Buscar todos los posibles contenedores KPI
    let kpiEls = Array.from(document.querySelectorAll('.kpi, [data-kpi]'));
    // Eliminar duplicados
    kpiEls = kpiEls.filter((el, i, arr) => arr.indexOf(el) === i);

    kpiEls.forEach(el => {
      // 2. Inferir tipo de KPI
      const def = getKpiType(el);
      // 3. Extraer valor
      const valor = def ? getValorKpi(el, def.type) : null;
      // 4. Evaluar estado
      const estado = def ? getEstadoKpi(valor, def) : { estado: 'gris', texto: 'Sin dato', emoji: '⚪' };
      // 5. Limpiar clases previas de estado
      el.classList.remove('kpi--verde', 'kpi--amarillo', 'kpi--rojo', 'kpi--gris');
      el.classList.add('kpi--' + estado.estado);
      // 6. Insertar/actualizar badget de estado
      let chip = el.querySelector('.kpi__estado');
      if (!chip) {
        chip = document.createElement('span');
        chip.className = 'kpi__estado';
        el.appendChild(chip);
      }
      chip.textContent = estado.texto;
      chip.setAttribute('aria-label', 'Estado: ' + estado.texto);
      chip.setAttribute('title', 'Estado: ' + estado.texto);
      chip.innerText = estado.emoji + ' ' + estado.texto;
    });
  })();
</script>
<style>
  :root {
    --kpi-verde: #1E7F4F;
    --kpi-amarillo: #C79200;
    --kpi-rojo: #B00020;
    --kpi-gris: #6B7280;
  }

  .kpi {
    display: inline-flex;
    align-items: center;
    gap: 0.5em;
    margin: 0.2em 0.5em 0.2em 0;
    border-radius: 0.5em;
    padding: 0.2em 0.6em 0.2em 0.4em;
  }

  .kpi__valor {
    font-weight: bold;
    margin-left: 0.2em;
  }

  .kpi__estado {
    display: inline-block;
    margin-left: 0.5em;
    padding: 0.1em 0.7em;
    border-radius: 1em;
    font-size: 0.95em;
    font-weight: 600;
    letter-spacing: 0.01em;
    color: #fff;
    vertical-align: middle;
    min-width: 4.5em;
    text-align: center;
  }

  .kpi--verde {
    background: rgba(30, 127, 79, 0.08);
  }

  .kpi--amarillo {
    background: rgba(199, 146, 0, 0.08);
  }

  .kpi--rojo {
    background: rgba(176, 0, 32, 0.08);
  }

  .kpi--gris {
    background: rgba(107, 114, 128, 0.08);
  }

  .kpi--verde .kpi__estado {
    background: var(--kpi-verde);
  }

  .kpi--amarillo .kpi__estado {
    background: var(--kpi-amarillo);
  }

  .kpi--rojo .kpi__estado {
    background: var(--kpi-rojo);
  }

  .kpi--gris .kpi__estado {
    background: var(--kpi-gris);
  }
</style>
<script>
  (function () {
    // Configuración de umbrales y mapeo de KPI
    const kpiMap = [
      {
        keys: ['satisfaccion-snl', 'satisfacción-snl', 'satisfaccion snl', 'satisfacción snl'],
        label: /satisfac[ci][óo]n\\s*snl/i,
        type: 'porcentaje',
        umbrales: { verde: 95, amarillo: 85, rojo: 85, sentido: 'mayor' }
      },
      {
        keys: ['satisfaccion-ep', 'satisfacción-ep', 'satisfaccion ep', 'satisfacción ep'],
        label: /satisfac[ci][óo]n\\s*ep/i,
        type: 'porcentaje',
        umbrales: { verde: 95, amarillo: 85, rojo: 85, sentido: 'mayor' }
      },
      {
        keys: ['resolucion-snl', 'resolución-snl', 'resolucion snl', 'resolución snl'],
        label: /resoluci[óo]n\\s*snl/i,
        type: 'porcentaje',
        umbrales: { verde: 95, amarillo: 94, rojo: 80, sentido: 'mayor' }
      },
      {
        keys: ['resolucion-ep', 'resolución-ep', 'resolucion ep', 'resolución ep'],
        label: /resoluci[óo]n\\s*ep/i,
        type: 'porcentaje',
        umbrales: { verde: 95, amarillo: 94, rojo: 80, sentido: 'mayor' }
      },
      {
        keys: ['tmo', 'tiempo-medio-operacion', 'tiempo medio de operacion', 'tiempo medio de operación'],
        label: /tmo|tiempo\\s*medio\\s*de\\s*operaci[óo]n/i,
        type: 'minutos',
        umbrales: { verde: 3.00, amarillo: 5.00, rojo: 5.00, sentido: 'menor' }
      },
      {
        keys: ['transferencia-epa', 'transferencia a epa'],
        label: /transferencia\\s*a\\s*epa/i,
        type: 'porcentaje',
        umbrales: { verde: 85, amarillo: 70, rojo: 70, sentido: 'mayor' }
      },
      {
        keys: ['tipificaciones', 'tipificacion'],
        label: /tipificaci[óo]n|tipificaciones/i,
        type: 'porcentaje',
        umbrales: { verde: 95, amarillo: 94, rojo: 80, sentido: 'mayor' }
      }
    ];

    // Utilidades de parseo
    function parsePorcentaje(str) {
      if (!str) return null;
      let val = str.replace(',', '.').replace('%', '').trim();
      let num = parseFloat(val);
      return isNaN(num) ? null : num;
    }
    function parseMinutos(str) {
      if (!str) return null;
      str = str.replace(',', '.');
      if (/^[0-9]+([\\.,][0-9]+)?$/.test(str)) return parseFloat(str); // decimal
      let partes = str.split(':').map(s => parseFloat(s.replace(',', '.')));
      if (partes.length === 2) return partes[0] + (partes[1] / 60);
      if (partes.length === 3) return partes[0] * 60 + (partes[1]) + (partes[2] / 60);
      return null;
    }
    function normalizaTexto(txt) {
      return txt.normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase();
    }
    function getKpiType(el) {
      // Estrategia A: data-kpi
      let kpi = el.getAttribute('data-kpi');
      if (kpi) {
        kpi = normalizaTexto(kpi);
        for (const def of kpiMap) {
          if (def.keys.some(key => normalizaTexto(key) === kpi)) return def;
        }
      }
      // Estrategia B: clase
      for (const def of kpiMap) {
        if (def.keys.some(key => el.classList.contains('kpi--' + key))) return def;
      }
      // Estrategia C: label cercano
      let label = '';
      let labelEl = el.querySelector('.kpi__label');
      if (labelEl) label = labelEl.textContent || '';
      else label = el.textContent || '';
      label = normalizaTexto(label);
      for (const def of kpiMap) {
        if (def.keys.some(key => label.includes(normalizaTexto(key)))) return def;
        if (def.label && def.label.test(label)) return def;
      }
      return null;
    }
    function getValorKpi(el, tipo) {
      // data-kpi-value
      let valEl = el.querySelector('[data-kpi-value]') || el.querySelector('.kpi__valor') || el;
      let raw = valEl.textContent || '';
      if (tipo === 'porcentaje') return parsePorcentaje(raw);
      if (tipo === 'minutos') return parseMinutos(raw);
      return null;
    }
    function getEstadoKpi(valor, def) {
      if (valor === null || valor === undefined || isNaN(valor)) return { estado: 'gris', texto: 'Sin dato', emoji: '⚪' };
      if (def.type === 'porcentaje') {
        if (valor >= def.umbrales.verde) return { estado: 'verde', texto: 'Verde', emoji: '🟢' };
        if (valor >= def.umbrales.amarillo) return { estado: 'amarillo', texto: 'Amarillo', emoji: '🟡' };
        return { estado: 'rojo', texto: 'Rojo', emoji: '🔴' };
      }
      if (def.type === 'minutos') {
        if (valor <= def.umbrales.verde) return { estado: 'verde', texto: 'Verde', emoji: '🟢' };
        if (valor <= def.umbrales.amarillo) return { estado: 'amarillo', texto: 'Amarillo', emoji: '🟡' };
        return { estado: 'rojo', texto: 'Rojo', emoji: '🔴' };
      }
      return { estado: 'gris', texto: 'Sin dato', emoji: '⚪' };
    }

    // 1. Buscar todos los posibles contenedores KPI
    let kpiEls = Array.from(document.querySelectorAll('.kpi, [data-kpi]'));
    // Eliminar duplicados
    kpiEls = kpiEls.filter((el, i, arr) => arr.indexOf(el) === i);

    kpiEls.forEach(el => {
      // 2. Inferir tipo de KPI
      const def = getKpiType(el);
      // 3. Extraer valor
      const valor = def ? getValorKpi(el, def.type) : null;
      // 4. Evaluar estado
      const estado = def ? getEstadoKpi(valor, def) : { estado: 'gris', texto: 'Sin dato', emoji: '⚪' };
      // 5. Limpiar clases previas de estado
      el.classList.remove('kpi--verde', 'kpi--amarillo', 'kpi--rojo', 'kpi--gris');
      el.classList.add('kpi--' + estado.estado);
      // 6. Insertar/actualizar badget de estado
      let chip = el.querySelector('.kpi__estado');
      if (!chip) {
        chip = document.createElement('span');
        chip.className = 'kpi__estado';
        el.appendChild(chip);
      }
      chip.textContent = estado.texto;
      chip.setAttribute('aria-label', 'Estado: ' + estado.texto);
      chip.setAttribute('title', 'Estado: ' + estado.texto);
      chip.innerText = estado.emoji + ' ' + estado.texto;
    });
  })();
</script>
<style>
  :root {
    --kpi-verde: #1E7F4F;
    --kpi-amarillo: #C79200;
    --kpi-rojo: #B00020;
    --kpi-gris: #6B7280;
  }

  .kpi {
    display: inline-flex;
    align-items: center;
    gap: 0.5em;
    margin: 0.2em 0.5em 0.2em 0;
    border-radius: 0.5em;
    padding: 0.2em 0.6em 0.2em 0.4em;
  }

  .kpi__valor {
    font-weight: bold;
    margin-left: 0.2em;
  }

  .kpi__estado {
    display: inline-block;
    margin-left: 0.5em;
    padding: 0.1em 0.7em;
    border-radius: 1em;
    font-size: 0.95em;
    font-weight: 600;
    letter-spacing: 0.01em;
    color: #fff;
    vertical-align: middle;
    min-width: 4.5em;
    text-align: center;
  }

  .kpi--verde {
    background: rgba(30, 127, 79, 0.08);
  }

  .kpi--amarillo {
    background: rgba(199, 146, 0, 0.08);
  }

  .kpi--rojo {
    background: rgba(176, 0, 32, 0.08);
  }

  .kpi--gris {
    background: rgba(107, 114, 128, 0.08);
  }

  .kpi--verde .kpi__estado {
    background: var(--kpi-verde);
  }

  .kpi--amarillo .kpi__estado {
    background: var(--kpi-amarillo);
  }

  .kpi--rojo .kpi__estado {
    background: var(--kpi-rojo);
  }

  .kpi--gris .kpi__estado {
    background: var(--kpi-gris);
  }
</style>
<script>
  (function () {
    // Configuración de umbrales y mapeo de KPI
    const kpiMap = [
      {
        keys: ['satisfaccion-snl', 'satisfacción-snl', 'satisfaccion snl', 'satisfacción snl'],
        label: /satisfac[ci][óo]n\\s*snl/i,
        type: 'porcentaje',
        umbrales: { verde: 95, amarillo: 85, rojo: 85, sentido: 'mayor' }
      },
      {
        keys: ['satisfaccion-ep', 'satisfacción-ep', 'satisfaccion ep', 'satisfacción ep'],
        label: /satisfac[ci][óo]n\\s*ep/i,
        type: 'porcentaje',
        umbrales: { verde: 95, amarillo: 85, rojo: 85, sentido: 'mayor' }
      },
      {
        keys: ['resolucion-snl', 'resolución-snl', 'resolucion snl', 'resolución snl'],
        label: /resoluci[óo]n\\s*snl/i,
        type: 'porcentaje',
        umbrales: { verde: 95, amarillo: 94, rojo: 80, sentido: 'mayor' }
      },
      {
        keys: ['resolucion-ep', 'resolución-ep', 'resolucion ep', 'resolución ep'],
        label: /resoluci[óo]n\\s*ep/i,
        type: 'porcentaje',
        umbrales: { verde: 95, amarillo: 94, rojo: 80, sentido: 'mayor' }
      },
      {
        keys: ['tmo', 'tiempo-medio-operacion', 'tiempo medio de operacion', 'tiempo medio de operación'],
        label: /tmo|tiempo\\s*medio\\s*de\\s*operaci[óo]n/i,
        type: 'minutos',
        umbrales: { verde: 3.00, amarillo: 5.00, rojo: 5.00, sentido: 'menor' }
      },
      {
        keys: ['transferencia-epa', 'transferencia a epa'],
        label: /transferencia\\s*a\\s*epa/i,
        type: 'porcentaje',
        umbrales: { verde: 85, amarillo: 70, rojo: 70, sentido: 'mayor' }
      },
      {
        keys: ['tipificaciones', 'tipificacion'],
        label: /tipificaci[óo]n|tipificaciones/i,
        type: 'porcentaje',
        umbrales: { verde: 95, amarillo: 94, rojo: 80, sentido: 'mayor' }
      }
    ];

    // Utilidades de parseo
    function parsePorcentaje(str) {
      if (!str) return null;
      let val = str.replace(',', '.').replace('%', '').trim();
      let num = parseFloat(val);
      return isNaN(num) ? null : num;
    }
    function parseMinutos(str) {
      if (!str) return null;
      str = str.replace(',', '.');
      if (/^[0-9]+([\\.,][0-9]+)?$/.test(str)) return parseFloat(str); // decimal
      let partes = str.split(':').map(s => parseFloat(s.replace(',', '.')));
      if (partes.length === 2) return partes[0] + (partes[1] / 60);
      if (partes.length === 3) return partes[0] * 60 + (partes[1]) + (partes[2] / 60);
      return null;
    }
    function normalizaTexto(txt) {
      return txt.normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase();
    }
    function getKpiType(el) {
      // Estrategia A: data-kpi
      let kpi = el.getAttribute('data-kpi');
      if (kpi) {
        kpi = normalizaTexto(kpi);
        for (const def of kpiMap) {
          if (def.keys.some(key => normalizaTexto(key) === kpi)) return def;
        }
      }
      // Estrategia B: clase
      for (const def of kpiMap) {
        if (def.keys.some(key => el.classList.contains('kpi--' + key))) return def;
      }
      // Estrategia C: label cercano
      let label = '';
      let labelEl = el.querySelector('.kpi__label');
      if (labelEl) label = labelEl.textContent || '';
      else label = el.textContent || '';
      label = normalizaTexto(label);
      for (const def of kpiMap) {
        if (def.keys.some(key => label.includes(normalizaTexto(key)))) return def;
        if (def.label && def.label.test(label)) return def;
      }
      return null;
    }
    function getValorKpi(el, tipo) {
      // data-kpi-value
      let valEl = el.querySelector('[data-kpi-value]') || el.querySelector('.kpi__valor') || el;
      let raw = valEl.textContent || '';
      if (tipo === 'porcentaje') return parsePorcentaje(raw);
      if (tipo === 'minutos') return parseMinutos(raw);
      return null;
    }
    function getEstadoKpi(valor, def) {
      if (valor === null || valor === undefined || isNaN(valor)) return { estado: 'gris', texto: 'Sin dato', emoji: '⚪' };
      if (def.type === 'porcentaje') {
        if (valor >= def.umbrales.verde) return { estado: 'verde', texto: 'Verde', emoji: '🟢' };
        if (valor >= def.umbrales.amarillo) return { estado: 'amarillo', texto: 'Amarillo', emoji: '🟡' };
        return { estado: 'rojo', texto: 'Rojo', emoji: '🔴' };
      }
      if (def.type === 'minutos') {
        if (valor <= def.umbrales.verde) return { estado: 'verde', texto: 'Verde', emoji: '🟢' };
        if (valor <= def.umbrales.amarillo) return { estado: 'amarillo', texto: 'Amarillo', emoji: '🟡' };
        return { estado: 'rojo', texto: 'Rojo', emoji: '🔴' };
      }
      return { estado: 'gris', texto: 'Sin dato', emoji: '⚪' };
    }

    // 1. Buscar todos los posibles contenedores KPI
    let kpiEls = Array.from(document.querySelectorAll('.kpi, [data-kpi]'));
    // Eliminar duplicados
    kpiEls = kpiEls.filter((el, i, arr) => arr.indexOf(el) === i);

    kpiEls.forEach(el => {
      // 2. Inferir tipo de KPI
      const def = getKpiType(el);
      // 3. Extraer valor
      const valor = def ? getValorKpi(el, def.type) : null;
      // 4. Evaluar estado
      const estado = def ? getEstadoKpi(valor, def) : { estado: 'gris', texto: 'Sin dato', emoji: '⚪' };
      // 5. Limpiar clases previas de estado
      el.classList.remove('kpi--verde', 'kpi--amarillo', 'kpi--rojo', 'kpi--gris');
      el.classList.add('kpi--' + estado.estado);
      // 6. Insertar/actualizar badget de estado
      let chip = el.querySelector('.kpi__estado');
      if (!chip) {
        chip = document.createElement('span');
        chip.className = 'kpi__estado';
        el.appendChild(chip);
      }
      chip.textContent = estado.texto;
      chip.setAttribute('aria-label', 'Estado: ' + estado.texto);
      chip.setAttribute('title', 'Estado: ' + estado.texto);
      chip.innerText = estado.emoji + ' ' + estado.texto;
    });
  })();
</script> <!-- Panel lateral de Alertas Críticas -->
<!-- Panel de alertas críticas eliminado -->

<!-- Semáforo KPI inbound (autoinyectado) -->
<style>
  :root {
    --kpi-verde: #1E7F4F;
    --kpi-amarillo: #C79200;
    --kpi-rojo: #B00020;
    --kpi-gris: #6B7280;
  }

  .kpi {
    display: inline-flex;
    align-items: center;
    gap: 0.5em;
    margin: 0.2em 0.5em 0.2em 0;
    border-radius: 0.5em;
    padding: 0.2em 0.6em 0.2em 0.4em;
  }

  .kpi__valor {
    font-weight: bold;
    margin-left: 0.2em;
  }

  .kpi__estado {
    display: inline-block;
    margin-left: 0.5em;
    padding: 0.1em 0.7em;
    border-radius: 1em;
    font-size: 0.95em;
    font-weight: 600;
    letter-spacing: 0.01em;
    color: #fff;
    vertical-align: middle;
    min-width: 4.5em;
    text-align: center;
  }

  .kpi--verde {
    background: rgba(30, 127, 79, 0.08);
  }

  .kpi--amarillo {
    background: rgba(199, 146, 0, 0.08);
  }

  .kpi--rojo {
    background: rgba(176, 0, 32, 0.08);
  }

  .kpi--gris {
    background: rgba(107, 114, 128, 0.08);
  }

  .kpi--verde .kpi__estado {
    background: var(--kpi-verde);
  }

  .kpi--amarillo .kpi__estado {
    background: var(--kpi-amarillo);
  }

  .kpi--rojo .kpi__estado {
    background: var(--kpi-rojo);
  }

  .kpi--gris .kpi__estado {
    background: var(--kpi-gris);
  }
</style>
<script>
  (function () {
    // Configuración de umbrales y mapeo de KPI (ajustado a tu formato)
    const kpiMap = [
      {
        keys: ['csat', 'nps', 'satisfaccion-cliente', 'satisfacción-cliente', 'satisfaccion del cliente', 'satisfacción del cliente'],
        label: /satisfac[ci][óo]n.*cliente|csat|nps/i,
        type: 'porcentaje',
        umbrales: { verde: 95, amarillo: 85, rojo: 85, sentido: 'mayor' }
      },
      {
        keys: ['fcr', 'resolucion-primera-llamada', 'resolución-primera-llamada', 'resolucion en la primera llamada', 'resolución en la primera llamada'],
        label: /resoluci[óo]n.*primera.*llamada|fcr/i,
        type: 'porcentaje',
        umbrales: { verde: 95, amarillo: 94, rojo: 80, sentido: 'mayor' }
      },
      {
        keys: ['tmo', 'aht', 'tiempo-medio-operacion', 'tiempo medio de operacion', 'tiempo medio de operación'],
        label: /tmo|aht|tiempo\s*medio\s*de\s*operaci[óo]n/i,
        type: 'minutos',
        umbrales: { verde: 3.00, amarillo: 5.00, rojo: 5.00, sentido: 'menor' }
      },
      {
        keys: ['transferencia-epa', 'transferencia a epa'],
        label: /transferencia\s*a\s*epa/i,
        type: 'porcentaje',
        umbrales: { verde: 85, amarillo: 70, rojo: 70, sentido: 'mayor' }
      },
      {
        keys: ['tipificaciones', 'tipificacion', 'tipificaciones-correctas', 'tipificación-correcta'],
        label: /tipificaci[óo]n|tipificaciones/i,
        type: 'porcentaje',
        umbrales: { verde: 95, amarillo: 94, rojo: 80, sentido: 'mayor' }
      }
    ];

    // Utilidades de parseo
    function parsePorcentaje(str) {
      if (!str) return null;
      let val = str.replace(',', '.').replace('%', '').trim();
      let num = parseFloat(val);
      return isNaN(num) ? null : num;
    }
    function parseMinutos(str) {
      if (!str) return null;
      str = str.replace(',', '.');
      if (/^[0-9]+([\.,][0-9]+)?$/.test(str)) return parseFloat(str); // decimal
      let partes = str.split(':').map(s => parseFloat(s.replace(',', '.')));
      if (partes.length === 2) return partes[0] + (partes[1] / 60);
      if (partes.length === 3) return partes[0] * 60 + (partes[1]) + (partes[2] / 60);
      return null;
    }
    function normalizaTexto(txt) {
      return txt.normalize('NFD').replace(/[ -]/g, '').toLowerCase();
    }
    function getKpiType(el) {
      // Estrategia A: data-kpi
      let kpi = el.getAttribute('data-kpi');
      if (kpi) {
        kpi = normalizaTexto(kpi);
        for (const def of kpiMap) {
          if (def.keys.some(key => normalizaTexto(key) === kpi)) return def;
        }
      }
      // Estrategia B: clase
      for (const def of kpiMap) {
        if (def.keys.some(key => el.classList.contains('kpi--' + key))) return def;
      }
      // Estrategia C: label cercano
      let label = '';
      let labelEl = el.querySelector('.kpi__label');
      if (labelEl) label = labelEl.textContent || '';
      else label = el.textContent || '';
      label = normalizaTexto(label);
      for (const def of kpiMap) {
        if (def.keys.some(key => label.includes(normalizaTexto(key)))) return def;
        if (def.label && def.label.test(label)) return def;
      }
      return null;
    }
    function getValorKpi(el, tipo) {
      // data-kpi-value
      let valEl = el.querySelector('[data-kpi-value]') || el.querySelector('.kpi__valor') || el;
      let raw = valEl.textContent || '';
      if (tipo === 'porcentaje') return parsePorcentaje(raw);
      if (tipo === 'minutos') return parseMinutos(raw);
      return null;
    }
    function getEstadoKpi(valor, def) {
      if (valor === null || valor === undefined || isNaN(valor)) return { estado: 'gris', texto: 'Sin dato', emoji: '⚪' };
      if (def.type === 'porcentaje') {
        if (valor >= def.umbrales.verde) return { estado: 'verde', texto: 'Verde', emoji: '🟢' };
        if (valor >= def.umbrales.amarillo) return { estado: 'amarillo', texto: 'Amarillo', emoji: '🟡' };
        return { estado: 'rojo', texto: 'Rojo', emoji: '🔴' };
      }
      if (def.type === 'minutos') {
        if (valor <= def.umbrales.verde) return { estado: 'verde', texto: 'Verde', emoji: '🟢' };
        if (valor <= def.umbrales.amarillo) return { estado: 'amarillo', texto: 'Amarillo', emoji: '🟡' };
        return { estado: 'rojo', texto: 'Rojo', emoji: '🔴' };
      }
      return { estado: 'gris', texto: 'Sin dato', emoji: '⚪' };
    }

    // 1. Buscar todos los posibles contenedores KPI
    let kpiEls = Array.from(document.querySelectorAll('.kpi, [data-kpi]'));
    // Eliminar duplicados
    kpiEls = kpiEls.filter((el, i, arr) => arr.indexOf(el) === i);

    kpiEls.forEach(el => {
      // 2. Inferir tipo de KPI
      const def = getKpiType(el);
      // 3. Extraer valor
      const valor = def ? getValorKpi(el, def.type) : null;
      // 4. Evaluar estado
      const estado = def ? getEstadoKpi(valor, def) : { estado: 'gris', texto: 'Sin dato', emoji: '⚪' };
      // 5. Limpiar clases previas de estado
      el.classList.remove('kpi--verde', 'kpi--amarillo', 'kpi--rojo', 'kpi--gris');
      el.classList.add('kpi--' + estado.estado);
      // 6. Insertar/actualizar badget de estado
      let chip = el.querySelector('.kpi__estado');
      if (!chip) {
        chip = document.createElement('span');
        chip.className = 'kpi__estado';
        el.appendChild(chip);
      }
      chip.textContent = estado.texto;
      chip.setAttribute('aria-label', 'Estado: ' + estado.texto);
      chip.setAttribute('title', 'Estado: ' + estado.texto);
      chip.innerText = estado.emoji + ' ' + estado.texto;
    });
  })();
</script>
<style>
  .alertas-panel {
    position: fixed;
    top: 0;
    right: 0;
    width: 370px;
    max-width: 100vw;
    height: 100vh;
    background: #fff;
    box-shadow: -4px 0 20px rgba(198, 40, 40, 0.13);
    z-index: 2001;
    transform: translateX(110%);
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    flex-direction: column;
    color: #c62828;
    border-left: 4px solid #c62828;
  }

  .alertas-panel.open {
    transform: translateX(0);
  }

  .alertas-header {
    padding: 1.1em 1.3em 0.7em 1.3em;
    border-bottom: 1px solid #f9a825;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #fff;
    color: #c62828;
  }

  .alertas-list {
    flex: 1;
    overflow-y: auto;
    padding: 1.2em 1.3em;
  }

  .alerta-item {
    background: #fff3f3;
    border-left: 4px solid #c62828;
    border-radius: 7px;
    margin-bottom: 1em;
    padding: 1em 1em 1em 1.2em;
    box-shadow: 0 2px 8px rgba(198, 40, 40, 0.04);
    display: flex;
    flex-direction: column;
    gap: 0.5em;
  }

  .alerta-item .alerta-title {
    font-weight: 700;
    color: #c62828;
    font-size: 1.05em;
  }

  .alerta-item .alerta-desc {
    color: #444;
    font-size: 0.98em;
  }

  .alerta-item .alerta-kpi {
    font-size: 0.93em;
    color: #607d8b;
  }

  .alerta-item .alerta-revisado {
    align-self: flex-end;
    background: #eee;
    color: #c62828;
    border: none;
    border-radius: 4px;
    padding: 2px 10px;
    font-size: 0.95em;
    cursor: pointer;
    margin-top: 0.5em;
  }

  .alerta-item .alerta-revisado.checked {
    background: #c62828;
    color: #fff;
  }
</style>
<!-- Botón de alerta eliminado -->
<script>
  // --- Alertas Críticas ---
  function getAllExecAlerts() {
    const names = [...new Set(evolutivoRawData.map(d => d.nombre))];
    let all = [];
    names.forEach(name => {
      getExecAlerts(name).forEach(alert => {
        all.push({ name, ...alert });
      });
    });
    return all;
  }
  function alertaDesc(alert) {
    if (alert.type === 'bajo-meta') return '3+ días bajo meta en ' + getKpiLabel(alert.kpi);
    if (alert.type === 'caida') return 'Caída >10% en ' + getKpiLabel(alert.kpi) + ' vs semana anterior';
    if (alert.type === 'top3') return 'En riesgo de perder Top 3 en ' + getKpiLabel(alert.kpi);
    return '';
  }
  function renderAlertasPanel() {
    const list = document.getElementById('alertas-list');
    const revisados = JSON.parse(localStorage.getItem('alertas-revisadas') || '[]');
    const all = getAllExecAlerts();
    // Priorizar: bajo-meta > caida > top3
    all.sort((a, b) => {
      const p = { "bajo-meta": 1, "caida": 2, "top3": 3 };
      return (p[a.type] || 4) - (p[b.type] || 4);
    });
    list.innerHTML = all.map((a, i) => {
      const key = a.name + '-' + a.type + '-' + a.kpi;
      const checked = revisados.includes(key);
      return `<div class='alerta-item' style='opacity:${checked ? 0.5 : 1}'>
              <div class='alerta-title'>${a.name}</div>
              <div class='alerta-desc'>${alertaDesc(a)}</div>
              <div class='alerta-kpi'>${getKpiLabel(a.kpi)}</div>
              <button class='alerta-revisado${checked ? ' checked' : ''}' data-key='${key}'>${checked ? 'Revisado' : 'Marcar como revisado'}</button>
            </div>`;
    }).join('') || '<div style="color:#888;">Sin alertas críticas activas 🎉</div>';
    // Listeners
    list.querySelectorAll('.alerta-revisado').forEach(btn => {
      btn.onclick = function () {
        const key = this.getAttribute('data-key');
        let revisados = JSON.parse(localStorage.getItem('alertas-revisadas') || '[]');
        if (!revisados.includes(key)) revisados.push(key);
        else revisados = revisados.filter(k => k !== key);
        localStorage.setItem('alertas-revisadas', JSON.stringify(revisados));
        renderAlertasPanel();
      };
    });
  }
  document.getElementById('alertas-open').onclick = function () {
    document.getElementById('alertas-panel').classList.add('open');
    renderAlertasPanel();
  };
  document.getElementById('alertas-close').onclick = function () {
    document.getElementById('alertas-panel').classList.remove('open');
  };
</script>
<!-- ...existing code... -->
<!DOCTYPE html>
<html lang="es">

<head>
  <style>
    /* Badge de alerta pulsante */
    .alert-badge {
      display: inline-block;
      width: 13px;
      height: 13px;
      border-radius: 50%;
      background: #c62828;
      margin-right: 7px;
      box-shadow: 0 0 0 0 rgba(198, 40, 40, 0.7);
      animation: pulse-alert 1.2s infinite;
      vertical-align: middle;
      border: 2px solid #fff;
    }

    @keyframes pulse-alert {
      0% {
        box-shadow: 0 0 0 0 rgba(198, 40, 40, 0.7);
      }

      70% {
        box-shadow: 0 0 0 8px rgba(198, 40, 40, 0);
      }

      100% {
        box-shadow: 0 0 0 0 rgba(198, 40, 40, 0);
      }
    }
  </style>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel de Control ACHS - KPIs Operacionales</title>
  <!-- Chart.js 4.x CDN y plugin de anotaciones -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script
    src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@4.1.0/dist/chartjs-plugin-annotation.umd.min.js"></script>
  <style>
    :root {
      /* Colores corporativos ACHS y semáforo accesible */
      --achs-primary: #2E7D32;
      /* Verde ACHS */
      --achs-secondary: #F9A825;
      /* Ámbar */
      --achs-accent: #C62828;
      /* Rojo */
      --achs-neutral-text: #263238;
      --achs-neutral-line: #CFD8DC;
      --kpi-card-bg: #fff;
      --kpi-card-bg-dark: #212121;
      --kpi-card-shadow: 0 2px 8px rgba(44, 62, 80, 0.07);
      --kpi-chip-radius: 10px;
      --kpi-chip-font: 0.78em;
      --kpi-chip-padding: 0.15em 0.6em;
      --kpi-red: var(--achs-accent);
      --kpi-amber: var(--achs-secondary);
      --kpi-green: var(--achs-primary);
      --kpi-text: var(--achs-neutral-text);
      --kpi-line: var(--achs-neutral-line);
      --kpi-table-bg: #f5f5f5;
      --kpi-table-bg-dark: #181818;
      --kpi-table-row-hover: #e0e0e0;
      --kpi-table-row-hover-dark: #333;
      --kpi-table-border: #CFD8DC;
      --kpi-table-border-dark: #333;
      --kpi-tooltip-bg: #fff;
      --kpi-tooltip-bg-dark: #222;
      --kpi-tooltip-text: #263238;
      --kpi-tooltip-text-dark: #fff;
    }

    [data-theme="dark"] {
      --kpi-card-bg: var(--kpi-card-bg-dark);
      --kpi-table-bg: var(--kpi-table-bg-dark);
      --kpi-table-row-hover: var(--kpi-table-row-hover-dark);
      --kpi-table-border: var(--kpi-table-border-dark);
      --kpi-tooltip-bg: var(--kpi-tooltip-bg-dark);
      --kpi-tooltip-text: var(--kpi-tooltip-text-dark);
    }

    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: #f4f6f8;
      color: var(--kpi-text);
      margin: 0;
      min-height: 100vh;
      transition: background 0.2s;
    }

    [data-theme="dark"] body {
      background: #181818;
      color: #fff;
    }

    header {
      background: var(--achs-primary);
      color: #fff;
      padding: 1.2em 2em 1em 2em;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 2px 8px rgba(44, 62, 80, 0.07);
    }

    header h1 {
      font-size: 1.5em;
      margin: 0;
      letter-spacing: 0.02em;
    }

    .theme-toggle {
      background: none;
      border: none;
      color: #fff;
      font-size: 1.2em;
      cursor: pointer;
      margin-left: 1em;
    }

    main {
      max-width: 1400px;
      margin: 2em auto;
      padding: 0 1em;
      display: flex;
      flex-direction: column;
      gap: 2em;
    }

    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 1em;
    }

    @media (max-width: 1250px) {
      .dashboard-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    /* --- Estilos Top 3 Podium --- */
    .top-podium-container {
      display: flex;
      justify-content: center;
      align-items: flex-end;
      gap: 3.2rem;
      margin-bottom: 2rem;
      padding: 1rem;
      background: linear-gradient(to bottom, transparent, var(--kpi-card-bg));
      border-radius: 12px;
    }

    .podium-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      transition: transform 0.3s ease;
    }

    .podium-item:hover {
      transform: translateY(-5px);
    }

    .podium-avatar {
      width: 85px;
      height: 85px;
      border-radius: 50%;
      background: var(--achs-primary);
      color: white;
      display: flex;
      justify-content: center;
      align-items: center;
      font-weight: bold;
      font-size: 1.4em;
      margin-bottom: 1.1rem;
      border: 3px solid white;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      position: relative;
      transition: width 0.2s, height 0.2s, margin-bottom 0.2s;
    }

    .podium-rank {
      position: absolute;
      bottom: -5px;
      right: -5px;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 0.8em;
      border: 2px solid white;
    }

    .rank-1 .podium-avatar {
      width: 110px;
      height: 110px;
      font-size: 1.7em;
      border-color: #FFD700;
    }

    .rank-1 .podium-rank {
      background: #FFD700;
      color: #333;
    }

    .rank-2 .podium-avatar {
      border-color: #C0C0C0;
    }

    .rank-2 .podium-rank {
      background: #C0C0C0;
      color: #333;
    }

    .rank-3 .podium-avatar {
      border-color: #CD7F32;
    }

    .rank-3 .podium-rank {
      background: #CD7F32;
      color: white;
    }

    .podium-name {
      font-weight: 700;
      font-size: 1.15em;
      text-align: center;
      margin-bottom: 0.2rem;
      max-width: none;
      white-space: normal;
      overflow: visible;
      text-overflow: unset;
      color: #1a237e;
      letter-spacing: 0.01em;
      text-shadow: 0 1px 3px #fff, 0 0px 1px #26323822;
    }

    .podium-score {
      font-size: 0.8em;
      color: var(--achs-secondary);
      background: rgba(255, 255, 255, 0.5);
      padding: 2px 8px;
      border-radius: 10px;
    }

    /* Ajuste para modo oscuro */
    [data-theme="dark"] .podium-avatar {
      border-color: #333;
    }

    [data-theme="dark"] .podium-rank {
      border-color: #333;
    }

    [data-theme="dark"] .podium-score {
      background: rgba(0, 0, 0, 0.3);
      color: #ccc;
    }

    @media (max-width: 700px) {
      .dashboard-grid {
        grid-template-columns: 1fr;
      }
    }

    .kpi-card {
      background: var(--kpi-card-bg);
      border-radius: 0.7em;
      box-shadow: var(--kpi-card-shadow);
      padding: 0.7em 0.9em 0.7em 0.9em;
      display: flex;
      flex-direction: column;
      gap: 0.4em;
      position: relative;
      min-width: 0;
      transition: background 0.2s;
      max-width: 270px;
      min-width: 180px;
    }

    .kpi-card.red {
      border: 2px solid var(--kpi-red);
    }

    .kpi-card .kpi-title {
      font-weight: 600;
      font-size: 1em;
      display: flex;
      align-items: center;
      gap: 0.4em;
    }

    .kpi-card .kpi-value {
      font-size: 1.4em;
      font-weight: 700;
      margin: 0.05em 0 0.1em 0;
      display: flex;
      align-items: baseline;
      gap: 0.3em;
    }

    .kpi-card .kpi-meta {
      font-size: 0.85em;
      color: #607d8b;
      display: flex;
      gap: 0.7em;
      flex-wrap: wrap;
    }

    .kpi-chip {
      display: inline-block;
      border-radius: var(--kpi-chip-radius);
      font-size: var(--kpi-chip-font);
      padding: var(--kpi-chip-padding);
      color: #fff;
      font-weight: 600;
      margin-left: 0.5em;
      vertical-align: middle;
    }

    .kpi-chip.green {
      background: var(--kpi-green);
    }

    .kpi-chip.amber {
      background: var(--kpi-amber);
    }

    .kpi-chip.red {
      background: var(--kpi-red);
    }

    .kpi-sparkline {
      width: 100%;
      height: 28px;
      margin-top: 0.2em;
    }

    .kpi-graph-section {
      display: flex;
      flex-wrap: wrap;
      gap: 2em;
      align-items: flex-start;
      justify-content: space-between;
    }

    .kpi-graph-card {
      background: var(--kpi-card-bg);
      border-radius: 1em;
      box-shadow: var(--kpi-card-shadow);
      padding: 1.2em 1.5em;
      flex: 1 1 320px;
      min-width: 0;
      margin-bottom: 1em;
      transition: background 0.2s;
    }

    .kpi-graph-title {
      font-weight: 600;
      margin-bottom: 0.5em;
      font-size: 1.05em;
    }

    .kpi-table-section {
      background: var(--kpi-card-bg);
      border-radius: 1em;
      box-shadow: var(--kpi-card-shadow);
      padding: 1.2em 1.5em;
      margin-bottom: 1em;
      transition: background 0.2s;
    }

    .kpi-table-title {
      font-weight: 600;
      margin-bottom: 0.5em;
      font-size: 1.05em;
    }

    table.kpi-table {
      width: 100%;
      border-collapse: collapse;
      background: var(--kpi-table-bg);
      border-radius: 0.7em;
      overflow: hidden;
      font-size: 0.98em;
      margin-bottom: 0.5em;
    }

    table.kpi-table th,
    table.kpi-table td {
      padding: 0.6em 0.7em;
      text-align: left;
      border-bottom: 1px solid var(--kpi-table-border);
    }

    table.kpi-table th {
      background: #f0f4f8;
      color: var(--kpi-text);
      font-weight: 600;
    }

    [data-theme="dark"] table.kpi-table th {
      background: #232323;
      color: #fff;
    }

    table.kpi-table tr:hover {
      background: var(--kpi-table-row-hover);
    }

    .kpi-table-bar {
      height: 28px;
      border-radius: 14px;
      background: var(--kpi-line);
      position: relative;
      margin-top: 2px;
      margin-bottom: 2px;
      overflow: hidden;
    }

    .kpi-table-bar-inner {
      height: 100%;
      border-radius: 6px;
      transition: width 0.4s;
    }

    .kpi-table-bar.red {
      background: var(--kpi-red);
    }

    .kpi-table-bar.amber {
      background: var(--kpi-amber);
    }

    .kpi-table-bar.green {
      background: var(--kpi-green);
    }

    .kpi-table-bar-inner.red {
      background: var(--kpi-red);
    }

    .kpi-table-bar-inner.amber {
      background: var(--kpi-amber);
    }

    .kpi-table-bar-inner.green {
      background: var(--kpi-green);
    }

    .kpi-table-bar-inner {
      background: var(--kpi-green);
    }

    .kpi-table-bar-label {
      position: absolute;
      left: 14px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 1.15em;
      color: #fff;
      font-weight: 700;
      z-index: 2;
      letter-spacing: 0.02em;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.18);
      pointer-events: none;
    }

    .kpi-table-bar-label.red {
      color: #fff;
    }

    .kpi-table-bar-label.amber {
      color: #fff;
    }

    .kpi-table-bar-label.green {
      color: #fff;
    }

    .kpi-table-sparkline {
      width: 80px;
      height: 24px;
      display: block;
    }

    .kpi-config-panel {
      position: fixed;
      top: 0;
      right: 0;
      width: 340px;
      max-width: 100vw;
      height: 100vh;
      background: var(--kpi-card-bg);
      box-shadow: -2px 0 16px rgba(44, 62, 80, 0.13);
      z-index: 1000;
      transform: translateX(100%);
      transition: transform 0.3s;
      padding: 2em 1.5em 1.5em 1.5em;
      overflow-y: auto;
      color: var(--kpi-text);
    }

    .kpi-config-panel.open {
      transform: translateX(0);
    }

    .kpi-config-title {
      font-weight: 700;
      font-size: 1.2em;
      margin-bottom: 1em;
    }

    .kpi-config-close {
      position: absolute;
      top: 1em;
      right: 1em;
      background: none;
      border: none;
      font-size: 1.5em;
      color: var(--kpi-text);
      cursor: pointer;
    }

    .kpi-config-form label {
      display: block;
      margin-bottom: 0.3em;
      font-weight: 500;
    }

    .kpi-config-form input[type="number"],
    .kpi-config-form input[type="text"],
    .kpi-config-form select {
      width: 100%;
      padding: 0.5em 0.7em;
      border-radius: 0.4em;
      border: 1px solid var(--kpi-line);
      margin-bottom: 1em;
      font-size: 1em;
      background: #fff;
      color: var(--kpi-text);
      box-sizing: border-box;
      transition: background 0.2s;
    }

    [data-theme="dark"] .kpi-config-form input,
    [data-theme="dark"] .kpi-config-form select {
      background: #232323;
      color: #fff;
      border: 1px solid #444;
    }

    .kpi-config-form .kpi-config-actions {
      display: flex;
      gap: 1em;
      justify-content: flex-end;
      margin-top: 1.5em;
    }

    .kpi-config-form button {
      background: var(--achs-primary);
      color: #fff;
      border: none;
      border-radius: 0.4em;
      padding: 0.6em 1.2em;
      font-size: 1em;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }

    .kpi-config-form button:active {
      background: #1b5e20;
    }

    .kpi-config-form .kpi-config-reset {
      background: #bdbdbd;
      color: #263238;
    }

    .kpi-config-form .kpi-config-reset:active {
      background: #757575;
      color: #fff;
    }

    .kpi-config-form .kpi-config-row {
      display: flex;
      gap: 1em;
      align-items: center;
      margin-bottom: 1em;
    }

    .kpi-config-form .kpi-config-row label {
      flex: 1 1 40%;
      margin-bottom: 0;
    }

    .kpi-config-form .kpi-config-row input,
    .kpi-config-form .kpi-config-row select {
      flex: 1 1 60%;
      margin-bottom: 0;
    }

    .kpi-tooltip {
      position: absolute;
      z-index: 2000;
      background: var(--kpi-tooltip-bg);
      color: var(--kpi-tooltip-text);
      border-radius: 0.5em;
      box-shadow: 0 2px 8px rgba(44, 62, 80, 0.13);
      padding: 0.7em 1em;
      font-size: 0.98em;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.15s;
      max-width: 320px;
      line-height: 1.4;
    }

    .kpi-tooltip.visible {
      opacity: 1;
    }

    .kpi-empty-state {
      text-align: center;
      color: #bdbdbd;
      font-size: 1.2em;
      margin: 2em 0;
    }

    /* --- Evolutivo Panel Styles --- */
    .evolutivo-panel {
      position: fixed;
      top: 0;
      right: 0;
      width: 450px;
      max-width: 100vw;
      height: 100vh;
      background: var(--kpi-card-bg);
      box-shadow: -4px 0 20px rgba(0, 0, 0, 0.15);
      z-index: 1100;
      transform: translateX(100%);
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      flex-direction: column;
      color: var(--kpi-text);
      overflow: hidden;
    }

    .evolutivo-panel.open {
      transform: translateX(0);
    }

    .evolutivo-header {
      padding: 1.2em 1.5em;
      border-bottom: 1px solid var(--kpi-line);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--achs-primary);
      color: #fff;
      flex-shrink: 0;
    }

    .evolutivo-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      padding: 0;
    }

    .evolutivo-filter {
      padding: 1.2em 1.5em 0.5em;
      background: var(--kpi-card-bg);
      flex-shrink: 0;
    }

    .evolutivo-exec-list {
      max-height: 160px;
      overflow-y: auto;
      border-bottom: 2px solid var(--kpi-line);
      flex-shrink: 0;
      background: var(--kpi-card-bg);
    }

    #evolutivo-detail,
    #evolutivo-empty {
      flex: 1;
      overflow-y: auto;
      padding: 1.2em 1.5em;
      scrollbar-width: thin;
      scrollbar-color: var(--achs-primary) transparent;
    }

    #evolutivo-empty {
      padding: 3em 1.5em;
      text-align: center;
      color: #999;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .exec-item {
      padding: 0.8em 1em;
      border-bottom: 1px solid var(--kpi-line);
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background 0.2s;
    }

    .exec-item:hover,
    .exec-item.selected {
      background: rgba(46, 125, 50, 0.1);
    }

    .trend-tag {
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.75em;
      font-weight: 600;
      text-transform: uppercase;
    }

    .trend-improving {
      background: #e8f5e9;
      color: #2e7d32;
    }

    .trend-stable {
      background: #fff8e1;
      color: #f9a825;
    }

    .trend-worsening {
      background: #ffebee;
      color: #c62828;
    }

    .action-plan-card {
      background: #f8f9fa;
      border-left: 4px solid var(--achs-primary);
      padding: 1.2em;
      border-radius: 0 8px 8px 0;
      margin-top: 1em;
    }

    [data-theme="dark"] .action-plan-card {
      background: #2a2a2a;
      border-left-color: #4caf50;
    }

    .action-plan-card h4 {
      margin-top: 0;
      color: var(--achs-primary);
    }

    [data-theme="dark"] .action-plan-card h4 {
      color: #81c784;
    }

    .action-plan-card ul {
      padding-left: 1.2em;
      margin-bottom: 0;
    }

    .evolutivo-chart-container {
      height: 220px;
      margin-bottom: 1em;
    }

    .btn-evolutivo {
      background: rgba(255, 255, 255, 0.15);
      border: 1px solid rgba(255, 255, 255, 0.3);
      color: #fff;
      padding: 0.5em 1em;
      border-radius: 20px;
      font-size: 0.9em;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.5em;
      transition: all 0.2s;
    }

    .btn-evolutivo:hover {
      background: rgba(255, 255, 255, 0.25);
    }

    .btn-maintainer {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: #fff;
      padding: 0.5em 1em;
      border-radius: 8px;
      font-size: 0.85em;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.4em;
      transition: all 0.2s;
    }

    .btn-maintainer:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    /* --- Modal Base Styles --- */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 3000;
      padding: 1em;
    }

    .modal-overlay.open {
      display: flex;
    }

    .modal-card {
      background: var(--kpi-card-bg);
      width: 100%;
      max-width: 1000px;
      max-height: 90vh;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      color: var(--kpi-text);
      animation: modalFadeIn 0.3s ease;
    }

    @keyframes modalFadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .modal-header {
      padding: 1.2em 1.5em;
      background: var(--achs-primary);
      color: #fff;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-body {
      padding: 1.5em;
      overflow-y: auto;
      flex: 1;
    }

    .modal-footer {
      padding: 1em 1.5em;
      border-top: 1px solid var(--kpi-line);
      display: flex;
      justify-content: flex-end;
      gap: 1em;
      background: var(--kpi-table-bg);
    }

    /* --- Maintainer Specifics --- */
    .maintainer-tabs {
      display: flex;
      gap: 0.5em;
      margin-bottom: 1.5em;
      border-bottom: 1px solid var(--kpi-line);
      padding-bottom: 0.5em;
      overflow-x: auto;
    }

    .m-tab {
      padding: 0.6em 1.2em;
      cursor: pointer;
      border-radius: 6px;
      font-size: 0.9em;
      font-weight: 600;
      color: var(--kpi-text);
      opacity: 0.7;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .m-tab:hover {
      opacity: 1;
      background: rgba(0, 0, 0, 0.05);
    }

    .m-tab.active {
      opacity: 1;
      background: var(--achs-primary);
      color: #fff;
    }

    [data-theme="dark"] .m-tab:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .editable-table {
      width: 100%;
      border-collapse: collapse;
    }

    .editable-table th {
      position: sticky;
      top: 0;
      background: var(--kpi-table-bg);
      z-index: 5;
    }

    .editable-table td input {
      width: 100%;
      padding: 0.4em;
      border: 1px solid transparent;
      background: transparent;
      color: inherit;
      text-align: center;
      border-radius: 4px;
    }

    .editable-table td input:focus {
      background: #fff;
      border-color: var(--achs-primary);
      color: #000;
      outline: none;
    }

    .import-area {
      display: grid;
      grid-template-columns: 300px 1fr;
      gap: 1.5em;
      height: 400px;
    }

    .import-controls {
      display: flex;
      flex-direction: column;
      gap: 1em;
    }

    .import-paste-area {
      width: 100%;
      height: 100%;
      padding: 1em;
      border-radius: 8px;
      border: 2px dashed var(--kpi-line);
      background: rgba(0, 0, 0, 0.02);
      font-family: monospace;
      font-size: 0.9em;
      resize: none;
    }

    [data-theme="dark"] .import-paste-area {
      background: rgba(255, 255, 255, 0.02);
    }

    .preview-list {
      margin-top: 1.5em;
      max-height: 250px;
      overflow-y: auto;
      border: 1px solid var(--kpi-line);
      border-radius: 8px;
    }

    .preview-row {
      display: grid;
      grid-template-columns: 1fr 80px 80px 80px 120px;
      padding: 0.5em 1em;
      border-bottom: 1px solid var(--kpi-line);
      font-size: 0.85em;
    }

    .preview-row.error {
      background: #ffebee;
      color: #c62828;
    }

    .preview-row.warning {
      background: #fff8e1;
      color: #f9a825;
    }

    .preview-row.match {
      background: #e8f5e9;
      color: #2e7d32;
    }

    [data-theme="dark"] .preview-row.error {
      background: #3e2723;
    }

    [data-theme="dark"] .preview-row.warning {
      background: #3e2723;
    }

    [data-theme="dark"] .preview-row.match {
      background: #1b5e20;
    }

    .meta-summary-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.8em;
      margin: 1em 0;
    }

    .meta-item {
      padding: 0.6em;
      background: rgba(0, 0, 0, 0.03);
      border-radius: 6px;
      text-align: center;
    }

    [data-theme="dark"] .meta-item {
      background: rgba(255, 255, 255, 0.05);
    }

    .meta-item .label {
      font-size: 0.75em;
      color: #607d8b;
      display: block;
    }

    .meta-item .value {
      font-weight: 700;
      font-size: 1em;
    }

    .evolutivo-tabs .kpi-tab {
      background: var(--kpi-card-bg);
      border: 1px solid var(--kpi-line);
      color: var(--kpi-text);
      padding: 0.4em 0.8em;
      border-radius: 15px;
      font-size: 0.85em;
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.2s;
    }

    .evolutivo-tabs .kpi-tab.active {
      background: var(--achs-primary);
      color: #fff;
      border-color: var(--achs-primary);
    }

    [data-theme="dark"] .evolutivo-tabs .kpi-tab.active {
      background: #4caf50;
      border-color: #4caf50;
    }

    /* --- Robust Action Plan Styles --- */
    .robust-plan {
      background: var(--kpi-table-bg);
      border: 1px solid var(--kpi-line);
      border-radius: 12px;
      overflow: hidden;
      margin-top: 1em;
      font-family: 'Inter', sans-serif;
    }

    .plan-header {
      padding: 1em;
      background: #f8f9fa;
      border-bottom: 1px solid var(--kpi-line);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    [data-theme="dark"] .plan-header {
      background: rgba(255, 255, 255, 0.03);
    }

    .plan-header h4 {
      margin: 0;
      font-size: 1.1em;
      color: var(--achs-primary);
    }

    .status-badge {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.75em;
      font-weight: 700;
      text-transform: uppercase;
    }

    .status-gold {
      background: linear-gradient(135deg, #fff8e1 0%, #ffd54f 100%);
      color: #8d6e63;
      /* Darker text for contrast on yellow */
      border: 1px solid #ffca28;
      box-shadow: 0 2px 4px rgba(255, 193, 7, 0.3);
    }

    .status-silver {
      background: linear-gradient(135deg, #f5f5f5 0%, #e0e0e0 100%);
      color: #455a64;
      border: 1px solid #bdbdbd;
      box-shadow: 0 2px 4px rgba(158, 158, 158, 0.3);
    }

    .status-bronze {
      background: linear-gradient(135deg, #efebe9 0%, #d7ccc8 100%);
      color: #5d4037;
      border: 1px solid #a1887f;
      box-shadow: 0 2px 4px rgba(141, 110, 99, 0.3);
    }

    .status-critical {
      background: linear-gradient(135deg, #ffebee 0%, #ef9a9a 100%);
      color: #b71c1c;
      border: 1px solid #ef5350;
      box-shadow: 0 2px 4px rgba(244, 67, 54, 0.3);
      animation: pulse-red 2s infinite;
    }

    @keyframes pulse-red {
      0% {
        box-shadow: 0 0 0 0 rgba(244, 67, 54, 0.4);
      }

      70% {
        box-shadow: 0 0 0 10px rgba(244, 67, 54, 0);
      }

      100% {
        box-shadow: 0 0 0 0 rgba(244, 67, 54, 0);
      }
    }

    .plan-body {
      padding: 1em;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.5em;
    }

    @media (max-width: 600px) {
      .plan-body {
        grid-template-columns: 1fr;
      }
    }

    .plan-section-title {
      font-size: 0.85em;
      font-weight: 700;
      color: #90a4ae;
      margin-bottom: 0.8em;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .plan-list {
      margin: 0;
      padding-left: 1.2em;
      font-size: 0.9em;
      line-height: 1.6;
    }

    .plan-list li {
      margin-bottom: 0.5em;
    }

    .phrase-box {
      background: rgba(46, 125, 50, 0.05);
      border-left: 3px solid #2e7d32;
      padding: 10px;
      font-size: 0.85em;
      font-style: italic;
      color: var(--kpi-text);
      margin-top: 0.5em;
    }
  </style>
</head>

<body>
  <div id="login-modal"
    style="position:fixed;z-index:9999;top:0;left:0;width:100vw;height:100vh;background:#fff;display:flex;align-items:center;justify-content:center;">
    <form id="login-form"
      style="background:#fff;padding:2em 2.5em;border-radius:12px;box-shadow:0 4px 32px #0002;min-width:320px;display:flex;flex-direction:column;gap:1.2em;">
      <h2 style="margin:0 0 0.5em 0;font-size:1.3em;color:#2563eb;">Ingreso al Panel</h2>
      <div>
        <label for="rut" style="font-weight:600;">RUT:</label><br>
        <input type="text" id="rut" name="rut" placeholder="Ej: 12.345.678-9" required pattern="[0-9kK\.-]+"
          style="width:100%;padding:0.5em;margin-top:0.2em;">
      </div>
      <div>
        <label for="nombre" style="font-weight:600;">Nombre:</label><br>
        <input type="text" id="nombre" name="nombre" placeholder="Tu nombre completo" required
          style="width:100%;padding:0.5em;margin-top:0.2em;">
      </div>
      <button type="submit"
        style="background:#2563eb;color:#fff;padding:0.7em 1.5em;border:none;border-radius:6px;cursor:pointer;font-weight:600;font-size:1em;">Ingresar</button>
    </form>
  </div>
  <!-- Modal Predictivo (re-diseñado: responsive, scrollable, estética limpia) -->
  <style>
    /* Styles specific to the Predictivo modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.55);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 6000;
    }

    .modal-card {
      width: 92%;
      max-width: 1100px;
      height: 88vh;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.25);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      padding: 1rem 1.25rem;
      border-bottom: 1px solid #eef2f6;
      background: #fafbfd;
    }

    .modal-header h2 {
      margin: 0;
      font-size: 1.05rem;
      color: #1f2937;
    }

    .modal-actions {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .modal-body {
      padding: 1rem;
      overflow: auto;
      background: #f8fafc;
      flex: 1;
    }

    .modal-footer {
      padding: 0.75rem 1rem;
      border-top: 1px solid #eef2f6;
      text-align: right;
      background: #fff;
    }

    .btn-ghost {
      background: transparent;
      border: 1px solid #e6eef6;
      padding: 0.45rem 0.7rem;
      border-radius: 6px;
      cursor: pointer;
    }

    .btn-primary {
      background: #2563eb;
      color: #fff;
      border: none;
      padding: 0.5rem 0.85rem;
      border-radius: 6px;
      cursor: pointer;
    }

    /* Table inside modal */
    #contenido-predictivo table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.95rem;
    }

    #contenido-predictivo th,
    #contenido-predictivo td {
      padding: 0.6rem 0.7rem;
      border-bottom: 1px solid #eef2f6;
      text-align: center;
    }

    #contenido-predictivo th {
      background: #f1f5f9;
      font-weight: 700;
      color: #0f172a;
    }

    @media (max-width:700px) {
      .modal-card {
        width: 98%;
        height: 94vh;
      }

      .modal-header h2 {
        font-size: 0.95rem;
      }
    }

    /* --- Estilos Sistema Predictivo Externo --- */
    .predictivo-container {
      padding: 1rem;
      color: #2d3748;
    }

    .predictivo-controls {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
    }

    .predictivo-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .predictivo-stat-card {
      background: #f8fafc;
      border-radius: 10px;
      padding: 1rem;
      text-align: center;
      border: 1px solid #e2e8f0;
    }

    .predictivo-stat-val {
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--achs-primary);
    }

    .predictivo-stat-lab {
      font-size: 0.75rem;
      color: #64748b;
      text-transform: uppercase;
    }

    .predictivo-table-wrap {
      overflow-x: auto;
      border-radius: 8px;
      border: 1px solid #e2e8f0;
    }

    .predictivo-table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      font-size: 0.9rem;
    }

    .predictivo-table th {
      background: #f1f5f9;
      padding: 0.75rem;
      text-align: left;
      font-weight: 600;
      border-bottom: 2px solid #e2e8f0;
    }

    .predictivo-table td {
      padding: 0.75rem;
      border-bottom: 1px solid #f1f5f9;
    }

    .predictivo-trend-badge {
      display: inline-block;
      padding: 0.2rem 0.5rem;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .trend-mejorando {
      background: #dcfce7;
      color: #166534;
    }

    .trend-estable {
      background: #fef9c3;
      color: #854d0e;
    }

    .trend-empeorando {
      background: #fee2e2;
      color: #991b1b;
    }

    .analisis-detallado-panel {
      background: #f8fafc;
      border-radius: 12px;
      padding: 1.5rem;
      margin-top: 1.5rem;
      border-left: 4px solid var(--achs-primary);
      display: none;
    }

    .predictivo-kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }

    .predictivo-kpi-card {
      background: white;
      border-radius: 8px;
      padding: 1rem;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      border: 1px solid #e2e8f0;
    }

    .pkpi-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }

    .pkpi-name {
      font-weight: 600;
      color: #1e293b;
    }

    .pkpi-val {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--achs-primary);
    }

    .pkpi-info {
      font-size: 0.8rem;
      color: #64748b;
      line-height: 1.4;
    }

    .pkpi-chart {
      height: 100px;
      margin-top: 0.75rem;
    }

    .prec-box {
      background: #fff;
      border-radius: 8px;
      padding: 1rem;
      margin-top: 1rem;
      border: 1px solid #e2e8f0;
    }

    .prec-item {
      padding: 0.5rem;
      margin-bottom: 0.5rem;
      border-left: 3px solid;
      background: #f8fafc;
      font-size: 0.85rem;
    }

    .prec-alta {
      border-left-color: #ef4444;
    }

    .prec-media {
      border-left-color: #f59e0b;
    }

    .prec-baja {
      border-left-color: #10b981;
    }
  </style>

  <div id="modal-predictivo" class="modal-overlay" aria-hidden="true" role="dialog" aria-modal="true"
    aria-labelledby="modal-predictivo-title">
    <div class="modal-card">
      <div class="modal-header">
        <h2 id="modal-predictivo-title">Análisis Predictivo de KPIs por Ejecutivo</h2>
        <div class="modal-actions">
          <button id="modal-fullscreen" class="btn-ghost" title="Pantalla completa">⤢</button>
          <button id="cerrar-predictivo" class="btn-ghost" title="Cerrar">✕</button>
        </div>
      </div>
      <div id="contenido-predictivo" class="modal-body" tabindex="0">
        <!-- Aquí se mostrará la tabla de proyección (se genera por JS) -->
      </div>
      <div class="modal-footer">
        <button id="modal-close-footer" class="btn-ghost">Cerrar</button>
        <button id="modal-download" class="btn-primary" style="margin-left:0.5rem;">Descargar CSV</button>
      </div>
    </div>
  </div>
  <header>
    <div id="admin-auth-modal"
      style="display:none;position:fixed;z-index:6000;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.35);align-items:center;justify-content:center;">
      <form id="admin-auth-form"
        style="background:#fff;padding:2em 2.5em;border-radius:12px;box-shadow:0 4px 32px #0002;min-width:320px;display:flex;flex-direction:column;gap:1.2em;">
        <h3 style="margin:0 0 0.5em 0;font-size:1.1em;color:#1E7F4F;">Clave de Administrador</h3>
        <input type="password" id="admin-clave" placeholder="Ingrese clave" style="width:100%;padding:0.5em;">
        <div id="admin-auth-error" style="color:#B00020;display:none;font-size:0.98em;"></div>
        <div style="display:flex;gap:1em;justify-content:flex-end;">
          <button type="button" id="admin-auth-cancelar"
            style="background:#888;color:#fff;padding:0.4em 1em;border:none;border-radius:5px;cursor:pointer;">Cancelar</button>
          <button type="submit"
            style="background:#1E7F4F;color:#fff;padding:0.4em 1em;border:none;border-radius:5px;cursor:pointer;">Ingresar</button>
        </div>
      </form>
    </div>
    <div id="admin-info"
      style="display:none;position:absolute;top:60px;right:24px;background:#fff;color:#222;padding:1em 1.5em;border-radius:8px;box-shadow:0 4px 24px #0002;z-index:4001;min-width:260px;font-size:1em;max-width:95vw;">
      <div style="margin-bottom:0.7em;"><b>Último ingreso</b></div>
      <div><b>Usuario:</b> <span id="admin-nombre"></span></div>
      <div><b>RUT:</b> <span id="admin-rut"></span></div>
      <div><b>Ingreso:</b> <span id="admin-fecha"></span></div>
      <hr style="margin:1em 0;">
      <div style="display:flex;align-items:center;gap:1em;">
        <div style="flex:1 1 auto;">
          <div style="font-weight:600;margin-bottom:0.3em;">Historial de ingresos</div>
          <div id="admin-historial" style="max-height:180px;overflow-y:auto;font-size:0.97em;margin-bottom:0.7em;">
          </div>
          <button id="predictivo-btn"
            style="background:#2563eb;color:#fff;padding:0.4em 1em;border:none;border-radius:5px;cursor:pointer;margin-bottom:0.5em;margin-left:0.5em;">Predictivo</button>
        </div>
        <!-- Botón admin-btn duplicado eliminado -->
      </div>
      <button id="admin-eliminar-historial"
        style="background:#B00020;color:#fff;padding:0.4em 1em;border:none;border-radius:5px;cursor:pointer;margin-bottom:0.5em;">Eliminar
        historial</button>
      <button id="admin-cerrar"
        style="background:#888;color:#fff;padding:0.4em 1em;border:none;border-radius:5px;cursor:pointer;">Cerrar</button>
      <!-- Modal Predictivo (movido fuera de `#admin-info` para mostrarse independientemente) -->
    </div>
    <script>
      // Mostrar botón Administrador y guardar datos de ingreso
      document.addEventListener('DOMContentLoaded', function () {
        const loginModal = document.getElementById('login-modal');
        const loginForm = document.getElementById('login-form');
        const adminBtn = document.getElementById('admin-btn');
        const adminInfo = document.getElementById('admin-info');
        const adminNombre = document.getElementById('admin-nombre');
        const adminRut = document.getElementById('admin-rut');
        const adminFecha = document.getElementById('admin-fecha');
        const adminCerrar = document.getElementById('admin-cerrar');
        let datosUsuario = null;
        // Predictivo
        const predictivoBtn = document.getElementById('predictivo-btn');
        const modalPredictivo = document.getElementById('modal-predictivo');
        const cerrarPredictivo = document.getElementById('cerrar-predictivo');
        if (predictivoBtn && modalPredictivo && cerrarPredictivo) {
          predictivoBtn.addEventListener('click', function () {
            mostrarAnalisisPredictivo();
            modalPredictivo.style.display = 'flex';
          });
          // Atajo visible en header
          const predictivoShortcut = document.getElementById('predictivo-shortcut');
          if (predictivoShortcut && modalPredictivo) {
            predictivoShortcut.addEventListener('click', function () {
              mostrarAnalisisPredictivo();
              modalPredictivo.style.display = 'flex';
            });
          }
          // Cerrar modal (header close)
          cerrarPredictivo.addEventListener('click', function () {
            modalPredictivo.style.display = 'none';
            modalPredictivo.setAttribute('aria-hidden', 'true');
          });
          // Footer close
          const modalCloseFooter = document.getElementById('modal-close-footer');
          if (modalCloseFooter) modalCloseFooter.addEventListener('click', function () { modalPredictivo.style.display = 'none'; modalPredictivo.setAttribute('aria-hidden', 'true'); });
          // Descargar CSV (simple export de la tabla si existe)
          const modalDownload = document.getElementById('modal-download');
          if (modalDownload) modalDownload.addEventListener('click', function () {
            const table = document.querySelector('#contenido-predictivo table');
            if (!table) return alert('No hay datos para descargar');
            // Extraer CSV
            const rows = Array.from(table.querySelectorAll('tr')).map(tr => Array.from(tr.querySelectorAll('th,td')).map(td => '"' + (td.textContent || '').replace(/"/g, '""') + '"').join(','));
            const csv = rows.join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = 'predictivo.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
          });
          // Click fuera del card para cerrar
          modalPredictivo.addEventListener('click', function (e) {
            if (e.target === modalPredictivo) { modalPredictivo.style.display = 'none'; modalPredictivo.setAttribute('aria-hidden', 'true'); }
          });
          // Pantalla completa toggle
          const modalFullscreenBtn = document.getElementById('modal-fullscreen');
          if (modalFullscreenBtn) {
            modalFullscreenBtn.addEventListener('click', function () {
              const card = modalPredictivo.querySelector('.modal-card');
              if (!card) return;
              if (!card.classList.contains('fullscreen')) {
                card.style.width = '98%'; card.style.maxWidth = 'none'; card.style.height = '98vh'; card.style.borderRadius = '6px'; card.classList.add('fullscreen');
              } else {
                card.style.width = ''; card.style.maxWidth = ''; card.style.height = ''; card.style.borderRadius = ''; card.classList.remove('fullscreen');
              }
            });
          }
        }

        let analisisGlobal = {};

        window.mostrarAnalisisPredictivo = function () {
          const cont = document.getElementById('contenido-predictivo');
          if (!cont) return;

          cont.innerHTML = `
            <div class="predictivo-container">
              <div class="predictivo-controls">
                <button class="btn-primary" onclick="analizarTodosPredictivo()">🔍 Actualizar Análisis</button>
                <button class="btn-ghost" onclick="window.sistemaPredictivo.limpiarTodoHistorial(); analizarTodosPredictivo();">🗑️ Limpiar Historial</button>
              </div>

              <div class="predictivo-stats">
                <div class="predictivo-stat-card"><div class="predictivo-stat-val" id="ps-ejecutivos">-</div><div class="predictivo-stat-lab">Ejecutivos</div></div>
                <div class="predictivo-stat-card"><div class="predictivo-stat-val" id="ps-criticos" style="color:#ef4444">-</div><div class="predictivo-stat-lab">Críticos</div></div>
                <div class="predictivo-stat-card"><div class="predictivo-stat-val" id="ps-riesgo" style="color:#f59e0b">-</div><div class="predictivo-stat-lab">En Riesgo</div></div>
                <div class="predictivo-stat-card"><div class="predictivo-stat-val" id="ps-registros">-</div><div class="predictivo-stat-lab">Historial</div></div>
              </div>

              <div class="predictivo-table-wrap">
                <table class="predictivo-table">
                  <thead>
                    <tr>
                      <th>Ejecutivo</th>
                      <th>Tendencia</th>
                      <th>Críticos</th>
                      <th>Riesgo</th>
                      <th>Acción</th>
                      <th>Detalle</th>
                    </tr>
                  </thead>
                  <tbody id="ps-tbody">
                    <tr><td colspan="6" style="text-align:center; padding:2rem;">Cargando análisis...</td></tr>
                  </tbody>
                </table>
              </div>

              <div id="ps-analisis-detallado" class="analisis-detallado-panel">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                  <h3 id="ps-det-titulo" style="margin:0">Detalle de Análisis</h3>
                  <button class="btn-ghost" onclick="document.getElementById('ps-analisis-detallado').style.display='none'">✕</button>
                </div>
                <div id="ps-det-contenido"></div>
              </div>
            </div>
          `;

          setTimeout(analizarTodosPredictivo, 100);
        }

        window.analizarTodosPredictivo = function () {
          if (!window.sistemaPredictivo) return;
          const historial = window.sistemaPredictivo.historial.datos;
          const ejecutivosBase = typeof getDynamicExecutives === 'function' ? getDynamicExecutives() : [];

          analisisGlobal = {};
          let totalCriticos = 0, totalRiesgo = 0, totalRegistros = 0;

          ejecutivosBase.forEach(nombre => {
            const hist = historial[nombre];
            if (!hist) return;

            const metricasActuales = {};
            Object.entries(hist).forEach(([kpi, registros]) => {
              if (registros.length > 0) {
                metricasActuales[kpi] = registros[registros.length - 1].valor;
                totalRegistros += registros.length;
              }
            });

            if (Object.keys(metricasActuales).length > 0) {
              const analisis = window.sistemaPredictivo.analizarEjecutivo(nombre, metricasActuales);
              analisisGlobal[nombre] = analisis;
              totalCriticos += analisis.resumen.kpisCriticos;
              totalRiesgo += analisis.resumen.kpisEnRiesgo;
            }
          });

          // Actualizar UI
          document.getElementById('ps-ejecutivos').textContent = Object.keys(analisisGlobal).length;
          document.getElementById('ps-criticos').textContent = totalCriticos;
          document.getElementById('ps-riesgo').textContent = totalRiesgo;
          document.getElementById('ps-registros').textContent = totalRegistros;

          const tbody = document.getElementById('ps-tbody');
          tbody.innerHTML = '';

          Object.entries(analisisGlobal).forEach(([nombre, analisis]) => {
            const tr = document.createElement('tr');
            window.sistemaPredictivo.aplicarAlertasVisuales(tr, analisis);

            const trend = analisis.resumen.tendenciaGeneral;
            const trendClass = `trend-${trend}`;
            const trendIcon = trend === 'mejorando' ? '📈' : (trend === 'empeorando' ? '📉' : '➡️');

            tr.innerHTML = `
              <td><b>${nombre}</b></td>
              <td><span class="predictivo-trend-badge ${trendClass}">${trendIcon} ${trend.toUpperCase()}</span></td>
              <td style="text-align:center; color:#ef4444; font-weight:700">${analisis.resumen.kpisCriticos}</td>
              <td style="text-align:center; color:#f59e0b; font-weight:700">${analisis.resumen.kpisEnRiesgo}</td>
              <td style="text-align:center">${analisis.resumen.requiereAccion ? '🚨' : '✅'}</td>
              <td><button class="btn-ghost" onclick="verDetallePredictivo('${nombre}')">Ver</button></td>
            `;
            tbody.appendChild(tr);
          });

          if (Object.keys(analisisGlobal).length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:2rem; color:#64748b">No hay historial suficiente para analizar ejecutivos activos.</td></tr>';
          }
        }

        window.verDetallePredictivo = function (nombre) {
          const analisis = analisisGlobal[nombre];
          if (!analisis) return;

          const panel = document.getElementById('ps-analisis-detallado');
          document.getElementById('ps-det-titulo').textContent = `Análisis Avanzado: ${nombre}`;
          const cont = document.getElementById('ps-det-contenido');

          let html = '<div class="predictivo-kpi-grid">';
          Object.entries(analisis.kpis).forEach(([kpiId, datos]) => {
            const color = datos.estadoActual === 'verde' ? '#10b981' : (datos.estadoActual === 'amarillo' ? '#f59e0b' : '#ef4444');
            html += `
              <div class="predictivo-kpi-card">
                <div class="pkpi-header">
                  <span class="pkpi-name">${datos.nombre}</span>
                  <span class="pkpi-val" style="color:${color}">${datos.valorActual.toFixed(1)}${kpiId === 'tmo' ? ' min' : '%'}</span>
                </div>
                <div class="pkpi-info">
                  <b>Tendencia:</b> ${datos.tendencia.mensaje}<br>
                  <b>Proyectado:</b> ${datos.prediccion.mensaje}
                </div>
                <div class="pkpi-chart"><canvas id="ps-chart-${kpiId}"></canvas></div>
              </div>
            `;
          });
          html += '</div>';

          const recomendaciones = window.sistemaPredictivo.generarRecomendaciones(analisis);
          if (recomendaciones.length > 0) {
            html += `
              <div class="prec-box">
                <h4 style="margin:0 0 1rem 0">📋 Plan de Acción Recomendado</h4>
                ${recomendaciones.map(r => `
                  <div class="prec-item prec-${r.prioridad}">
                    <b>${r.kpi}</b>: ${r.accion} (Meta: ${r.plazo})
                  </div>
                `).join('')}
              </div>
            `;
          }

          cont.innerHTML = html;
          panel.style.display = 'block';

          // Gráficos
          setTimeout(() => {
            Object.keys(analisis.kpis).forEach(kpiId => {
              const canvas = document.getElementById(`ps-chart-${kpiId}`);
              if (canvas) {
                const config = window.sistemaPredictivo.obtenerConfiguracionGrafico(nombre, kpiId);
                if (config) new Chart(canvas, config);
              }
            });
            panel.scrollIntoView({ behavior: 'smooth' });
          }, 100);
        }
        // Cargar historial desde localStorage
        function cargarHistorial() {
          let historial = [];
          try {
            historial = JSON.parse(localStorage.getItem('historialIngresos') || '[]');
          } catch { }
          return Array.isArray(historial) ? historial : [];
        }
        function guardarHistorial(historial) {
          localStorage.setItem('historialIngresos', JSON.stringify(historial));
        }
        function renderHistorial() {
          const historialDiv = document.getElementById('admin-historial');
          if (!historialDiv) return;
          const historial = cargarHistorial();
          if (historial.length === 0) {
            historialDiv.innerHTML = '<div style="color:#888;">Sin ingresos registrados</div>';
          } else {
            historialDiv.innerHTML = '<ul style="padding-left:1.1em;margin:0;">' + historial.map(h =>
              `<li style='margin-bottom:0.3em;'><b>${h.nombre}</b> (${h.rut})<br><span style='color:#2563eb;'>${new Date(h.fecha).toLocaleString('es-CL')}</span></li>`
            ).join('') + '</ul>';
          }
        }
        if (loginForm) {
          loginForm.addEventListener('submit', function (e) {
            e.preventDefault();
            const rut = document.getElementById('rut').value.trim();
            const nombre = document.getElementById('nombre').value.trim();
            if (!rut || !nombre) {
              alert('Por favor, ingresa tu RUT y nombre.');
              return;
            }
            // Validar RUT chileno
            function validarRut(rut) {
              rut = rut.replace(/\./g, '').replace(/-/g, '').toUpperCase();
              if (!/^\d{7,8}[0-9K]$/.test(rut)) return false;
              let cuerpo = rut.slice(0, -1);
              let dv = rut.slice(-1);
              let suma = 0, multiplo = 2;
              for (let i = cuerpo.length - 1; i >= 0; i--) {
                suma += parseInt(cuerpo[i]) * multiplo;
                multiplo = multiplo < 7 ? multiplo + 1 : 2;
              }
              let dvEsperado = 11 - (suma % 11);
              dvEsperado = dvEsperado === 11 ? '0' : dvEsperado === 10 ? 'K' : dvEsperado.toString();
              return dv === dvEsperado;
            }
            let rutError = document.getElementById('rut-error');
            if (!rutError) {
              rutError = document.createElement('div');
              rutError.id = 'rut-error';
              rutError.style.color = '#B00020';
              rutError.style.fontSize = '0.98em';
              rutError.style.marginTop = '0.3em';
              document.getElementById('rut').parentElement.appendChild(rutError);
            }
            if (!validarRut(rut)) {
              rutError.textContent = 'El RUT ingresado no es válido.';
              document.getElementById('rut').focus();
              loginModal.style.display = 'flex';
              e.stopImmediatePropagation();
              return false;
            } else {
              rutError.textContent = '';
            }
            // Guardar datos y fecha de ingreso
            const fechaIngreso = new Date();
            datosUsuario = { rut, nombre, fecha: fechaIngreso };
            // Guardar en historial
            let historial = cargarHistorial();
            historial.unshift({ rut, nombre, fecha: fechaIngreso });
            if (historial.length > 50) historial = historial.slice(0, 50); // Limitar a 50 ingresos
            guardarHistorial(historial);
            // Mostrar botón admin
            if (adminBtn) adminBtn.style.display = 'inline-flex';
            if (adminInfo) {
              adminNombre.textContent = nombre;
              adminRut.textContent = rut;
              adminFecha.textContent = fechaIngreso.toLocaleString('es-CL');
              renderHistorial();
            }
            // Marcar como autenticado para módulos como Podio
            try{ sessionStorage.setItem('achs_auth','1'); }catch(e){}
            // Ocultar modal principal
            loginModal.style.display = 'none';
            // Invocar UI de podio si ya está disponible
            try{ if(window.achs_showPodioUI) window.achs_showPodioUI(); }catch(e){}
          });
        }
        const adminAuthModal = document.getElementById('admin-auth-modal');
        const adminAuthForm = document.getElementById('admin-auth-form');
        const adminClaveInput = document.getElementById('admin-clave');
        const adminAuthError = document.getElementById('admin-auth-error');
        const adminAuthCancelar = document.getElementById('admin-auth-cancelar');
        let adminAutenticado = false;
        let pendingAdminAction = null;
        if (adminBtn && adminInfo && adminAuthModal && adminAuthForm && adminClaveInput && adminAuthError && adminAuthCancelar) {
          function pedirClaveYContinuar(action) {
            if (!adminAutenticado) {
              pendingAdminAction = action;
              adminAuthModal.style.display = 'flex';
              adminClaveInput.value = '';
              adminAuthError.style.display = 'none';
              setTimeout(() => adminClaveInput.focus(), 100);
              return false;
            }
            return true;
          }
          adminBtn.addEventListener('click', function () {
            if (!pedirClaveYContinuar(() => adminBtn.click())) return;
            adminInfo.style.display = adminInfo.style.display === 'none' ? 'block' : 'none';
            if (adminInfo.style.display === 'block') renderHistorial();
          });
          // Proteger botón Actualizar
          const btnActualizar = document.getElementById('btn-actualizar-excel');
          if (btnActualizar) {
            btnActualizar.addEventListener('click', function (e) {
              if (!pedirClaveYContinuar(() => btnActualizar.click())) {
                e.stopImmediatePropagation();
                e.preventDefault();
                return false;
              }
              // Si ya autenticado, dejar que siga el flujo normal
            }, true);
          }
          adminAuthForm.addEventListener('submit', function (e) {
            e.preventDefault();
            if (adminClaveInput.value === 'ADMIN2026') {
              adminAutenticado = true;
              adminAuthModal.style.display = 'none';
              if (typeof pendingAdminAction === 'function') {
                setTimeout(() => pendingAdminAction(), 50);
                pendingAdminAction = null;
              } else {
                adminInfo.style.display = 'block';
                renderHistorial();
              }
            } else {
              adminAuthError.textContent = 'Clave incorrecta';
              adminAuthError.style.display = 'block';
              adminClaveInput.value = '';
              adminClaveInput.focus();
            }
          });
          adminAuthCancelar.addEventListener('click', function () {
            adminAuthModal.style.display = 'none';
          });
          if (adminCerrar) {
            adminCerrar.addEventListener('click', function () {
              adminInfo.style.display = 'none';
            });
          }
          const adminEliminarHistorial = document.getElementById('admin-eliminar-historial');
          if (adminEliminarHistorial) {
            adminEliminarHistorial.addEventListener('click', function () {
              if (confirm('¿Seguro que deseas eliminar todo el historial de ingresos?')) {
                guardarHistorial([]);
                renderHistorial();
              }
            });
          }
          // Ocultar info si se hace click fuera
          document.addEventListener('click', function (e) {
            if (adminInfo.style.display === 'block' && !adminInfo.contains(e.target) && e.target !== adminBtn) {
              adminInfo.style.display = 'none';
            }
          });
        }
      });
    </script>
    <script>
      document.addEventListener('DOMContentLoaded', function () {
        const loginModal = document.getElementById('login-modal');
        const loginForm = document.getElementById('login-form');
        if (loginForm) {
          loginForm.addEventListener('submit', function (e) {
            e.preventDefault();
            const rut = document.getElementById('rut').value.trim();
            const nombre = document.getElementById('nombre').value.trim();
            if (!rut || !nombre) {
              alert('Por favor, ingresa tu RUT y nombre.');
              return;
            }
            // Aquí podrías agregar validación extra de RUT si lo deseas
            try{ sessionStorage.setItem('achs_auth','1'); }catch(e){}
            loginModal.style.display = 'none';
            try{ if(window.achs_showPodioUI) window.achs_showPodioUI(); }catch(e){}
          });
        }
      });
    </script>
    <h1>Panel de Control Operacional ACHS</h1>
    <div style="display:flex; align-items:center; gap:0.6em;">
      <button class="btn-maintainer" id="btn-historial" title="Ver y editar historial de métricas">
        📅 Historial
      </button>
      <button class="btn-maintainer" id="btn-teams-report" title="Enviar reporte por Teams"
        style="background:#2563eb;color:#fff;">
        📨 Envío reporte por Teams
      </button>
      <button class="btn-maintainer" id="btn-actualizar-excel" title="Cargar datos desde Excel">
        📥 Actualizar
      </button>
      <div style="width:1px; height:24px; background:rgba(255,255,255,0.2); margin:0 0.5em;"></div>
      <button class="btn-evolutivo" id="btn-evolutivo-3m" title="Análisis de tendencia de los últimos 3 meses">
        📈 Evolutivo
      </button>
      <!-- Acceso rápido a Predictivo (visible en el header) -->
      <button id="predictivo-shortcut" title="Abrir Predictivo"
        style="background:#2563eb;color:#fff;padding:0.7em 1.5em;border:none;border-radius:6px;cursor:pointer;font-weight:600;font-size:1em;display:inline-block;margin-left:0.4em;">🔮
        Predictivo</button>
      <button id="admin-btn"
        style="display:none;background:#1E7F4F;color:#fff;padding:0.7em 1.5em;border:none;border-radius:6px;cursor:pointer;font-weight:600;font-size:1em;z-index:4000;align-self:flex-start;">Administrador</button>
    </div>
    <div id="admin-info"
      style="display:none;position:absolute;top:60px;right:24px;background:#fff;color:#222;padding:1em 1.5em;border-radius:8px;box-shadow:0 4px 24px #0002;z-index:4001;min-width:260px;font-size:1em;max-width:95vw;">
      <div style="margin-bottom:0.7em;"><b>Último ingreso</b></div>
      <div><b>Usuario:</b> <span id="admin-nombre"></span></div>
      <div><b>RUT:</b> <span id="admin-rut"></span></div>
      <div><b>Ingreso:</b> <span id="admin-fecha"></span></div>
      <hr style="margin:1em 0;">
      <div style="display:flex;align-items:center;gap:1em;">
        <div style="flex:1 1 auto;">
          <div style="font-weight:600;margin-bottom:0.3em;">Historial de ingresos</div>
          <div id="admin-historial" style="max-height:180px;overflow-y:auto;font-size:0.97em;margin-bottom:0.7em;">
          </div>
        </div>
        <button id="admin-btn"
          style="display:none;background:#1E7F4F;color:#fff;padding:0.7em 1.5em;border:none;border-radius:6px;cursor:pointer;font-weight:600;font-size:1em;z-index:4000;align-self:flex-start;">Administrador</button>
      </div>
      <button id="admin-eliminar-historial"
        style="background:#B00020;color:#fff;padding:0.4em 1em;border:none;border-radius:5px;cursor:pointer;margin-bottom:0.5em;">Eliminar
        historial</button>
      <button id="admin-cerrar"
        style="background:#888;color:#fff;padding:0.4em 1em;border:none;border-radius:5px;cursor:pointer;">Cerrar</button>
    </div>
    <button class="theme-toggle" id="theme-toggle" aria-label="Alternar tema claro/oscuro"
      title="Tema claro/oscuro">🌙</button>
    <button class="theme-toggle" id="config-toggle" aria-label="Abrir configuración" title="Configuración">⚙️</button>
    </div>
  </header>
  <!-- Modal para envío de reporte por Teams -->
  <div class="modal-overlay" id="modal-teams-report" style="display:none;z-index:3001;">
    <div class="modal-card" style="max-width:900px;">
      <div class="modal-header">
        <h2 style="margin:0; font-size:1.2em;">Envío de Reporte por Teams</h2>
        <button class="kpi-config-close" id="teams-report-close"
          style="position:static; color:#fff; font-size:1.5em; font-weight:bold; background:none; border:none; cursor:pointer;"
          title="Cerrar modal">&times;</button>
      </div>
      <div class="modal-body">
        <form id="teams-report-form">
          <div style="margin-bottom:1em;">
            <label style="font-weight:600;">Indicadores a incluir:</label><br>
            <label><input type="checkbox" name="indicadores" value="satisfaccion_snl" checked> Satisfacción
              SNL</label><br>
            <label><input type="checkbox" name="indicadores" value="resolucion_snl" checked> Resolución SNL</label><br>
            <label><input type="checkbox" name="indicadores" value="satisfaccion_ep" checked> Satisfacción
              EP</label><br>
            <label><input type="checkbox" name="indicadores" value="resolucion_ep" checked> Resolución EP</label><br>
            <label><input type="checkbox" name="indicadores" value="tmo" checked> TMO</label><br>
            <label><input type="checkbox" name="indicadores" value="epa" checked> Transferencia a EPA</label><br>
            <label><input type="checkbox" name="indicadores" value="tipificaciones" checked> Tipificaciones</label>
          </div>
          <div style="margin-bottom:1em;">
            <label style="font-weight:600;">Período del reporte:</label><br>
            <input type="date" id="teams-report-fecha-inicio" name="fecha_inicio"> a
            <input type="date" id="teams-report-fecha-fin" name="fecha_fin">
          </div>
          <div style="margin-bottom:1em;">
            <label style="font-weight:600;">Destino en Teams:</label><br>
            <input type="text" id="teams-report-destino" name="destino" placeholder="Canal, chat grupal o usuario(s)">
          </div>
          <div style="margin-bottom:1em;">
            <label style="font-weight:600;">Comentario opcional:</label><br>
            <textarea id="teams-report-comentario" name="comentario" style="width:100%;min-height:40px;"></textarea>
          </div>
          <div style="margin-bottom:1em;">
            <button type="submit" id="teams-report-generar"
              style="background:#2563eb;color:#fff;padding:0.6em 1.5em;border:none;border-radius:6px;cursor:pointer;font-weight:600;">Generar
              informe</button>
          </div>
          <div id="teams-report-preview" style="margin-top:1em;"></div>
          <button type="button" id="teams-report-copy"
            style="background:#00bfae;color:#fff;padding:0.5em 1.2em;border:none;border-radius:6px;cursor:pointer;font-weight:600;margin-top:0.7em;display:none;">📋
            Copiar para Team</button>
        </form>
      </div>
      <div class="modal-footer"
        style="padding:1.2em 1.5em; border-top:1px solid #ddd; display:flex; justify-content:flex-end;">
        <button type="button" class="kpi-config-reset" id="btn-teams-report-close-footer"
          style="background:#888; color:#fff; border:none; padding:0.6em 1.5em; border-radius:6px; cursor:pointer;">Cerrar</button>
      </div>
    </div>
  </div>
  <main id="dashboard-root">
    <script>
      // Abrir y cerrar modal de Teams
      document.getElementById('btn-teams-report').onclick = function () {
        document.getElementById('modal-teams-report').style.display = 'flex';
      };
      document.getElementById('teams-report-close').onclick = function () {
        document.getElementById('modal-teams-report').style.display = 'none';
      };
      document.getElementById('btn-teams-report-close-footer').onclick = function () {
        document.getElementById('modal-teams-report').style.display = 'none';
      };
      document.getElementById('teams-report-form').onsubmit = function (e) {
        // Definir ejemploDatos.tipificaciones si no existe
        if (typeof ejemploDatos === 'undefined') {
          window.ejemploDatos = { tipificaciones: { 'Motivo 1': 40, 'Motivo 2': 35, 'Motivo 3': 25 } };
        } else if (!ejemploDatos.tipificaciones) {
          ejemploDatos.tipificaciones = { 'Motivo 1': 40, 'Motivo 2': 35, 'Motivo 3': 25 };
        }
        e.preventDefault();
        // --- Configuración de umbrales por KPI ---
        const kpiConfig = {
          satisfaccion_snl: { nombre: 'Satisfacción SNL', tipo: '%', mejor_es_mayor: true, verde: 95, amarillo: 90, rojo: 90, defecto: true },
          resolucion_snl: { nombre: 'Resolución SNL', tipo: '%', mejor_es_mayor: true, verde: 90, amarillo: 85, rojo: 85, defecto: true },
          satisfaccion_ep: { nombre: 'Satisfacción EP', tipo: '%', mejor_es_mayor: true, verde: 95, amarillo: 90, rojo: 90, defecto: true },
          resolucion_ep: { nombre: 'Resolución EP', tipo: '%', mejor_es_mayor: true, verde: 90, amarillo: 85, rojo: 85, defecto: true },
          tmo: { nombre: 'TMO', tipo: 's', mejor_es_mayor: false, verde: 5, amarillo: 5, rojo: 5, defecto: true },
          epa: { nombre: 'Transferencia a EPA', tipo: '%', mejor_es_mayor: true, verde: 85, amarillo: 80, rojo: 80, defecto: true },
          tipificaciones: { nombre: 'Tipificaciones', tipo: '%', mejor_es_mayor: true, verde: 95, amarillo: 94, rojo: 80, defecto: true }
        };

        // --- Obtener entradas del usuario ---
        const form = e.target;
        const indicadores = Array.from(form.querySelectorAll('input[name="indicadores"]:checked')).map(i => i.value);
        const fechaInicio = form.fecha_inicio.value;
        const fechaFin = form.fecha_fin.value;
        const destino = form.destino.value;
        const comentario = form.comentario.value;

        // Log para depuración
        console.log('Indicadores seleccionados:', indicadores);
        console.log('Fecha inicio:', fechaInicio);
        console.log('Fecha fin:', fechaFin);
        console.log('Destino:', destino);
        console.log('Comentario:', comentario);

        // Validación visual rápida
        let validacion = '';
        if (!fechaInicio) validacion += '<div style="color:#B00020;font-weight:600;">⚠️ Falta seleccionar fecha de inicio</div>';
        if (!fechaFin) validacion += '<div style="color:#B00020;font-weight:600;">⚠️ Falta seleccionar fecha de fin</div>';
        if (!destino) validacion += '<div style="color:#B00020;font-weight:600;">⚠️ Falta ingresar destino en Teams</div>';
        if (indicadores.length === 0) validacion += '<div style="color:#B00020;font-weight:600;">⚠️ Selecciona al menos un indicador</div>';
        if (validacion) {
          document.getElementById('teams-report-preview').innerHTML = validacion;
          return;
        }

        // --- Ejecutivos y datos reales del panel ---
        const ejecutivos = [...new Set(evolutivoRawData.map(d => d.nombre))];

        // --- Lógica de semáforos y ordenación ---
        let criticos = [], mejores = [], otros = [];
        let listadoEjecutivos = '';
        let rankingEjecutivos = []; // Para calcular el top 3 basado en desempeño general

        ejecutivos.forEach(ej => {
          let glosa = [];
          let rowHtml = `<tr style="border-bottom:1px solid #eee;"><td style='padding:8px;font-weight:600;'>${ej}</td>`;
          let totalScore = 0;
          let kpiCount = 0;

          indicadores.forEach(kpi => {
            const cfg = kpiConfig[kpi];
            let valor = '';
            let valNum = 0;
            if (cfg.tipo === 'cat') {
              const motivos = {};
              evolutivoRawData.filter(d => d.nombre === ej).forEach(d => {
                Object.keys(d.tipificaciones || {}).forEach(m => {
                  motivos[m] = (motivos[m] || 0) + d.tipificaciones[m];
                });
              });
              const topMotivos = Object.entries(motivos).sort((a, b) => b[1] - a[1]).slice(0, 3);
              valor = topMotivos.map(([motivo, val]) => `${motivo}: ${val}`).join(', ');
              valNum = 0; // No suma al ranking numérico
            } else {
              const m = getMetrics(ej, kpi);
              valor = m ? m.last : 'Sin datos';
              valNum = m ? m.last : 0;

              // Calcular score para ranking (proximidad a la meta o superación)
              const metaVal = kpi === 'tmo' ? cfg.verde : cfg.verde; // Usamos umbral verde como referencia de éxito
              if (kpi === 'tmo') {
                totalScore += (metaVal / Math.max(valNum, 0.1)); // Menor TMO = Mayor Score
              } else {
                totalScore += (valNum / metaVal); // Mayor % = Mayor Score
              }
              kpiCount++;
            }

            let color = '🟢', estado = 'Verde';
            const valNumFloat = parseFloat(valor);

            // Determinar color y estado basado en reglas específicas
            if (valor === 'Sin datos') {
              color = '⚪'; estado = 'Sin datos';
            } else if (kpi === 'tmo') {
              if (valNumFloat <= 3) { color = '🟢'; estado = 'Verde'; }
              else if (valNumFloat <= 5) { color = '🟡'; estado = 'Amarillo'; }
              else { color = '🔴'; estado = 'Rojo'; }
            } else if (kpi === 'resolucion_snl' || kpi === 'resolucion_ep') {
              if (valNumFloat >= 90) { color = '🟢'; estado = 'Verde'; }
              else if (valNumFloat >= 80) { color = '🟡'; estado = 'Amarillo'; }
              else { color = '🔴'; estado = 'Rojo'; }
            } else if (kpi === 'epa' || kpi === 'transferencia_epa') {
              if (valNumFloat >= 85) { color = '🟢'; estado = 'Verde'; }
              else if (valNumFloat >= 70) { color = '🟡'; estado = 'Amarillo'; }
              else { color = '🔴'; estado = 'Rojo'; }
            } else if (kpi === 'tipificaciones' || kpi.includes('satisfaccion')) {
              if (valNumFloat >= 95) { color = '🟢'; estado = 'Verde'; }
              else if (valNumFloat >= 85) { color = '🟡'; estado = 'Amarillo'; }
              else { color = '🔴'; estado = 'Rojo'; }
            }

            if (color === '🔴') {
              glosa.push(`<span style="color:#B00020;">${cfg.nombre} bajo la meta</span>`);
            } else if (color === '🟡') {
              glosa.push(`<span style="color:#C79200;">${cfg.nombre} en riesgo</span>`);
              otros.push({ ej, kpi: cfg.nombre, valor, color });
            } else if (color === '🟢') {
              mejores.push({ ej, kpi: cfg.nombre, valor, color });
            }

            rowHtml += `<td style="padding:8px;text-align:center;">${color} ${valor}${cfg.tipo === '%' && valor !== 'Sin datos' ? '%' : ''}</td>`;
          });

          // Guardar puntaje promedio para el ranking
          rankingEjecutivos.push({ ej, score: kpiCount > 0 ? (totalScore / kpiCount) : 0 });

          const hasRed = glosa.some(g => g.includes('#B00020'));
          const glosaFinal = glosa.length > 0
            ? `<td style="padding:12px 8px;font-size:0.85em;font-weight:600;">${hasRed ? '🚨' : '⚠️'} ${glosa.join('; ')}</td>`
            : `<td style="padding:12px 8px;color:#2e7d32;font-size:0.85em;font-weight:600;">✅ Cumple metas</td>`;

          listadoEjecutivos += rowHtml + glosaFinal + `</tr>`;
        });

        let html = `<div id="teams-report-content" style='font-family:Segoe UI,Helvetica,Arial,sans-serif; width:700px; margin:auto; padding:25px; background:#ffffff; border:1px solid #e1e4e8; border-radius:12px;'>`;

        // Header "Premium"
        html += `<div style="background:#1e40af; margin:-25px -25px 20px -25px; padding:20px 25px; border-radius:12px 12px 0 0; display:flex; justify-content:space-between; align-items:center;">`;
        html += `  <h2 style="color:#ffffff; margin:0; font-size:1.4em; letter-spacing:0.5px;">Reporte de Desempeño Operacional</h2>`;
        html += `  <div style="color:rgba(255,255,255,0.8); font-size:0.85em; text-align:right;">${new Date().toLocaleDateString()}</div>`;
        html += `</div>`;

        html += `<div style='font-size:0.95em; color:#4b5563; margin-bottom:20px; line-height:1.5;'>`;
        html += `<b>📍 Período:</b> ${fechaInicio || 'Actual'} al ${fechaFin || 'Actual'}<br>`;
        html += `<b>🎯 Destino:</b> ${destino || 'Canal General'}`;
        if (comentario) {
          html += `<div style="margin-top:12px; padding:12px; background:#f3f4f6; border-left:4px solid #1e40af; border-radius:4px; color:#1f2937; font-style:italic;">"${comentario}"</div>`;
        }
        html += `</div>`;

        // --- Alertas Críticas (Resumen superior) ---
        if (criticos.length > 0) {
          html += `<div style="background:#fff1f2; border:1px solid #fda4af; padding:15px; border-radius:8px; margin-bottom:20px; box-shadow:0 2px 4px rgba(0,0,0,0.02);">`;
          html += `<h3 style="color:#be123c; margin-top:0; margin-bottom:10px; font-size:1.05em; display:flex; align-items:center; gap:8px;">🚨 Foco de Atención Inmediata</h3>`;
          html += `<div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; font-size:0.9em;">`;
          const uniquesCrit = [...new Set(criticos.map(c => c.ej))].slice(0, 4);
          uniquesCrit.forEach(name => {
            const kpis = criticos.filter(c => c.ej === name).map(c => c.kpi).join(', ');
            html += `<div style="background:rgba(255,255,255,0.5); padding:8px; border-radius:4px; border-left:3px solid #be123c;"><b>${name}</b>: ${kpis}</div>`;
          });
          html += `</div></div>`;
        }

        // --- TABLA DETALLADA ---
        html += `<h3 style="color:#1e2937; font-size:1.1em; margin-bottom:10px;">📊 Detalle Individual por Indicador</h3>`;
        html += `<div style='border:1px solid #e1e4e8; border-radius:10px; overflow:hidden; margin:10px 0; box-shadow:0 1px 3px rgba(0,0,0,0.05);'>`;
        html += `<table style='border-collapse:collapse;width:100%;font-size:0.9em;'>`;
        html += `<thead style="background:#f8fafc; color:#475569; border-bottom:2px solid #e1e4e8;"><tr>`;
        html += `<th style="padding:12px; text-align:left; font-weight:700;">Ejecutivo</th>`;
        indicadores.forEach(kpi => { html += `<th style="padding:12px; text-align:center; font-weight:700;">${kpiConfig[kpi].nombre}</th>` });
        html += `<th style="padding:12px; text-align:left; font-weight:700;">Estado / Glosa</th></tr></thead>`;
        html += `<tbody>${listadoEjecutivos}</tbody>`;
        html += `</table></div>`;

        // --- Destacados y Críticos en Grid ---
        html += `<div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-top:20px;">`;

        // Columna Destacados
        const topRanking = rankingEjecutivos.sort((a, b) => b.score - a.score).slice(0, 3);
        if (topRanking.length) {
          html += `<div style="padding:15px; background:#f0fdf4; border:1px solid #bbf7d0; border-radius:8px;">`;
          html += `<h4 style='color:#166534; margin:0 0 10px 0; font-size:1em;'>🌟 Top Desempeño</h4>`;
          html += `<ul style="margin:0; padding-left:18px; font-size:0.85em; color:#14532d; line-height:1.4;">`;
          topRanking.forEach(item => {
            const hasDeviation = criticos.some(c => c.ej === item.ej) || otros.some(o => o.ej === item.ej);
            html += `<li style="margin-bottom:4px;"><b>${item.ej}</b>: ${hasDeviation ? 'Líder en KPIs' : 'Cumplimiento 100%'}</li>`;
          });
          html += `</ul></div>`;
        }

        // Columna Críticos
        const btmRanking = rankingEjecutivos.sort((a, b) => a.score - b.score).filter(item => {
          return criticos.some(c => c.ej === item.ej) || otros.some(o => o.ej === item.ej);
        }).slice(0, 3);

        if (btmRanking.length) {
          html += `<div style="padding:15px; background:#fff1f2; border:1px solid #fecaca; border-radius:8px;">`;
          html += `<h4 style='color:#991b1b; margin:0 0 10px 0; font-size:1em;'>📉 Oportunidades</h4>`;
          html += `<ul style="margin:0; padding-left:18px; font-size:0.85em; color:#7f1d1d; line-height:1.4;">`;
          btmRanking.forEach(item => {
            const misCriticos = criticos.filter(c => c.ej === item.ej).map(c => c.kpi).slice(0, 2).join(', ');
            html += `<li style="margin-bottom:4px;"><b>${item.ej}</b>: Refuerzo en ${misCriticos || 'KPIs en riesgo'}</li>`;
          });
          html += `</ul></div>`;
        }
        html += `</div>`;

        // --- Pie de informe ---
        html += `<div style='font-size:0.8em; color:#9ca3af; margin-top:25px; text-align:center; border-top:1px solid #f3f4f6; padding-top:15px;'>`;
        html += `ACHS • Panel de Control Operacional • v2.1`;
        html += `</div></div>`; // Cierra teams-report-content

        // Versión texto plano (fuera del contenedor capturable)
        html += `<div style='margin-top:20px; font-size:0.85em; color:#4b5563; background:#f9fafb; padding:15px; border-radius:8px; border:1px dashed #d1d5db;'>`;
        html += `<b style="color:#1e40af;">📋 Versión Texto Rápido:</b><br>`;
        const resumenTexto = [...new Set(criticos.map(c => `❌ ${c.ej}`))].concat([...new Set(mejores.map(m => `✅ ${m.ej}`))]).slice(0, 8).join(' | ');
        html += `<code style="display:block; margin-top:8px; padding:8px; background:#fff; border:1px solid #e1e4e8; border-radius:4px;">${resumenTexto}</code>`;
        html += `</div>`;

        document.getElementById('teams-report-preview').innerHTML = html;

        document.getElementById('teams-report-preview').innerHTML = html;
        // Habilitar el botón de copiar
        document.getElementById('teams-report-copy').style.display = 'inline-block';
        // Botón copiar para Team
        document.getElementById('teams-report-copy').onclick = function () {
          // Capturar el contenedor principal del reporte
          const recuadro = document.getElementById('teams-report-content');
          if (!recuadro) {
            console.error('No se encontró el contenido del reporte');
            return;
          }

          // Función para realizar la copia
          const processCopy = () => {
            document.getElementById('teams-report-copy').innerText = 'Generando imagen...';
            window.html2canvas(recuadro, {
              backgroundColor: '#ffffff',
              scale: 3,
              useCORS: true,
              logging: false
            }).then(canvas => {
              canvas.toBlob(blob => {
                if (navigator.clipboard && window.ClipboardItem) {
                  navigator.clipboard.write([
                    new window.ClipboardItem({ 'image/png': blob })
                  ]).then(() => {
                    document.getElementById('teams-report-copy').innerText = '¡Imagen copiada!';
                    setTimeout(() => {
                      document.getElementById('teams-report-copy').innerText = '📋 Copiar para Team';
                    }, 2000);
                  }).catch(err => {
                    console.error('Error al copiar:', err);
                    document.getElementById('teams-report-copy').innerText = 'Error al copiar';
                  });
                } else {
                  // Fallback: Si no soporta Clipboard API con imágenes, intentar abrir en nueva pestaña para que el usuario copie
                  const imgUrl = canvas.toDataURL('image/png');
                  const win = window.open();
                  win.document.write('<img src="' + imgUrl + '" />');
                  document.getElementById('teams-report-copy').innerText = 'Copiado (ver ventana)';
                }
              }, 'image/png');
            }).catch(err => {
              console.error('Error html2canvas:', err);
              document.getElementById('teams-report-copy').innerText = 'Error técnico';
            });
          };

          // Cargar html2canvas dinámicamente si no está presente
          if (!window.html2canvas) {
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js';
            script.onload = processCopy;
            document.head.appendChild(script);
          } else {
            processCopy();
          }
        };
      };
    </script>
    <section style="display:flex;align-items:center;gap:1.5em;margin-bottom:1.2em;">
      <button id="btn-mostrar-todos"
        style="padding:0.5em 1.2em;font-size:1em;border-radius:8px;background:#2563eb;color:#fff;border:none;cursor:pointer;">Mostrar
        todos</button>
      <label for="filtro-ejecutivo" style="font-weight:500;">Filtrar por ejecutivo:</label>
      <select id="filtro-ejecutivo" style="font-size:1em;padding:0.4em 1em;border-radius:6px;border:1px solid #bbb;">
        <option value="">Todos</option>
      </select>
    </section>
    <!-- El tablero se renderiza aquí -->
  </main>
  <aside class="kpi-config-panel" id="config-panel" aria-label="Panel de configuración" tabindex="-1">
    <button class="kpi-config-close" id="config-close" aria-label="Cerrar configuración">×</button>
    <div class="kpi-config-title">Configuración del Tablero</div>
    <form class="kpi-config-form" id="config-form" autocomplete="off">
      <div class="kpi-config-row">
        <label for="meta-tipificaciones">Meta Tipificaciones (%)</label>
        <input type="number" id="meta-tipificaciones" name="meta-tipificaciones" min="0" max="100" step="0.1" required>
      </div>
      <div class="kpi-config-row">
        <label for="meta-epa">Meta EPA (%)</label>
        <input type="number" id="meta-epa" name="meta-epa" min="0" max="100" step="0.1" required>
      </div>
      <div class="kpi-config-row">
        <label for="meta-tmo">Meta TMO (min)</label>
        <input type="number" id="meta-tmo" name="meta-tmo" min="0" max="60" step="0.01" required>
      </div>
      <div class="kpi-config-row">
        <label for="deviation-method">Método de desviación</label>
        <select id="deviation-method" name="deviation-method">
          <option value="relativa">Relativa</option>
          <option value="absoluta">Absoluta</option>
        </select>
      </div>
      <div class="kpi-config-row">
        <label for="color-green">Umbral Verde (%)</label>
        <input type="number" id="color-green" name="color-green" min="0" max="100" step="0.1">
      </div>
      <div class="kpi-config-row">
        <label for="color-amber">Umbral Ámbar (%)</label>
        <input type="number" id="color-amber" name="color-amber" min="0" max="100" step="0.1">
      </div>
      <div class="kpi-config-row">
        <label for="date-range">Rango de fechas</label>
        <input type="text" id="date-range" name="date-range" placeholder="YYYY-MM-DD a YYYY-MM-DD">
      </div>
      <div class="kpi-config-row">
        <label for="kpi-focus">KPI focalizado</label>
        <select id="kpi-focus" name="kpi-focus">
          <option value="tipificaciones">Tipificaciones</option>
          <option value="epa">EPA</option>
          <option value="tmo">TMO</option>
        </select>
      </div>
      <div class="kpi-config-actions">
        <button type="submit">Aplicar</button>
        <button type="button" class="kpi-config-reset" id="config-reset">Restablecer</button>
      </div>
    </form>
  </aside>
  <aside class="evolutivo-panel" id="evolutivo-panel">
    <div class="evolutivo-header">
      <h2 style="margin:0; font-size:1.2em;">Análisis Evolutivo (90 días)</h2>
      <button class="kpi-config-close" id="evolutivo-close" style="position:static; color:#fff;">×</button>
    </div>
    <div class="evolutivo-content">
      <div
        style="padding: 1em 1.5em; background: var(--kpi-card-bg); border-bottom: 1px solid var(--kpi-line); font-size: 0.85em;">
        <div style="font-weight:600; margin-bottom:0.5em; color:var(--achs-secondary);">Referencia de Niveles:</div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:0.5em;">
          <div style="display:flex; align-items:center; gap:0.4em;"><span class="status-badge status-gold"
              style="font-size:0.65em; padding:2px 6px;">GOLD</span> <span style="font-size:0.85em;">Excelencia (Brecha
              0)</span></div>
          <div style="display:flex; align-items:center; gap:0.4em;"><span class="status-badge status-silver"
              style="font-size:0.65em; padding:2px 6px;">SILVER</span> <span
              style="font-size:0.85em;">Cumplimiento</span></div>
          <div style="display:flex; align-items:center; gap:0.4em;"><span class="status-badge status-bronze"
              style="font-size:0.65em; padding:2px 6px;">BRONZE</span> <span style="font-size:0.85em;">Brecha
              Leve</span></div>
          <div style="display:flex; align-items:center; gap:0.4em;"><span class="status-badge status-critical"
              style="font-size:0.65em; padding:2px 6px;">CRITICAL</span> <span style="font-size:0.85em;">Riesgo
              Alto</span></div>
        </div>
      </div>
      <div class="evolutivo-filter">
        <label for="evolutivo-search" style="font-weight:600; font-size:0.9em;">Buscar Ejecutivo:</label>
        <input type="text" id="evolutivo-search" placeholder="Escribe un nombre..."
          style="width:100%; padding:0.6em; border-radius:6px; border:1px solid var(--kpi-line); background: var(--kpi-card-bg); color: var(--kpi-text);">
      </div>

      <div class="evolutivo-exec-list" id="evolutivo-exec-list">
        <!-- Generado por JS -->
      </div>

      <div id="evolutivo-detail" style="display:none;">
        <h3 id="evolutivo-detail-name" style="margin-bottom:0.2em;">Nombre del Ejecutivo</h3>

        <div class="evolutivo-tabs" id="evolutivo-kpi-tabs"
          style="display:flex; gap:0.5em; margin-bottom:1em; overflow-x:auto; padding-bottom:5px;">
          <button class="kpi-tab active" data-kpi="satisfaccion_snl">Satisf. SNL</button>
          <button class="kpi-tab" data-kpi="resolucion_snl">Resol. SNL</button>
          <button class="kpi-tab" data-kpi="satisfaccion_ep">Satisf. EP</button>
          <button class="kpi-tab" data-kpi="resolucion_ep">Resol. EP</button>
          <button class="kpi-tab" data-kpi="tmo">TMO</button>
          <button class="kpi-tab" data-kpi="epa">Transf. EPA</button>
          <button class="kpi-tab" data-kpi="tipificaciones">Tipif.</button>
        </div>

        <div id="evolutivo-detail-trend" style="margin-bottom:1em;"></div>

        <div class="evolutivo-chart-container">
          <canvas id="evolutivo-chart"></canvas>
        </div>

        <div class="meta-summary-grid">
          <div class="meta-item"><span class="label">Último Mes</span><span class="value" id="ev-val-last">-</span>
          </div>
          <div class="meta-item"><span class="label">Promedio 3 meses</span><span class="value" id="ev-val-avg">-</span>
          </div>
          <div class="meta-item"><span class="label">Mejor Mes</span><span class="value" id="ev-val-max">-</span>
          </div>
          <div class="meta-item"><span class="label">Variación Periodo</span><span class="value"
              id="ev-val-diff">-</span></div>
        </div>

        <div class="action-plan-card" id="ev-action-plan">
          <!-- Generado por JS -->
        </div>
        <div id="ev-feedback-ficha" style="margin-top:24px; display:none;">
          <div
            style="background:#fff; border-radius:12px; box-shadow:0 2px 8px rgba(44,62,80,0.07); padding:24px 28px; border:1px solid #CFD8DC; max-width:600px; margin:auto;">
            <div
              style="display:flex; align-items:center; justify-content:space-between; border-bottom:2px solid #2E7D32; padding-bottom:10px; margin-bottom:16px;">
              <span style='font-size:1.3em; font-weight:700; color:#2E7D32;'>ACHS SNL-EP</span>
              <span style='font-size:1.1em; font-weight:600; color:#607d8b;'>Ficha de Feedback</span>
              <span id="ev-feedback-ficha-date" style="font-size:1em; color:#607d8b;"></span>
            </div>
            <div style="margin-bottom:12px;"><b>Nombre:</b> <span id="ev-feedback-ficha-nombre"></span></div>
            <div style="margin-bottom:12px;"><b>Indicador:</b> <span id="ev-feedback-ficha-kpi"></span></div>
            <div style="margin-bottom:12px;"><b>Actual:</b> <span id="ev-feedback-ficha-actual"></span> &nbsp;
              <b>Meta:</b> <span id="ev-feedback-ficha-meta"></span>
            </div>
            <div style="margin-bottom:12px;"><b>Diagnóstico:</b> <span id="ev-feedback-ficha-diagnostico"></span></div>
            <div style="margin-bottom:12px;"><b>Compromisos:</b>
              <textarea id="ev-feedback-ficha-compromisos"
                style="width:100%;min-height:40px;resize:vertical;border:1px solid #B0BEC5;border-radius:5px;margin-top:4px;padding:6px;font-size:1em;"></textarea>
            </div>
            <div style="display:flex; justify-content:space-between; margin-top:24px;">
              <div style="width:45%; border-top:1px solid #263238; text-align:center; padding-top:8px; color:#607d8b;">
                Firma Ejecutivo</div>
              <div style="width:45%; border-top:1px solid #263238; text-align:center; padding-top:8px; color:#607d8b;">
                Firma Supervisor</div>
            </div>
            <div style="text-align:right; margin-top:18px;">
              <button id="btn-imprimir-ficha"
                style="background:var(--achs-primary);color:white;border:none;padding:7px 16px;border-radius:6px;cursor:pointer;font-size:1em;">
                🖨️ Imprimir Ficha
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="evolutivo-empty" class="kpi-empty-state">
      Selecciona un ejecutivo para ver su tendencia
    </div>
    </div>
  </aside>

  <!-- --- MODALES MANTENEDOR --- -->

  <!-- Modal Historial -->
  <div class="modal-overlay" id="modal-historial">
    <div class="modal-card">
      <div class="modal-header">
        <h2 style="margin:0; font-size:1.2em;">Historial de Métricas</h2>
        <button class="kpi-config-close" id="historial-close" style="position:static; color:#fff;">×</button>
      </div>
      <div class="modal-body">
        <div class="maintainer-tabs" id="historial-tabs">
          <!-- Generado por JS: 7 pestañas -->
        </div>
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1em;">
          <input type="text" id="historial-search" placeholder="Filtrar por nombre..."
            style="padding:0.5em; border-radius:6px; border:1px solid var(--kpi-line); width:250px;">
          <div style="font-size:0.9em; color:#777;">Recalculando promedios automáticamente</div>
        </div>
        <div style="overflow-x:auto; max-height:50vh;">
          <table class="kpi-table editable-table" id="table-historial">
            <thead>
              <tr>
                <th style="text-align:left;">EJECUTIVO</th>
                <th id="th-m1">MES 1</th>
                <th id="th-m2">MES 2</th>
                <th id="th-m3">MES 3</th>
                <th id="th-m4">MES 4</th>
                <th id="th-m5">MES 5</th>
                <th>Promedio</th>
                <th style="width: 50px;">🗑️</th>
              </tr>
            </thead>
            <tbody id="historial-tbody">
              <!-- Generado por JS -->
            </tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" id="btn-export-permanente"
          style="background:var(--achs-secondary); color:var(--achs-neutral-text); border:none; padding:0.6em 1.5em; border-radius:6px; cursor:pointer; font-weight:600;"
          title="Descargar una versiÃ³n del archivo con estos datos guardados fÃ­sicamente">ðŸ’¾ Guardar en
          Programa</button>
        <button type="button" id="btn-historial-save"
          style="background:var(--achs-primary); color:#fff; border:none; padding:0.6em 1.5em; border-radius:6px; cursor:pointer;">Guardar
          Cambios</button>
        <button type="button" class="kpi-config-reset" id="btn-historial-close">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- Modal Actualizar -->
  <div class="modal-overlay" id="modal-actualizar">
    <div class="modal-card" style="max-width:900px;">
      <div class="modal-header">
        <h2 style="margin:0; font-size:1.2em;">Actualizar desde Excel</h2>
        <button class="kpi-config-close" id="actualizar-close" style="position:static; color:#fff;">×</button>
      </div>
      <div class="modal-body">
        <div class="import-area">
          <div class="import-controls">
            <label style="font-weight:600; font-size:0.9em;">1. Métrica a actualizar:</label>
            <select id="import-metric" style="padding:0.5em; border-radius:6px; border:1px solid var(--kpi-line);">
              <!-- Generado por JS -->
            </select>

            <label style="font-weight:600; font-size:0.9em; margin-top:1em;">2. Formato de pegado:</label>
            <div style="display:flex; flex-direction:column; gap:0.5em;">
              <label style="font-weight:400; font-size:0.85em;"><input type="radio" name="import-format" value="4cols"
                  checked> Ejecutivo, Septiembre, Octubre, Noviembre, Diciembre, Enero</label>
              <label style="font-weight:400; font-size:0.85em;"><input type="radio" name="import-format" value="2cols">
                Ejecutivo, Valor (un solo mes)</label>
            </div>

            <div id="import-month-select" style="display:none; margin-left:1.5em; flex-direction:column; gap:0.3em;">
              <label style="font-weight:400; font-size:0.8em;"><input type="radio" name="target-month" value="m1"> <span
                  id="label-m1">Septiembre</span></label>
              <label style="font-weight:400; font-size:0.8em;"><input type="radio" name="target-month" value="m2"> <span
                  id="label-m2">Octubre</span></label>
              <label style="font-weight:400; font-size:0.8em;"><input type="radio" name="target-month" value="m3"> <span
                  id="label-m3">Noviembre</span></label>
              <label style="font-weight:400; font-size:0.8em;"><input type="radio" name="target-month" value="m4"> <span
                  id="label-m4">Diciembre</span></label>
              <label style="font-weight:400; font-size:0.8em;"><input type="radio" name="target-month" value="m5"
                  checked> <span id="label-m5">Enero</span></label>
            </div>

            <button id="btn-download-tpl"
              style="margin-top:auto; padding:0.6em; border-radius:6px; border:1px solid var(--achs-primary); background:transparent; color:var(--achs-primary); cursor:pointer; font-size:0.85em;">📥
              Descargar Plantilla</button>
          </div>
          <div style="display:flex; flex-direction:column;">
            <label style="font-weight:600; font-size:0.9em; margin-bottom:0.5em;">3. Pegar datos aquí (Excel):</label>
            <textarea id="import-input" class="import-paste-area" placeholder="Ejecutivo	10	20	30..."></textarea>
          </div>
        </div>

        <div id="import-preview-container"
          style="display:none; margin-top:1.5em; border-top:1px solid var(--kpi-line); padding-top:1em;">
          <h4 style="margin:0 0 0.5em 0;">Vista previa de mapeo</h4>
          <div id="import-summary" style="font-size:0.85em; margin-bottom:0.8em;"></div>
          <div class="preview-list" id="import-preview-list">
            <!-- Filas generadas por JS -->
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="kpi-config-reset" id="btn-actualizar-cancel">Cancelar</button>
        <button type="button" id="btn-actualizar-apply" disabled
          style="background:#bdbdbd; color:#fff; border:none; padding:0.6em 1.5em; border-radius:6px; cursor:not-allowed;">Reemplazar
          Datos</button>
      </div>
    </div>
  </div>

  <!-- Modal Guion EPA -->
  <div id="modal-guion-epa" class="modal-overlay">
    <div class="modal-card" style="max-width: 800px;">
      <div class="modal-header">
        <h3>Guion de Transferencia a EPA</h3>
        <button class="kpi-modal-close" onclick="closeGuionEpa()" aria-label="Cerrar modal"
          style="background:transparent; border:none; color:white; font-size:1.5em; cursor:pointer;">&times;</button>
      </div>
      <div class="modal-body" style="line-height: 1.6;">
        <!-- 1) Resumen Ejecutivo (desplegable) -->
        <details class="epa-resumen" style="margin-bottom:0.6em;">
          <summary style="color:var(--achs-secondary); font-weight:700; cursor:pointer;">1. Resumen Ejecutivo ▸
          </summary>
          <div style="margin-top:0.5em;">
            <p style="font-size:0.9em; margin-bottom:1em;">
              Este guion estandariza el proceso de transferencia a la encuesta para asegurar que el paciente no corte.
              <strong>Objetivo:</strong> Maximizar la representatividad de los datos (EPA) y detectar brechas reales.
            </p>
          </div>
        </details>

        <!-- 2) Frase Obligatoria (desplegable) -->
        <details class="epa-frase" style="margin-bottom:0.6em;">
          <summary style="color:var(--achs-secondary); font-weight:700; cursor:pointer;">2. Frase Obligatoria ▸
          </summary>
          <div style="margin-top:0.5em;">
            <div class="mandatory-phrase"
              style="background-color: #fff3e0; border-left: 5px solid #ff9800; padding: 15px; font-weight: bold; font-size: 1.1em; margin: 10px 0; color: #333;">
              por favor no me corte por que TIENE que evaluar mi atención, la nota máxima es un 7 y son solo dos
              preguntas.
            </div>
          </div>
        </details>

        <!-- 3) Flujo del Agente (desplegable) -->
        <details class="epa-flujo" style="margin-bottom:0.6em;">
          <summary style="color:var(--achs-secondary); font-weight:700; cursor:pointer;">3. Flujo del Agente ▸</summary>
          <div style="margin-top:0.5em;">
            <ol style="margin-bottom:1em;">
              <li><strong>Comprobación:</strong> Verificar que la solicitud fue resuelta.</li>
              <li><strong>Invitación:</strong> Usar frase clave.</li>
              <li><strong>Confirmación:</strong> Asegurar que el paciente entiende que no debe cortar.</li>
              <li><strong>Transferencia:</strong> Ejecutar transferencia a IVR.</li>
            </ol>
          </div>
        </details>

        <!-- 4) Manejo de Objeciones (desplegable) -->
        <details class="epa-objeciones" style="margin-bottom:0.6em;">
          <summary style="color:var(--achs-secondary); font-weight:700; cursor:pointer;">4. Manejo de Objeciones ▸
          </summary>
          <div style="margin-top:0.5em;">
            <details style="background:var(--kpi-table-bg); padding:10px; margin-bottom:5px; border-radius:4px;">
              <summary style="cursor:pointer; font-weight:bold; color:var(--achs-primary);">Escenario 1: "No tengo
                tiempo"</summary>
              <p style="margin:5px 0 0 0;">Comprendo, son <strong>solo dos preguntas y menos de un minuto</strong>. Si
                pudiera ayudarnos, su nota máxima 7 es vital para mí. Por favor no corte.</p>
            </details>
            <details style="background:var(--kpi-table-bg); padding:10px; margin-bottom:5px; border-radius:4px;">
              <summary style="cursor:pointer; font-weight:bold; color:var(--achs-primary);">Escenario 2: "¿Para qué
                sirve?"</summary>
              <p style="margin:5px 0 0 0;">Su evaluación nos permite corregir errores y asegurarnos de que la próxima
                vez
                que nos llame, su atención sea aún más rápida y efectiva.</p>
            </details>
            <details style="background:var(--kpi-table-bg); padding:10px; margin-bottom:5px; border-radius:4px;">
              <summary style="cursor:pointer; font-weight:bold; color:var(--achs-primary);">Escenario 3: "Prefiero
                después"</summary>
              <p style="margin:5px 0 0 0;">Lamentablemente la encuesta es automática al finalizar esta llamada. Si
                pudiera
                regalarme 30 segundos ahora, se lo agradecería mucho. Solo no corte la llamada.</p>
            </details>
          </div>
        </details>

        <!-- 5) Ejemplos de Interacción (desplegable) -->
        <details class="epa-ejemplos" style="margin-bottom:0.6em;">
          <summary style="color:var(--achs-secondary); font-weight:700; cursor:pointer;">5. Ejemplos de Interacción ▸
          </summary>
          <div style="margin-top:0.5em;">
            <div
              style="background:var(--kpi-bg); padding:10px; border-left:4px solid var(--achs-primary); margin-bottom:10px;">
              <em>Acepta de inmediato:</em><br>
              <strong>Agente:</strong> Hemos cursado su solicitud. Antes de irnos, <strong>por favor no me corte por que
                TIENE que evaluar mi atención...</strong><br>
              <strong>Paciente:</strong> Bueno, está bien.<br>
              <span style="font-size:0.85em; color:#666;">(Refuerza la cooperación y la instrucción clave
                rápidamente)</span>
            </div>
            <div
              style="background:var(--kpi-bg); padding:10px; border-left:4px solid var(--achs-primary); margin-bottom:10px;">
              <em>Duda por tiempo:</em><br>
              <strong>Agente:</strong> ¿Nos ayuda con una encuesta rápida?<br>
              <strong>Paciente:</strong> Uy, es que estoy apurado...<br>
              <strong>Agente:</strong> Es muy breve, menos de un minuto. <strong>Por favor no me corte...</strong>
            </div>
          </div>
        </details>

        <!-- 6) Proceso de Transferencia (desplegable) -->
        <details class="epa-transferencia" style="margin-bottom:0.6em;">
          <summary style="color:var(--achs-secondary); font-weight:700; cursor:pointer;">6. Proceso de Transferencia ▸
          </summary>
          <div style="margin-top:0.5em;">
            <div style="background:var(--kpi-table-bg); padding:10px; border-radius:4px; margin-bottom:1em;">
              <p style="margin:0 0 5px 0;"><strong>Agente dice:</strong> "Lo estoy transfiriendo a la encuesta ahora.
                <strong>Recuerde no cortar la llamada</strong>, el sistema le hablará automáticamente. ¡Gracias!"
              </p>
              <p style="margin:0; font-style:italic; color:#666;"><strong>Paciente escucha:</strong> "Bienvenido a la
                encuesta de satisfacción ACHS. Usando su teclado, califique de 1 a 7..."</p>
            </div>
          </div>
        </details>

        <!-- 7) Mejores Prácticas (Do & Don't) (desplegable) -->
        <details class="epa-practicas" style="margin-bottom:0.6em;">
          <summary style="color:var(--achs-secondary); font-weight:700; cursor:pointer;">7. Mejores Prácticas (Do &
            Don't) ▸</summary>
          <div style="margin-top:0.5em;">
            <table style="width:100%; border-collapse:collapse; font-size:0.9em; margin-bottom:1em;">
              <thead>
                <tr>
                  <th
                    style="border-bottom:3px solid #4caf50; text-align:left; padding:5px; background:var(--kpi-table-bg);">
                    ✅
                    DO (Hacer)</th>
                  <th
                    style="border-bottom:3px solid #f44336; text-align:left; padding:5px; background:var(--kpi-table-bg);">
                    ❌
                    DON'T (Evitar)</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td style="padding:5px; border-bottom:1px solid var(--kpi-line);"><strong>Claridad:</strong> Mencionar
                    "2
                    preguntas" y "nota máx 7".</td>
                  <td style="padding:5px; border-bottom:1px solid var(--kpi-line);"><strong>Soborno:</strong> Prometer
                    beneficios por buena nota.</td>
                </tr>
                <tr>
                  <td style="padding:5px; border-bottom:1px solid var(--kpi-line);"><strong>Empatía:</strong> Agradecer
                    el
                    tiempo.</td>
                  <td style="padding:5px; border-bottom:1px solid var(--kpi-line);"><strong>Tecnicismos:</strong> Decir
                    "transferencia al IVR".</td>
                </tr>
                <tr>
                  <td style="padding:5px; border-bottom:1px solid var(--kpi-line);"><strong>Instrucción:</strong>
                    Recordar
                    "no corte".</td>
                  <td style="padding:5px; border-bottom:1px solid var(--kpi-line);"><strong>Coerción:</strong> Presionar
                    ante un "No" rotundo.</td>
                </tr>
              </tbody>
            </table>
          </div>
        </details>

        <!-- 8) Métricas de Éxito (desplegable) -->
        <details class="epa-metricas" style="margin-bottom:0.6em;">
          <summary style="color:var(--achs-secondary); font-weight:700; cursor:pointer;">8. Métricas de Éxito ▸
          </summary>
          <div style="margin-top:0.5em;">
            <ul style="font-size:0.9em; margin-bottom:0;">
              <li><strong>Tasa de Invitación:</strong> % de llamadas con guion verbalizado.</li>
              <li><strong>Tasa de Permanencia:</strong> % de pacientes que esperan transferencia.</li>
              <li><strong>Tasa de Finalización:</strong> % de encuestas terminadas (P1 y P2).</li>
            </ul>
          </div>
        </details>

        <!-- 9) Durante la llamada: frases, tips y control (desplegable) -->
        <details class="epa-durante-llamada" style="margin-bottom:1em;">
          <summary style="color:var(--achs-secondary); font-weight:700; cursor:pointer; padding:6px 0;">9. Durante la
            llamada ▸</summary>
          <div style="font-size:0.95em; margin-top:0.5em;">
            <p><strong>📞 Durante la llamada</strong></p>
            <ul style="margin-top:0.25em;">
              <li><strong>Saludo cordial y profesional:</strong> Usa el nombre del cliente si lo tienes.</li>
              <li><strong>Escucha activa:</strong> No interrumpas, confirma que entendiste ("Entonces, lo que necesita
                es…").</li>
              <li><strong>Tono amable y seguro:</strong> Evita sonar apurado o robótico.</li>
              <li><strong>Lenguaje claro y positivo:</strong> Sustituye "No puedo" por "Lo que sí puedo hacer es…".</li>
              <li><strong>Empatía ante problemas:</strong> Frases como "Entiendo su situación" generan confianza.</li>
              <li><strong>Evita silencios largos:</strong> Si necesitas tiempo, informa ("Permítame un momento mientras
                reviso…").</li>
              <li><strong>Cumple protocolos de calidad:</strong> Verifica datos, explica procesos y confirma acuerdos.
              </li>
            </ul>

            <p style="margin-top:0.6em;"><strong>🔍 Tips extra para mejorar la experiencia</strong></p>
            <ul>
              <li>Sonríe mientras hablas: se percibe en el tono.</li>
              <li>Evita tecnicismos: usa palabras simples.</li>
              <li>Controla el ritmo: ni muy rápido ni muy lento.</li>
              <li>Cumple tiempos de respuesta: reduce espera y transferencias innecesarias.</li>
            </ul>

            <p style="margin-top:0.6em;"><strong>💡 Tips Avanzados</strong></p>
            <ul>
              <li>Escucha activa + reformulación: "Entonces, lo que necesita es… ¿correcto?"</li>
              <li>Ofrecer soluciones claras: evita respuestas ambiguas.</li>
              <li>Control emocional del agente: mantén calma ante clientes difíciles.</li>
            </ul>

            <p style="margin-top:0.6em;"><strong>💡 Ofrecer soluciones</strong></p>
            <ul>
              <li>Lenguaje positivo: "Lo que sí puedo hacer por usted es…"</li>
              <li>Evitar tecnicismos: "Vamos a resolverlo paso a paso, de manera sencilla."</li>
            </ul>

            <p style="margin-top:0.6em;"><strong>🔍 Control de la llamada</strong></p>
            <ul>
              <li>Mantener informado: "Permítame un momento mientras reviso la información, estaré con usted enseguida."
              </li>
              <li>Evitar silencios incómodos: "Estoy validando los datos para darle la mejor respuesta."</li>
            </ul>

            <p style="margin-top:0.6em;"><strong>✅ Cuando hay quiebre en la conexión</strong></p>
            <ul>
              <li>"Parece que la conexión se interrumpió, permítame verificar y asegurar que su cita quede confirmada."
              </li>
              <li>"No se preocupe, estoy revisando para que no pierda su hora médica."</li>
              <li>"Si la conexión falla, puedo enviarle la confirmación por correo, ¿le parece?"</li>
              <li>"Vamos a asegurar que su atención continúe sin inconvenientes."</li>
            </ul>

            <p style="margin-top:0.6em;"><strong>📞 Para mantener al paciente en línea</strong></p>
            <ul>
              <li>"Por favor, manténgase en la llamada mientras verifico su cita, será rápido."</li>
              <li>"Estoy validando la disponibilidad, no tardaré más de un minuto."</li>
              <li>"Gracias por su paciencia, esto es para garantizar que su atención sea correcta."</li>
            </ul>

            <p style="margin-top:0.6em;"><strong>🧠 Frases para empatía y confianza</strong></p>
            <ul>
              <li>"Entiendo que esto puede ser incómodo, pero estoy aquí para ayudarle a resolverlo."</li>
              <li>"Su salud es nuestra prioridad, vamos a asegurarnos de que todo quede agendado correctamente."</li>
            </ul>
          </div>
        </details>
      </div>
      <div class="modal-footer">
        <button onclick="closeGuionEpa()" class="kpi-config-reset">Cerrar</button>
      </div>
    </div>
  </div>

  <div class="kpi-tooltip" id="kpi-tooltip" role="tooltip" aria-hidden="true"></div>
  <!-- Datos demo embebidos -->
  <script id="demo-data" type="application/json">
  {
    "resumen": {
      "tipificaciones": { "actual": 0.93, "meta": 0.95 },
      "epa": { "actual": 0.80, "meta": 0.85 },
      "tmo": { "actual_min": 5.8, "meta_min": 5 }
    },
    "serie_diaria": [
      { "fecha": "2025-10-01", "tipificaciones": 0.92, "epa": 0.83, "tmo_min": 5.4 },
      { "fecha": "2025-10-02", "tipificaciones": 0.91, "epa": 0.82, "tmo_min": 5.5 },
      { "fecha": "2025-10-03", "tipificaciones": 0.93, "epa": 0.84, "tmo_min": 5.2 },
      { "fecha": "2025-10-04", "tipificaciones": 0.94, "epa": 0.85, "tmo_min": 5.0 },
      { "fecha": "2025-10-05", "tipificaciones": 0.95, "epa": 0.86, "tmo_min": 4.9 },
      { "fecha": "2025-10-06", "tipificaciones": 0.92, "epa": 0.83, "tmo_min": 5.1 },
      { "fecha": "2025-10-07", "tipificaciones": 0.93, "epa": 0.80, "tmo_min": 5.8 }
    ],
    "ejecutivos": []
  }
  </script>
  <!-- Botón y lógica de cuartilización -->
  <style>
    #btn-cuatiles { position: fixed; right: 18px; bottom: 18px; z-index: 1200; background:#1E7F4F; color:#fff; border:none; padding:10px 14px; border-radius:8px; cursor:pointer; box-shadow:0 6px 18px rgba(0,0,0,0.12);} 
    #cuartiles-modal { position: fixed; right: 18px; bottom: 70px; z-index:1200; background:#fff; border-radius:8px; box-shadow:0 8px 30px rgba(0,0,0,0.2); max-width:420px; width:360px; display:none; padding:12px; font-family:Segoe UI,Arial,sans-serif; }
    #cuartiles-modal table{width:100%; border-collapse:collapse; font-size:14px}
    #cuartiles-modal th{ text-align:left; font-weight:700; padding:6px 4px}
    #cuartiles-modal td{ padding:6px 4px; border-top:1px solid #eee }
    #cuartiles-close{ float:right; background:transparent;border:none;font-weight:700;cursor:pointer }
  </style>

  <button id="btn-cuatiles" title="Mostrar cuartiles">Cuartiles</button>
  <div id="cuartiles-modal" role="dialog" aria-label="Resultados por cuartiles">
    <button id="cuartiles-close">✕</button>
    <h4 style="margin:6px 0 8px 0">Clasificación por cuartiles</h4>
    <div id="cuartiles-content">Cargando...</div>
    <div id="cuartiles-detalle" style="display:none;border-top:1px solid #eee;margin-top:8px;padding-top:8px;font-size:13px"></div>
  </div>

  <script>
    (function(){
      // Indicadores y umbrales solicitados (usados para normalizar valores)
      const indicadores = [
        { key: 'satisfaccion-snl', type:'porcentaje' },
        { key: 'resolucion-snl', type:'porcentaje' },
        { key: 'satisfaccion-ep', type:'porcentaje' },
        { key: 'resolucion-ep', type:'porcentaje' },
        { key: 'tmo', type:'minutos' },
        { key: 'transferencia-epa', type:'porcentaje' },
        { key: 'tipificaciones', type:'porcentaje' }
      ];

      function parsePorcentaje(str){ if (str==null) return null; let v = String(str).replace('%','').replace(',','.').trim(); let n=parseFloat(v); return isNaN(n)?null:n; }
      function parseMinutos(str){ if (str==null) return null; let v=String(str).replace(',','.').trim(); let n=parseFloat(v); return isNaN(n)?null:n; }

      // Recolecta entidades a evaluar. Asume que cada fila/registro tiene atributos data-* con los indicadores.
      // Si su tablero usa otra estructura, podemos ajustar la recolección.
      function collectEntities(){
        const nodes = Array.from(document.querySelectorAll('[data-entity-id]'));
        if(nodes.length===0){
          // fallback: buscar filas de tablas
          const rows = Array.from(document.querySelectorAll('table tr'));
          return rows.slice(1).map((r,i)=>{
            const cells = Array.from(r.querySelectorAll('td'));
            return { id: 'row-'+i, label: (r.querySelector('th')?r.querySelector('th').textContent.trim():('Fila '+(i+1))), rawEl:r, cells };
          });
        }
        return nodes.map(n=>({ id: n.getAttribute('data-entity-id')||n.id||n.dataset.entityId, label: n.getAttribute('data-entity-label')||n.dataset.entityLabel||n.id||'Entidad', rawEl: n }));
      }

      // Extrae valor de un indicador dentro de un elemento (intenta data attributes y contenido textual)
      // También soporta extracción desde historial si el objeto entidad tiene propiedad `historial`.
      function extractIndicator(elOrEntity, key, type){
        // Si se pasa una entidad con historial, extraer desde allí
        if(elOrEntity && elOrEntity.historial){
          const hist = elOrEntity.historial;
          // Mapear key conocido -> clave en historial
          const map = {
            'satisfaccion-snl': 'satisfaccion_snl',
            'resolucion-snl': 'resolucion_snl',
            'satisfaccion-ep': 'satisfaccion_ep',
            'resolucion-ep': 'resolucion_ep',
            'tmo': 'tmo',
            'transferencia-epa': 'epa',
            'tipificaciones': 'tipificaciones'
          };
          const hid = map[key] || key.replace(/[-\s]/g,'_');
          const series = hist[hid] || hist[hid.toLowerCase()] || hist[key] || null;
          if(series && Array.isArray(series) && series.length>0){
            const last = series[series.length-1];
            return (last && typeof last.valor !== 'undefined') ? last.valor : null;
          }
          return null;
        }

        const el = elOrEntity;
        if(!el) return null;
        // data attributes
        const d = el.querySelector ? (el.querySelector('[data-'+key+']')||el.querySelector('[data-kpi="'+key+'"]')) : null;
        if(d){ const v = d.getAttribute('data-'+key) || d.getAttribute('data-kpi-value') || d.textContent; return type==='porcentaje'?parsePorcentaje(v):parseMinutos(v); }
        // buscar por texto dentro del bloque
        const txt = (el.textContent||'').match(new RegExp(key.replace(/[-\s]/g,'.*'),'i')) ? el.textContent : null;
        if(txt){ // heurística: extraer primer número
          const m = (el.textContent||'').match(/\d+[\.,]?\d*/);
          if(m) return type==='porcentaje'?parsePorcentaje(m[0]):parseMinutos(m[0]);
        }
        return null;
      }

      // Normaliza las entidades en vector numérico (omitimos nulls en promedio)
      function buildScoreVector(entity){
        // Si viene del historial, entity.historial estará presente
        const vals = indicadores.map(ind=>{
          let raw = extractIndicator(entity, ind.key, ind.type);
          if(raw===null||raw===undefined||isNaN(raw)) return null;
          // Normalizar formatos: si porcentaje viene en 0-1, convertir a 0-100
          if(ind.type==='porcentaje'){
            if(raw <= 1) raw = raw * 100;
            return Number(raw);
          }
          if(ind.type==='minutos'){
            // TMO: menor es mejor. Convertir a score 0-100 donde 100 = objetivo (5 min)
            const tmoTarget = 5.0;
            if(raw <= 0) return null;
            const normalized = Math.min(100, (tmoTarget / raw) * 100);
            return Number(normalized);
          }
          return Number(raw);
        });

        const numbers = [];
        for(let i=0;i<vals.length;i++){
          const v = vals[i]; if(v===null||v===undefined||isNaN(v)) continue; numbers.push(v);
        }
        const score = numbers.length? (numbers.reduce((a,b)=>a+b,0)/numbers.length) : null;
        return { id: entity.id, label: entity.label||entity.id, vals, score };
      }

      function quartilize(list){
        // list de objetos con .score
        const filtered = list.filter(x=>x.score!==null && x.score!==undefined && !isNaN(x.score));
        const sorted = filtered.slice().sort((a,b)=>b.score - a.score); // descendente: top mejores
        const n = sorted.length;
        const qSize = Math.max(1, Math.floor(n/4));
        const groups = { Q1:[], Q2:[], Q3:[], Q4:[] };
        sorted.forEach((item, idx)=>{
          const pos = idx; // 0-based
          if(pos < qSize) groups.Q1.push(item);
          else if(pos < qSize*2) groups.Q2.push(item);
          else if(pos < qSize*3) groups.Q3.push(item);
          else groups.Q4.push(item);
        });
        return groups;
      }

      function renderModal(groups){
        const container = document.getElementById('cuartiles-content');
        if(!container) return;
        let html = '';
        let globalList = [];
        for(const [k,arr] of Object.entries(groups)){
          html += '<strong>'+k+'</strong> ('+arr.length+')<br/>';
          if(arr.length===0){ html += '<div style="color:#666;margin-bottom:8px">(sin elementos)</div>'; continue; }
          html += '<table>';
          html += '<thead><tr><th>Entidad</th><th style="text-align:right">Score</th></tr></thead><tbody>';
          arr.forEach(it=>{ html += '<tr class="cuartil-row" data-entity-id="'+escapeHtml(it.id)+'"><td>'+escapeHtml(it.label)+'</td><td style="text-align:right">'+(it.score!==null?Number(it.score).toFixed(2):'–')+'</td></tr>'; globalList.push(it); });
          html += '</tbody></table><div style="height:8px"></div>';
        }
        container.innerHTML = html;
        // Guardar lista en el contenedor para acceso posterior
        container._globalList = globalList;
      }

      // Umbrales para explicación (coinciden con sistema_predictivo_historial.js)
      const KPI_EXPL = {
        'satisfaccion-snl': { nombre:'Satisfacción SNL', tipo:'porcentaje', umbral:95, sentido:'mayor' },
        'resolucion-snl': { nombre:'Resolución SNL', tipo:'porcentaje', umbral:90, sentido:'mayor' },
        'satisfaccion-ep': { nombre:'Satisfacción EP', tipo:'porcentaje', umbral:95, sentido:'mayor' },
        'resolucion-ep': { nombre:'Resolución EP', tipo:'porcentaje', umbral:90, sentido:'mayor' },
        'tmo': { nombre:'TMO', tipo:'minutos', umbral:5, sentido:'menor' },
        'transferencia-epa': { nombre:'Transferencia EPA', tipo:'porcentaje', umbral:85, sentido:'mayor' },
        'tipificaciones': { nombre:'Tipificaciones', tipo:'porcentaje', umbral:95, sentido:'mayor' }
      };

      // Mostrar detalle al hacer clic en una fila
      document.getElementById('cuartiles-modal').addEventListener('click', function(e){
        const row = e.target.closest && e.target.closest('.cuartil-row');
        if(!row) return;
        const id = row.getAttribute('data-entity-id');
        const container = document.getElementById('cuartiles-content');
        const list = container && container._globalList ? container._globalList : [];
        const ent = list.find(x=>String(x.id)===String(id));
        const detalle = document.getElementById('cuartiles-detalle');
        if(!ent || !detalle) return;
        // Construir desglose
        let html = '<button id="detalle-back" style="float:right;background:transparent;border:none;cursor:pointer">← Volver</button>';
        html += '<div style="font-weight:700;margin-bottom:6px">Detalle: '+escapeHtml(ent.label)+'</div>';
        html += '<table style="width:100%;font-size:13px"><thead><tr><th>Indicador</th><th style="text-align:right">Valor</th><th style="text-align:right">Normalizado</th></tr></thead><tbody>';
        for(let i=0;i<indicadores.length;i++){
          const ind = indicadores[i];
          const raw = ent.vals ? ent.vals[i] : null;
          let norm = (raw===null||raw===undefined||isNaN(raw)) ? '–' : (()=>{
            if(ind.type==='porcentaje'){ let v = Number(raw); if(v<=1) v = v*100; return Number(v).toFixed(1)+'%'; }
            if(ind.type==='minutos'){ return (raw).toFixed(2)+' min'; }
            return String(raw);
          })();
          // compute normalized score contribution (same as buildScoreVector)
          let contrib = '–';
          if(raw!==null && raw!==undefined && !isNaN(raw)){
            if(ind.type==='porcentaje'){ let v=Number(raw); if(v<=1) v=v*100; contrib = Number(v).toFixed(1)+'%'; }
            else if(ind.type==='minutos'){ const tmoTarget=5.0; const v=Number(raw); contrib = Math.min(100,(tmoTarget/v)*100).toFixed(1); contrib += ' (score)'; }
          }
          html += '<tr><td>'+escapeHtml(ind.key)+'</td><td style="text-align:right">'+norm+'</td><td style="text-align:right">'+contrib+'</td></tr>';
        }
        html += '</tbody></table>';

        // Añadir explicación breve por qué Q4 (si score bajo o faltan indicadores)
        html += '<div style="margin-top:8px">';
        if(ent.score===null){ html += '<div style="color:#b00">No hay suficientes métricas para calcular un score.</div>'; }
        else{
          html += '<div>Score: <strong>'+Number(ent.score).toFixed(2)+'</strong></div>';
          // detectar indicadores faltantes
          const faltantes = indicadores.map((ind,i)=>({ ind, val: ent.vals ? ent.vals[i] : null })).filter(x=>x.val===null||x.val===undefined||isNaN(x.val));
          if(faltantes.length>0) html += '<div style="color:#b66;margin-top:6px">Faltan métricas: '+faltantes.map(f=>f.ind.key).join(', ')+'</div>';
          // detectar indicadores por debajo de umbral
          const bajos = [];
          for(let i=0;i<indicadores.length;i++){
            const ind = indicadores[i]; const val = ent.vals ? ent.vals[i] : null;
            if(val===null||val===undefined||isNaN(val)) continue;
            const expl = KPI_EXPL[ind.key];
            if(expl){
              if(expl.tipo==='porcentaje'){
                let v=Number(val); if(v<=1) v=v*100;
                if(expl.sentido==='mayor' && v < expl.umbral) bajos.push({k:ind.key, v});
              } else if(expl.tipo==='minutos'){
                const v=Number(val);
                if(expl.sentido==='menor' && v > expl.umbral) bajos.push({k:ind.key, v});
              }
            }
          }
          if(bajos.length>0){ html += '<div style="color:#b00;margin-top:6px">Indicadores por debajo de la meta: '+bajos.map(b=>b.k+ ' ('+b.v +')').join(', ')+'</div>'; }
        }
        html += '</div>';

        detalle.innerHTML = html;
        detalle.style.display = 'block';
        document.getElementById('cuartiles-content').style.display = 'none';
        // volver
        document.getElementById('detalle-back').addEventListener('click', function(){ detalle.style.display='none'; document.getElementById('cuartiles-content').style.display='block'; });
      });

      function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

      // Acción del botón: primero intentar alimentar desde el Historial de Métricas
      document.getElementById('btn-cuatiles').addEventListener('click', function(){
        let entities = [];
        try{
          const raw = localStorage.getItem('dashboard_metricas_historial');
          if(raw){
            const datos = JSON.parse(raw);
            // datos tiene la forma { ejecutivo: { kpiId: [ {fecha, valor, timestamp}, ... ], ... }, ... }
            const ejecutivos = Object.keys(datos || {});
            if(ejecutivos.length>0){
              entities = ejecutivos.map(name => ({ id: name, label: name, historial: datos[name] }));
            }
          }
        }catch(e){ console.warn('No se pudo leer historial:', e); }

        if(entities.length===0){
          entities = collectEntities();
        }

        const vectors = entities.map(buildScoreVector);
        const groups = quartilize(vectors);
        renderModal(groups);
        document.getElementById('cuartiles-modal').style.display = 'block';
      });
      document.getElementById('cuartiles-close').addEventListener('click', function(){ document.getElementById('cuartiles-modal').style.display='none'; });

      // Cerrar modal al hacer clic fuera del mismo (o al presionar Escape)
      (function(){
        const modal = document.getElementById('cuartiles-modal');
        const btn = document.getElementById('btn-cuatiles');
        document.addEventListener('click', function(e){
          try{
            if(!modal) return;
            if(modal.style.display === 'none' || modal.style.display === '') return;
            // Si el click fue dentro del modal o sobre el botón, no cerrar
            if(modal.contains(e.target) || (btn && btn.contains(e.target))) return;
            modal.style.display = 'none';
          }catch(err){ /* silencioso */ }
        }, true);

        document.addEventListener('keydown', function(e){
          if(!modal) return;
          if(e.key === 'Escape' && modal.style.display && modal.style.display !== 'none'){
            modal.style.display = 'none';
          }
        });
      })();
    })();
  </script>
  <script>
    // --- Variables de configuración y estado ---
    const DEFAULTS = {
      meta_tipificaciones: 0.95,
      meta_epa: 0.85,
      meta_tmo: 5,
      meta_satisfaccion_ep: 0.95,
      meta_resolucion_ep: 0.90,
      meta_satisfaccion_snl: 0.95,
      meta_resolucion_snl: 0.90,
      deviation_method: 'relativa',
      color_green: 0.02, // 2% de desviación
      color_amber: 0.06, // 6% de desviación
      kpi_focus: 'tipificaciones',
      date_range: null // por defecto últimos 90 días
    };
    let config = { ...DEFAULTS };
    let dashboardData = null;
    let theme = localStorage.getItem('achs-theme') || 'light';
    // --- Utilidades ---
    function roundPct(val) { return (val * 100).toFixed(1) + '%'; }
    function roundPctNum(val) { return +(val * 100).toFixed(1); }
    function roundMin(val) {
      if (isNaN(val)) return '--:--';
      const min = Math.floor(val);
      const sec = Math.round((val - min) * 60);
      return `${min}:${sec.toString().padStart(2, '0')}`;
    }
    function roundDeviation(val) { return (val * 100).toFixed(1) + '%'; }
    function abs(x) { return Math.abs(x); }
    function clamp(x, min, max) { return Math.max(min, Math.min(max, x)); }
    function getColorByDeviation(dev, maxDev, idx, green, amber, actual = null, meta = null, kpi = null) {
      if (actual != null && meta != null) {
        if ((kpi === 'tmo' && actual <= meta) || (kpi !== 'tmo' && actual >= meta)) {
          return 'green';
        } else {
          return 'red';
        }
      }
      if (idx === 0) return 'red';
      if (dev <= green) return 'green';
      if (dev <= amber) return 'amber';
      return 'red';
    }
    function getKpiLabel(kpi) {
      if (kpi === 'tipificaciones') return 'Tipificaciones';
      if (kpi === 'epa') return 'Transferencia a EPA';
      if (kpi === 'tmo') return 'TMO';
      if (kpi === 'satisfaccion_ep') return 'Satisfacción EP';
      if (kpi === 'resolucion_ep') return 'Resolución EP';
      if (kpi === 'satisfaccion_snl') return 'Satisfacción SNL';
      if (kpi === 'resolucion_snl') return 'Resolución SNL';
      if (kpi === 'nota_epa') return 'Nota EPA';
      return kpi;
    }
    function getKpiUnit(kpi) {
      if (kpi === 'tmo') return 'min';
      return '%';
    }
    function getKpiMetaKey(kpi) {
      if (kpi === 'tipificaciones') return 'meta_tipificaciones';
      if (kpi === 'epa') return 'meta_epa';
      if (kpi === 'tmo') return 'meta_tmo';
      if (kpi === 'satisfaccion_ep') return 'meta_satisfaccion_ep';
      if (kpi === 'resolucion_ep') return 'meta_resolucion_ep';
      if (kpi === 'satisfaccion_snl') return 'meta_satisfaccion_snl';
      if (kpi === 'resolucion_snl') return 'meta_resolucion_snl';
      return '';
    }
    function getKpiActualKey(kpi) {
      if (kpi === 'tmo') return 'actual_min';
      return 'actual';
    }
    function getKpiMetaValue(kpi, resumen) {
      if (kpi === 'tipificaciones') return resumen.tipificaciones?.meta ?? config.meta_tipificaciones;
      if (kpi === 'epa') return resumen.epa?.meta ?? config.meta_epa;
      if (kpi === 'tmo') return resumen.tmo?.meta_min ?? config.meta_tmo;
      if (kpi === 'satisfaccion_ep') return config.meta_satisfaccion_ep;
      if (kpi === 'resolucion_ep') return config.meta_resolucion_ep;
      if (kpi === 'satisfaccion_snl') return config.meta_satisfaccion_snl;
      if (kpi === 'resolucion_snl') return config.meta_resolucion_snl;
      return null;
    }
    function getKpiActualValue(kpi, resumen, executiveName = null) {
      if (executiveName && maintainerData[kpi] && maintainerData[kpi][executiveName]) {
        const vals = maintainerData[kpi][executiveName];
        const latestField = 'm' + (M_MONTH_LABELS ? M_MONTH_LABELS.length : 3);
        if (kpi === 'tmo') return vals[latestField] || resumen.tmo?.actual_min;
        return (vals[latestField] / 100) || resumen[kpi]?.actual;
      }
      if (kpi === 'tipificaciones') return resumen.tipificaciones?.actual;
      if (kpi === 'epa') return resumen.epa?.actual;
      if (kpi === 'tmo') return resumen.tmo?.actual_min;
      return null;
    }
    function deviation(val, meta, method, kpi) {
      if (val == null || meta == null || isNaN(val) || isNaN(meta)) return null;
      if (method === 'relativa') {
        if (meta === 0) return 0;
        return abs((val - meta) / meta);
      } else {
        return abs(val - meta);
      }
    }
    function deviationPct(val, meta, method, kpi) {
      if (val == null || meta == null || isNaN(val) || isNaN(meta)) return null;
      if (method === 'relativa') {
        if (meta === 0) return 0;
        return abs((val - meta) / meta) * 100;
      } else {
        return abs(val - meta) * 100 / (meta || 1);
      }
    }
    function parseDate(str) {
      const [y, m, d] = str.split('-').map(Number);
      return new Date(y, m - 1, d);
    }
    function formatDate(str) {
      const d = parseDate(str);
      return getShiftedMonth(d, { day: '2-digit', month: 'short' }, 'es-CL');
    }

    // Devuelve el nombre de mes (o fecha) ajustando Octubre->Noviembre, Noviembre->Diciembre, Diciembre->Enero
    function getShiftedMonth(dateObj, options = { month: 'long' }, locale = 'es-CL') {
      try {
        const raw = dateObj.toLocaleDateString(locale, options);
        // Reemplazos simples respetando mayúscula inicial si existe
        const map = {
          'septiembre': 'septiembre',
          'octubre': 'Octubre',
          'noviembre': 'Noviembre',
          'diciembre': 'diciembre',
          'Enero': 'Enero'
        };
        // Función que preserva la primera letra en mayúscula si aplica
        return raw.replace(/octubre|noviembre|diciembre/gi, (m) => {
          const lower = m.toLowerCase();
          const rep = map[lower] || lower;
          return m[0] === m[0].toUpperCase() ? rep.charAt(0).toUpperCase() + rep.slice(1) : rep;
        });
      } catch (e) {
        return dateObj.toLocaleDateString(locale, options);
      }
    }
    function getDateRange(serie) {
      if (!serie || !serie.length) return null;
      return [serie[0].fecha, serie[serie.length - 1].fecha];
    }
    function filterSerieByRange(serie, from, to) {
      if (!from || !to) return serie;
      const fromD = parseDate(from), toD = parseDate(to);
      return serie.filter(s => {
        const d = parseDate(s.fecha);
        return d >= fromD && d <= toD;
      });
    }
    function groupSerie(serie, granularity) {
      if (granularity === 'dia') return serie;
      const weeks = [];
      let current = null;
      for (const s of serie) {
        const d = parseDate(s.fecha);
        const week = d.getFullYear() + '-W' + String(getWeekNumber(d)).padStart(2, '0');
        if (!current || current.week !== week) {
          current = { week, fecha: s.fecha, tipificaciones: [], epa: [], tmo_min: [] };
          weeks.push(current);
        }
        current.tipificaciones.push(s.tipificaciones);
        current.epa.push(s.epa);
        current.tmo_min.push(s.tmo_min);
      }
      return weeks.map(w => ({
        fecha: w.fecha,
        tipificaciones: avg(w.tipificaciones),
        epa: avg(w.epa),
        tmo_min: avg(w.tmo_min)
      }));
    }
    function getWeekNumber(d) {
      d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
      const dayNum = d.getUTCDay() || 7;
      d.setUTCDate(d.getUTCDate() + 4 - dayNum);
      const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
      return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
    }
    function avg(arr) {
      arr = arr.filter(x => x != null && !isNaN(x));
      if (!arr.length) return null;
      return arr.reduce((a, b) => a + b, 0) / arr.length;
    }
    function getTop3Executives(executives, resumen) {
      // Filtrar ejecutivos con datos válidos
      const validExecs = executives.filter(e =>
        e.tipificaciones_actual != null &&
        e.epa_actual != null &&
        e.tmo_min_actual != null
      );

      // Calcular cumplimiento y puntaje
      const scoredExecs = validExecs.map(e => {
        const name = e.nombre;

        // Metas KPIs Operativos
        const metaTip = getKpiMetaValue('tipificaciones', resumen);
        const metaEpa = getKpiMetaValue('epa', resumen);
        const metaTmo = getKpiMetaValue('tmo', resumen);

        // Metas KPIs Satisfacción (Nota EPA)
        const metaSatEP = config.meta_satisfaccion_ep;
        const metaResEP = config.meta_resolucion_ep;
        const metaSatSNL = config.meta_satisfaccion_snl;
        const metaResSNL = config.meta_resolucion_snl;

        // Datos Actuales Operativos
        const valTip = e.tipificaciones_actual;
        const valEpa = e.epa_actual;
        const valTmo = e.tmo_min_actual;

        // Datos Actuales Satisfacción (desde maintainerData, m3 se asume actual)
        // Dividimos por 100 porque en maintainer se guardan como enteros (0-100) y metas son decimales (0.95)
        // OJO: Revisar si maintainer guarda 95 o 0.95. En import preview vimos valores enteros/decimales? 
        // En generador de tarjetas Nota EPA se divide por 100: (maintainerData.satisfaccion_ep?.[name]?.m3 || 0) / 100
        const latestField = 'm' + (M_MONTH_LABELS ? M_MONTH_LABELS.length : 3);
        const valSatEP = (maintainerData.satisfaccion_ep?.[name]?.[latestField] || 0) / 100;
        const valResEP = (maintainerData.resolucion_ep?.[name]?.[latestField] || 0) / 100;
        const valSatSNL = (maintainerData.satisfaccion_snl?.[name]?.[latestField] || 0) / 100;
        const valResSNL = (maintainerData.resolucion_snl?.[name]?.[latestField] || 0) / 100;

        // Verificar cumplimiento de TODOS los 7 KPIs
        const cumpleTip = valTip >= metaTip;
        const cumpleEpa = valEpa >= metaEpa;
        const cumpleTmo = valTmo <= metaTmo;
        const cumpleSatEP = valSatEP >= metaSatEP;
        const cumpleResEP = valResEP >= metaResEP;
        const cumpleSatSNL = valSatSNL >= metaSatSNL;
        const cumpleResSNL = valResSNL >= metaResSNL;

        const cumplimientos = [cumpleTip, cumpleEpa, cumpleTmo, cumpleSatEP, cumpleResEP, cumpleSatSNL, cumpleResSNL];
        const cumpleTodo = cumplimientos.every(c => c === true);

        // Puntaje simplificado: Promedio ponderado de cumplimiento
        // Cuanto más cerca (o por encima) de la meta mejor.
        // TMO es inverso: meta / actual

        const score = (
          (valTip / (metaTip || 1)) +
          (valEpa / (metaEpa || 1)) +
          (metaTmo / (valTmo || 1)) +
          (valSatEP / (metaSatEP || 1)) +
          (valResEP / (metaResEP || 1)) +
          (valSatSNL / (metaSatSNL || 1)) +
          (valResSNL / (metaResSNL || 1))
        ) / 7;

        return { ...e, score, cumpleTodo };
      });

      // Filtrar solo los que cumplen todo
      const starExecs = scoredExecs.filter(e => e.cumpleTodo);

      // Ordenar por score descendente (mejores primero)
      let topList = starExecs.sort((a, b) => b.score - a.score);

      // Si no hay suficientes que cumplen todo, completamos con los mejores score del resto
      if (topList.length < 3) {
        const others = scoredExecs.filter(e => !e.cumpleTodo).sort((a, b) => b.score - a.score);
        topList = topList.concat(others).slice(0, 3);
      }

      return topList.slice(0, 3);
    }

    function renderTop3Podium(top3) {
      if (!top3 || top3.length === 0) return '';

      // Reordenar para visualización: 2do (izq), 1ro (centro), 3ro (der)
      const visualOrder = [];
      if (top3[1]) visualOrder.push({ ...top3[1], rank: 2, medal: '🥈' });
      if (top3[0]) visualOrder.push({ ...top3[0], rank: 1, medal: '🥇' });
      if (top3[2]) visualOrder.push({ ...top3[2], rank: 3, medal: '🥉' });

      return `
            <div class="top-podium-container">
            ${visualOrder.map(exec => {
        // Avatar SVG animado de ejecutivo de call center
        const avatarSVG = `
          <svg width="100%" height="100%" viewBox="0 0 60 60" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="30" cy="30" r="28" fill="#f5f5f5" stroke="#2E7D32" stroke-width="3"/>
            <!-- Cabeza -->
            <ellipse cx="30" cy="25" rx="11" ry="13" fill="#ffe0b2"/>
            <!-- Cabello corto -->
            <path d="M19 25 Q30 10 41 25 Q38 15 22 15 Q19 25 19 25" fill="#795548"/>
            <!-- Cuello -->
            <rect x="26" y="36" width="8" height="7" rx="3" fill="#ffe0b2"/>
            <!-- Camisa clara -->
            <rect x="19" y="41" width="22" height="12" rx="6" fill="#e3f2fd"/>
            <polygon points="30,41 25,53 35,53" fill="#fff"/>
            <!-- Auriculares más visibles -->
            <ellipse cx="17" cy="25" rx="2.2" ry="4.2" fill="#263238"/>
            <ellipse cx="43" cy="25" rx="2.2" ry="4.2" fill="#263238"/>
            <rect x="15" y="22" width="2" height="6" rx="1" fill="#263238"/>
            <rect x="43" y="22" width="2" height="6" rx="1" fill="#263238"/>
            <rect x="18" y="20" width="24" height="2" rx="1" fill="#263238"/>
            <!-- Micrófono -->
            <rect x="41" y="36" width="7" height="2" rx="1" fill="#263238"/>
            <circle cx="48" cy="37" r="1.2" fill="#263238"/>
            <!-- Ojos -->
            <ellipse cx="26" cy="28" rx="1.1" ry="1.7" fill="#444"/>
            <ellipse cx="34" cy="28" rx="1.1" ry="1.7" fill="#444"/>
            <!-- Boca -->
            <path d="M27 33 Q30 36 33 33" stroke="#b77b4b" stroke-width="1.2" fill="none"/>
          </svg>
        `;
        return `
                <div class="podium-item rank-${exec.rank}">
                    <div class="podium-avatar" title="${exec.nombre}">
                    ${avatarSVG}
                    <div class="podium-rank">${exec.rank}</div>
                    </div>
                    <div class="podium-name">${exec.nombre}</div>
                    <div class="podium-score">${exec.medal} Top Performer</div>
                </div>
                `;
      }).join('')}
            </div>
        `;
    }

    // --- Renderizado principal ---
    function renderDashboard() {
      const selName = window.selectedExecutive || '';
      // --- Filtro y botón arriba del dashboard ---
      let filtroHtml = `<section style="display:flex;align-items:center;gap:1.5em;margin-bottom:1.2em;">
        <button id="btn-mostrar-todos" style="padding:0.5em 1.2em;font-size:1em;border-radius:8px;background:#2563eb;color:#fff;border:none;cursor:pointer;">Mostrar todos</button>
        <label for="filtro-ejecutivo" style="font-weight:500;">Filtrar por ejecutivo:</label>
        <select id="filtro-ejecutivo" style="font-size:1em;padding:0.4em 1em;border-radius:6px;border:1px solid #bbb;">
          <option value="">Todos</option>
          ${getDynamicExecutives().map(ej => `<option value="${ej}" ${selName === ej ? 'selected' : ''}>${ej}</option>`).join('')}
        </select>
      </section>`;

      // Panel dinámico con nombre y KPIs del ejecutivo seleccionado - REMOVIDO POR SOLICITUD
      /*
      if (selName) {
        const ej = getExecListForDashboard().find(e => e.nombre === selName);
        if (ej) {
          filtroHtml += `
            <section id="ejecutivo-detalle-panel" style="margin-bottom:1.2em;display:flex;align-items:center;gap:2em;background:#f5f7fa;border-radius:10px;padding:1em 2em;box-shadow:0 2px 8px rgba(44,62,80,0.07);">
              <div style="min-width:180px;">
                <span style="font-size:1.1em;font-weight:600;color:#2563eb;">${ej.nombre}</span>
              </div>
              <div style="display:flex;gap:2em;">
                <div style="display:flex;flex-direction:column;align-items:center;">
                  <span style="font-size:0.95em;color:#607d8b;">Tipificaciones</span>
                  <span style="font-size:1.2em;font-weight:700;">${(ej.tipificaciones_actual * 100).toFixed(1)}%</span>
                </div>
                <div style="display:flex;flex-direction:column;align-items:center;">
                  <span style="font-size:0.95em;color:#607d8b;">EPA</span>
                  <span style="font-size:1.2em;font-weight:700;">${(ej.epa_actual * 100).toFixed(1)}%</span>
                </div>
                <div style="display:flex;flex-direction:column;align-items:center;">
                  <span style="font-size:0.95em;color:#607d8b;">TMO</span>
                  <span style="font-size:1.2em;font-weight:700;">${ej.tmo_min_actual.toFixed(2)} min</span>
                </div>
              </div>
            </section>
          `;
        }
      }
      */
      // --- Lógica de filtrado por ejecutivo ---
      const root = document.getElementById('dashboard-root');
      if (!dashboardData) {
        root.innerHTML = '<div class="kpi-empty-state">No hay datos disponibles.</div>';
        return;
      }
      // 1. KPIs principales
      const allExecs = getExecListForDashboard();
      let resumen = {
        tipificaciones: { actual: 0, meta: config.meta_tipificaciones },
        epa: { actual: 0, meta: config.meta_epa },
        tmo: { actual_min: 0, meta_min: config.meta_tmo }
      };

      if (allExecs.length > 0) {
        resumen.tipificaciones.actual = allExecs.reduce((sum, e) => sum + e.tipificaciones_actual, 0) / allExecs.length;
        resumen.epa.actual = allExecs.reduce((sum, e) => sum + e.epa_actual, 0) / allExecs.length;
        resumen.tmo.actual_min = allExecs.reduce((sum, e) => sum + e.tmo_min_actual, 0) / allExecs.length;
      }

      // Calculate Top 3
      const top3Executives = getTop3Executives(allExecs, resumen);
      const podiumHtml = renderTop3Podium(top3Executives);

      if (selName) {
        const ej = allExecs.find(e => e.nombre === selName);
        if (ej) {
          resumen = {
            tipificaciones: { actual: ej.tipificaciones_actual, meta: config.meta_tipificaciones },
            epa: { actual: ej.epa_actual, meta: config.meta_epa },
            tmo: { actual_min: ej.tmo_min_actual, meta_min: config.meta_tmo }
          };
        }
      }

      const kpis = ['tipificaciones', 'epa', 'tmo'];
      // Calcular desviaciones y ordenar
      const kpiStats = kpis.map(kpi => {
        const actual = getKpiActualValue(kpi, resumen, selName);
        const meta = getKpiMetaValue(kpi, resumen);
        const dev = deviation(actual, meta, config.deviation_method, kpi);
        return { kpi, actual, meta, dev };
      });
      kpiStats.sort((a, b) => b.dev - a.dev);
      // 2. Render tarjetas KPI
      let kpiCards = '<section class="dashboard-grid" aria-label="KPIs principales">';
      kpiStats.forEach((stat, idx) => {
        const color = getColorByDeviation(stat.dev, kpiStats[0].dev, idx, config.color_green, config.color_amber, stat.actual, stat.meta, stat.kpi);
        const devPct = deviationPct(stat.actual, stat.meta, config.deviation_method, stat.kpi);
        kpiCards += `
        <div class="kpi-card ${color}" tabindex="0" aria-label="${getKpiLabel(stat.kpi)}">
          <div class="kpi-title">
            ${getKpiLabel(stat.kpi)}
            <span class="kpi-chip ${color}" title="Estado respecto a la meta">${color === 'green' ? '✔' : color === 'amber' ? '⚠' : '✖'}</span>
          </div>
          <div class="kpi-value">
            ${stat.kpi === 'tmo' ? roundMin(stat.actual) : roundPct(stat.actual)}
            <span style="font-size:0.6em;font-weight:400;">Meta: ${stat.kpi === 'tmo' ? roundMin(stat.meta) : roundPct(stat.meta)}</span>
          </div>
          <div class="kpi-meta">
            <span title="Desviación numérica">Desviación: <b>${stat.kpi === 'tmo' ? (stat.actual - stat.meta).toFixed(2) + ' min' : (Math.round((stat.actual - stat.meta) * 100) + '%')}</b></span>
            <span title="Desviación normalizada">Desviación %: <b>${Math.round(devPct)}%</b></span>
          </div>
          <canvas class="kpi-sparkline" id="sparkline-${stat.kpi}" aria-label="Evolución de ${getKpiLabel(stat.kpi)}" tabindex="0"></canvas>
        </div>`;
      });
      kpiCards += '</section>';
      // 3. Gráficos principales
      let kpiGraphs = '';
      // 4. Serie temporal
      let serie = dashboardData.serie_diaria || [];
      let [from, to] = getDateRange(serie) || [null, null];
      if (config.date_range) {
        const m = config.date_range.match(/(\d{4}-\d{2}-\d{2})\s*a\s*(\d{4}-\d{2}-\d{2})/);
        if (m) [from, to] = [m[1], m[2]];
      }
      let granularity = window.kpiGranularity || 'dia';
      let serieFiltrada = filterSerieByRange(serie, from, to);
      let serieAgrupada = groupSerie(serieFiltrada, granularity);
      let serieLabels = serieAgrupada.map(s => formatDate(s.fecha));
      let serieTip = serieAgrupada.map(s => s.tipificaciones);
      let serieEpa = serieAgrupada.map(s => s.epa);
      let serieTmo = serieAgrupada.map(s => s.tmo_min);
      let serieTemporal = '';
      // 5. Tabla de ejecutivos
      let kpiFocus = config.kpi_focus || 'tipificaciones';
      let ejecutivos = getExecListForDashboard().map(ej => {
        let actual = ej[`${kpiFocus}_actual`];
        let meta = getKpiMetaValue(kpiFocus, resumen);
        let dev = deviation(actual, meta, config.deviation_method, kpiFocus);
        return { ...ej, actual, meta, dev };
      });
      ejecutivos = ejecutivos.filter(ej => ej.dev != null && !isNaN(ej.dev));
      if (selName) ejecutivos = ejecutivos.filter(ej => ej.nombre === selName);
      // Ordenar de mayor a menor valor actual
      ejecutivos.sort((a, b) => b.actual - a.actual);
      let tablaEjecutivos = `
        <section class="kpi-table-section">
          <div class="kpi-table-title" style="display:flex;align-items:center;justify-content:space-between;">
            <span>Desempeño por Ejecutivo - ${getKpiLabel(kpiFocus)} <span style='font-weight:400;font-size:0.9em;color:#607d8b'>(Meta: ${Math.round(getKpiMetaValue(kpiFocus, resumen) * 100)}%)</span></span>
            <button id="toggle-ejecutivos" aria-expanded="false" aria-controls="tabla-ejecutivos" style="background:none;border:none;font-size:1.2em;cursor:pointer;" title="Mostrar/Ocultar lista">►</button>
          </div>
          <div id="tabla-ejecutivos-wrapper" style="display:none;">
          <table class="kpi-table" id="tabla-ejecutivos" aria-label="Tabla de desempeño por ejecutivo">
            <thead>
              <tr>
                <th>Ejecutivo</th>
                <th>Valor</th>
                <th>Meta</th>
                <th>Desviación</th>
                <th>Desviación %</th>
                
                <th>Barra</th>
              </tr>
            </thead>
            <tbody>
      `;
      ejecutivos.forEach((ej, idx) => {
        let color = 'red';
        // Solo para KPIs porcentuales (tipificaciones, epa)
        if (kpiFocus === 'tipificaciones') {
          const pct = Math.round(ej.actual * 100);
          if (pct >= 95) color = 'green';
          else if (pct >= 94) color = 'amber';
          else color = 'red';
        } else if (kpiFocus === 'epa') {
          const pct = Math.round(ej.actual * 100);
          if (pct >= 85) color = 'green';
          else if (pct >= 80) color = 'amber';
          else color = 'red';
        } else {
          // Para TMO, menor es mejor: puedes ajustar aquí si lo necesitas
          color = getColorByDeviation(ej.dev, ejecutivos[0]?.dev, idx, config.color_green, config.color_amber, ej.actual, ej.meta, kpiFocus);
        }
        const devPct = deviationPct(ej.actual, ej.meta, config.deviation_method, kpiFocus);
        tablaEjecutivos += `
          <tr class="${color}" tabindex="0">
            <td>${ej.nombre}</td>
            <td>${kpiFocus === 'tmo' ? roundMin(ej.actual) : Math.round(ej.actual * 100) + '%'}</td>
            <td>${kpiFocus === 'tmo' ? roundMin(ej.meta) : Math.round(ej.meta * 100) + '%'}</td>
            <td>${kpiFocus === 'tmo' ? (ej.actual - ej.meta).toFixed(2) + ' min' : Math.round((ej.actual - ej.meta) * 100) + '%'}</td>
            <td>${Math.round(devPct)}%</td>
            
            <td>
              <div class="kpi-table-bar ${color}">
                <div class="kpi-table-bar-inner ${color}" style="width:${clamp(Math.round(devPct), 0, 100)}%"></div>
                <span class="kpi-table-bar-label ${color}">${Math.round(devPct)}%</span>
              </div>
            </td>
          </tr>
        `;
      });
      tablaEjecutivos += '</tbody></table></div></section>';
      // Tabla de ejecutivos para EPA
      let ejecutivosEPA = getExecListForDashboard().map(ej => {
        let actual = ej['epa_actual'];
        let meta = getKpiMetaValue('epa', resumen);
        let dev = deviation(actual, meta, config.deviation_method, 'epa');
        return { ...ej, actual, meta, dev };
      });
      ejecutivosEPA = ejecutivosEPA.filter(ej => ej.dev != null && !isNaN(ej.dev));
      if (selName) ejecutivosEPA = ejecutivosEPA.filter(ej => ej.nombre === selName);
      ejecutivosEPA.sort((a, b) => b.actual - a.actual);
      let tablaEjecutivosEPA = `
        <section class="kpi-table-section">
          <div class="kpi-table-title" style="display:flex;align-items:center;justify-content:space-between;">
            <span>Desempeño por Ejecutivo - Transferencia a EPA <span style='font-weight:400;font-size:0.9em;color:#607d8b'>(Meta: 85%)</span></span>
            <button id="toggle-ejecutivos-epa" aria-expanded="false" aria-controls="tabla-ejecutivos-epa" style="background:none;border:none;font-size:1.2em;cursor:pointer;" title="Mostrar/Ocultar lista">►</button>
          </div>
          <div id="tabla-ejecutivos-epa-wrapper" style="display:none;">
          <table class="kpi-table" id="tabla-ejecutivos-epa" aria-label="Tabla de desempeño por ejecutivo EPA">
            <thead>
              <tr>
                <th>Ejecutivo</th>
                <th>Valor</th>
                <th>Meta</th>
                <th>Desviación</th>
                <th>Desviación %</th>
                
                <th>Barra</th>
              </tr>
            </thead>
            <tbody>
      `;
      ejecutivosEPA.forEach((ej, idx) => {
        let color = 'red';
        const pct = Math.round(ej.actual * 100);
        if (pct >= 85) color = 'green';
        else if (pct >= 80) color = 'amber';
        else color = 'red';
        const devPct = deviationPct(ej.actual, ej.meta, config.deviation_method, 'epa');
        tablaEjecutivosEPA += `
          <tr class="${color}" tabindex="0">
            <td>${ej.nombre}</td>
            <td>${Math.round(ej.actual * 100)}%</td>
            <td>${Math.round(ej.meta * 100)}%</td>
            <td>${Math.round((ej.actual - ej.meta) * 100)}%</td>
            <td>${Math.round(devPct)}%</td>
            
            <td>
              <div class="kpi-table-bar ${color}">
                <div class="kpi-table-bar-inner ${color}" style="width:${Math.max(0, Math.min(Math.round(devPct), 100))}%"></div>
                <span class="kpi-table-bar-label ${color}">${Math.round(devPct)}%</span>
              </div>
            </td>
          </tr>
        `;
      });
      tablaEjecutivosEPA += '</tbody></table></div></section>';

      // Tabla de ejecutivos para TMO
      let ejecutivosTMO = getExecListForDashboard().map(ej => {
        let actual = ej['tmo_min_actual'];
        let meta = getKpiMetaValue('tmo', resumen);
        let dev = deviation(actual, meta, config.deviation_method, 'tmo');
        return { ...ej, actual, meta, dev };
      });
      ejecutivosTMO = ejecutivosTMO.filter(ej => ej.dev != null && !isNaN(ej.dev));
      if (selName) ejecutivosTMO = ejecutivosTMO.filter(ej => ej.nombre === selName);
      ejecutivosTMO.sort((a, b) => a.actual - b.actual); // Menor TMO es mejor
      let tablaEjecutivosTMO = `
        <section class="kpi-table-section">
          <div class="kpi-table-title" style="display:flex;align-items:center;justify-content:space-between;">
            <span>Desempeño por Ejecutivo - TMO <span style='font-weight:400;font-size:0.9em;color:#607d8b'>(Meta: ${Math.round(getKpiMetaValue('tmo', resumen))} min)</span></span>
            <button id="toggle-ejecutivos-tmo" aria-expanded="false" aria-controls="tabla-ejecutivos-tmo" style="background:none;border:none;font-size:1.2em;cursor:pointer;" title="Mostrar/Ocultar lista">►</button>
          </div>
          <div id="tabla-ejecutivos-tmo-wrapper" style="display:none;">
          <table class="kpi-table" id="tabla-ejecutivos-tmo" aria-label="Tabla de desempeño por ejecutivo TMO">
            <thead>
              <tr>
                <th>Ejecutivo</th>
                <th>Valor</th>
                <th>Meta</th>
                <th>Desviación</th>
                <th>Desviación %</th>
                
                <th>Barra</th>
              </tr>
            </thead>
            <tbody>
      `;
      ejecutivosTMO.forEach((ej, idx) => {
        let color = getColorByDeviation(ej.dev, ejecutivosTMO[0]?.dev, idx, config.color_green, config.color_amber, ej.actual, ej.meta, 'tmo');
        const devPct = deviationPct(ej.actual, ej.meta, config.deviation_method, 'tmo');
        tablaEjecutivosTMO += `
          <tr class="${color}" tabindex="0">
            <td>${ej.nombre}</td>
            <td>${roundMin(ej.actual)}</td>
            <td>${roundMin(ej.meta)}</td>
            <td>${(ej.actual - ej.meta).toFixed(2)} min</td>
            <td>${Math.round(devPct)}%</td>
            
            <td>
              <div class="kpi-table-bar ${color}">
                <div class="kpi-table-bar-inner ${color}" style="width:${clamp(Math.round(devPct), 0, 100)}%"></div>
                <span class="kpi-table-bar-label ${color}">${Math.round(devPct)}%</span>
              </div>
            </td>
          </tr>
        `;
      });
      tablaEjecutivosTMO += '</tbody></table></div></section>';

      const ejecutivosNotaEPA = getExecListForDashboard().map(ej => {
        const name = ej.nombre;
        const latestField = 'm' + (M_MONTH_LABELS ? M_MONTH_LABELS.length : 3);
        return {
          nombre: name,
          ep: (maintainerData.satisfaccion_ep?.[name]?.[latestField] || 0) / 100,
          ep_res: (maintainerData.resolucion_ep?.[name]?.[latestField] || 0) / 100,
          snl: (maintainerData.satisfaccion_snl?.[name]?.[latestField] || 0) / 100,
          snl_res: (maintainerData.resolucion_snl?.[name]?.[latestField] || 0) / 100
        };
      }).sort((a, b) => b.ep - a.ep); // Ordenar por Satisfacción EP desc

      let tablaEjecutivosNotaEPA = `
        <section class="kpi-table-section">
          <div class="kpi-table-title" style="display:flex;align-items:center;justify-content:space-between;">
            <span>Desempeño por Ejecutivo - Nota EPA SNL/EP</span>
            <button id="toggle-ejecutivos-notaepa" aria-expanded="false" aria-controls="tabla-ejecutivos-notaepa" style="background:none;border:none;font-size:1.2em;cursor:pointer;" title="Mostrar/Ocultar lista">►</button>
          </div>
          <div id="tabla-ejecutivos-notaepa-wrapper" style="display:none;">
          <table class="kpi-table" id="tabla-ejecutivos-notaepa" aria-label="Tabla de desempeño por ejecutivo Nota EPA SNL/EP">
            <thead>
              <tr>
                <th>Agente</th>
                <th>Satisfacción EP<br><span style='font-weight:400;font-size:0.9em;color:#607d8b'>(Meta: 95%)</span></th>
                <th>RESOLUCION EP<br><span style='font-weight:400;font-size:0.9em;color:#607d8b'>(Meta: 90%)</span></th>
                <th>Satisfacción SNL<br><span style='font-weight:400;font-size:0.9em;color:#607d8b'>(Meta: 95%)</span></th>
                <th>RESOLUCION SNL<br><span style='font-weight:400;font-size:0.9em;color:#607d8b'>(Meta: 90%)</span></th>
              </tr>
            </thead>
            <tbody>
      `;
      const currentEjecutivosNotaEPA = selName ? ejecutivosNotaEPA.filter(e => e.nombre === selName) : ejecutivosNotaEPA;
      currentEjecutivosNotaEPA.forEach((ej, idx) => {
        let color = 'red';
        let flecha = '▼';
        let flechaColor = '#C62828';
        const pct = ej.ep * 100;
        if (pct >= 95 && pct <= 100) {
          color = 'green';
          flecha = '▲';
          flechaColor = '#2E7D32';
        } else if (pct >= 92 && pct < 95) {
          color = 'amber';
          flecha = '▼';
          flechaColor = '#F9A825';
        } else {
          color = 'red';
          flecha = '▼';
          flechaColor = '#C62828';
        }
        tablaEjecutivosNotaEPA += `
          <tr class="${color}" tabindex="0">
            <td>${ej.nombre}</td>
            <td><span style="font-weight:700;">${(ej.ep * 100).toFixed(2)}%</span> <span style="color:${flechaColor};font-size:1.2em;vertical-align:middle;">${flecha}</span></td>
            <td><span style="font-weight:700;">${(ej.ep_res * 100).toFixed(2)}%</span> <span style="color:${(ej.ep_res * 100) >= 90 ? '#2E7D32' : (ej.ep_res * 100) >= 85 ? '#F9A825' : '#C62828'};font-size:1.2em;vertical-align:middle;">${(ej.ep_res * 100) >= 90 ? '▲' : '▼'}</span></td>
            <td><span style="font-weight:700;">${(ej.snl * 100).toFixed(2)}%</span> <span style="color:${(ej.snl * 100) >= 95 ? '#2E7D32' : (ej.snl * 100) >= 92 ? '#F9A825' : '#C62828'};font-size:1.2em;vertical-align:middle;">${(ej.snl * 100) >= 95 ? '▲' : '▼'}</span></td>
            <td><span style="font-weight:700;">${(ej.snl_res * 100).toFixed(2)}%</span> <span style="color:${(ej.snl_res * 100) >= 90 ? '#2E7D32' : (ej.snl_res * 100) >= 85 ? '#F9A825' : '#C62828'};font-size:1.2em;vertical-align:middle;">${(ej.snl_res * 100) >= 90 ? '▲' : '▼'}</span></td>
          </tr>
        `;
      });
      tablaEjecutivosNotaEPA += '</tbody></table></div></section>';


      const countEP = currentEjecutivosNotaEPA.length || 1;
      const avgEP = currentEjecutivosNotaEPA.reduce((acc, cur) => acc + cur.ep, 0) / countEP;
      const avgEPRes = currentEjecutivosNotaEPA.reduce((acc, cur) => acc + cur.ep_res, 0) / countEP;
      const avgSNL = currentEjecutivosNotaEPA.reduce((acc, cur) => acc + cur.snl, 0) / countEP;
      const avgSNLRes = currentEjecutivosNotaEPA.reduce((acc, cur) => acc + cur.snl_res, 0) / countEP;

      const notaEpaResumenHtml = `
        <div class="kpi-card ${avgEP >= 0.95 ? 'green' : avgEP >= 0.92 ? 'amber' : 'red'}" tabindex="0" aria-label="Nota EPA SNL/EP Resumen" style="grid-column: span 1; max-width: 100%;">
          <div class="kpi-title">
            Nota EPA SNL/EP
            <span class="kpi-chip ${avgEP >= 0.95 ? 'green' : avgEP >= 0.92 ? 'amber' : 'red'}" title="Estado general de Satisfacción EP">${avgEP >= 0.95 ? '✔' : avgEP >= 0.92 ? '⚠' : '✖'}</span>
          </div>
          <div class="kpi-value" style="font-size: 1.1em; flex-direction: column; align-items: flex-start; gap: 0.2em;">
            <div style="display:flex; justify-content: space-between; width: 100%;">
              <span>Satisf. EP: <b>${(avgEP * 100).toFixed(2)}%</b></span>
              <span style="font-size:0.7em; font-weight:400; color:#607d8b;">Meta: 95%</span>
            </div>
            <div style="display:flex; justify-content: space-between; width: 100%;">
              <span>Resol. EP: <b>${(avgEPRes * 100).toFixed(2)}%</b></span>
              <span style="font-size:0.7em; font-weight:400; color:#607d8b;">Meta: 90%</span>
            </div>
            <div style="display:flex; justify-content: space-between; width: 100%; border-top: 1px solid var(--kpi-line); padding-top: 0.2em; margin-top: 0.1em;">
              <span>Satisf. SNL: <b>${(avgSNL * 100).toFixed(2)}%</b></span>
              <span style="font-size:0.7em; font-weight:400; color:#607d8b;">Meta: 95%</span>
            </div>
            <div style="display:flex; justify-content: space-between; width: 100%;">
              <span>Resol. SNL: <b>${(avgSNLRes * 100).toFixed(2)}%</b></span>
              <span style="font-size:0.7em; font-weight:400; color:#607d8b;">Meta: 90%</span>
            </div>
          </div>
        </div>
      `;

      // Renderizar todo
      // Insertar el resumen de Nota EPA justo antes de la sección de TMO en el grid si es posible, 
      // o simplemente como primer elemento si se desea "al principio de tmo".
      // Dado que kpiCards es un string de <section class="dashboard-grid">, 
      // vamos a reconstruir kpiCards para que Nota EPA aparezca antes de TMO.

      let kpiCardsReordenado = '<section class="dashboard-grid" aria-label="KPIs principales">';
      // Primero agregamos Nota EPA
      kpiCardsReordenado += notaEpaResumenHtml;

      // Luego agregamos los demás KPIs (tipificaciones, epa, tmo)
      kpiStats.forEach((stat, idx) => {
        const color = getColorByDeviation(stat.dev, kpiStats[0].dev, idx, config.color_green, config.color_amber, stat.actual, stat.meta, stat.kpi);
        const devPct = deviationPct(stat.actual, stat.meta, config.deviation_method, stat.kpi);
        kpiCardsReordenado += `
        <div class="kpi-card ${color}" tabindex="0" aria-label="${getKpiLabel(stat.kpi)}">
          <div class="kpi-title">
            ${getKpiLabel(stat.kpi)}
            <span class="kpi-chip ${color}" title="Estado respecto a la meta">${color === 'green' ? '✔' : color === 'amber' ? '⚠' : '✖'}</span>
          </div>
          <div class="kpi-value">
            ${stat.kpi === 'tmo' ? roundMin(stat.actual) : Math.round(stat.actual * 100) + '%'}
            <span style="font-size:0.6em;font-weight:400;">Meta: ${stat.kpi === 'tmo' ? roundMin(stat.meta) : Math.round(stat.meta * 100) + '%'}</span>
          </div>
          <div class="kpi-meta">
            <span title="Desviación numérica">Desviación: <b>${stat.kpi === 'tmo' ? (stat.actual - stat.meta).toFixed(2) + ' min' : (Math.round((stat.actual - stat.meta) * 100) + '%')}</b></span>
            <span title="Desviación normalizada">Desviación %: <b>${Math.round(devPct)}%</b></span>
          </div>
          <canvas class="kpi-sparkline" id="sparkline-${stat.kpi}" aria-label="Evolución de ${getKpiLabel(stat.kpi)}" tabindex="0"></canvas>
        </div>`;
      });
      kpiCardsReordenado += '</section>';

      // Insertar Podium al principio
      const finalHtml = filtroHtml + (selName ? '' : podiumHtml) + kpiCardsReordenado + kpiGraphs + serieTemporal + tablaEjecutivos + tablaEjecutivosEPA + tablaEjecutivosTMO + tablaEjecutivosNotaEPA;
      root.innerHTML = finalHtml;
      asignarListenersSubmenus();
      // Renderizar sparklines
      kpiStats.forEach(stat => renderSparkline(`sparkline-${stat.kpi}`, stat.kpi));
      ejecutivos.forEach(ej => renderSparklineEjecutivo(`sparkline-ej-${ej.id}`, ej, kpiFocus));
      // Sparklines EPA
      // Sparklines TMO
      ejecutivosTMO.forEach(ej => renderSparklineEjecutivo(`sparkline-ej-tmo-${ej.id}`, ej, 'tmo'));
      ejecutivosEPA.forEach(ej => renderSparklineEjecutivo(`sparkline-ej-epa-${ej.id}`, ej, 'epa'));
      // Sparklines Nota EPA
      ejecutivosNotaEPA.forEach(ej => renderSparklineEjecutivo(`sparkline-ej-notaepa-${ej.id}`, ej, 'epa'));
      // Renderizar gráficos principales
      renderChartTipificaciones(kpiStats.find(k => k.kpi === 'tipificaciones'));
      renderChartEPA(kpiStats.find(k => k.kpi === 'epa'));
      renderChartTMO(kpiStats.find(k => k.kpi === 'tmo'));
      // Renderizar serie temporal
      renderChartSerie(serieLabels, serieTip, serieEpa, serieTmo, resumen);
      // Listeners
      const granSelect = document.getElementById('granularity-select');
      if (granSelect) {
        granSelect.onchange = e => {
          window.kpiGranularity = e.target.value;
          renderDashboard();
        };
      }
      // Asignar listeners de submenús de ejecutivos de forma robusta
      // Re-aplicar estados de expansión
      const wrapperState = selName ? 'block' : (window.mostrarTodosExpandido ? 'block' : 'none');
      const toggleContent = selName ? '▼' : (window.mostrarTodosExpandido ? '▼' : '►');
      const btnMostrarText = selName ? 'Contraer todos' : (window.mostrarTodosExpandido ? 'Contraer todos' : 'Mostrar todos');

      ['tabla-ejecutivos-wrapper', 'tabla-ejecutivos-epa-wrapper', 'tabla-ejecutivos-tmo-wrapper', 'tabla-ejecutivos-notaepa-wrapper'].forEach(id => {
        const w = document.getElementById(id);
        if (w) w.style.display = wrapperState;
      });
      ['toggle-ejecutivos', 'toggle-ejecutivos-epa', 'toggle-ejecutivos-tmo', 'toggle-ejecutivos-notaepa'].forEach(id => {
        const b = document.getElementById(id);
        if (b) {
          b.textContent = toggleContent;
          b.setAttribute('aria-expanded', wrapperState === 'block' ? 'true' : 'false');
        }
      });
      const btnAll = document.getElementById('btn-mostrar-todos');
      if (btnAll) btnAll.textContent = btnMostrarText;

      // Asegurar que el select mantenga el valor y actualizar panel dinámico al cambiar
      const filterSelect = document.getElementById('filtro-ejecutivo');
      if (filterSelect) {
        filterSelect.value = selName;
        filterSelect.onchange = e => {
          window.selectedExecutive = e.target.value;
          renderDashboard();
        };
      }

      function asignarListenersSubmenus() {
        [
          { btn: 'toggle-ejecutivos', wrap: 'tabla-ejecutivos-wrapper' },
          { btn: 'toggle-ejecutivos-epa', wrap: 'tabla-ejecutivos-epa-wrapper' },
          { btn: 'toggle-ejecutivos-tmo', wrap: 'tabla-ejecutivos-tmo-wrapper' },
          { btn: 'toggle-ejecutivos-notaepa', wrap: 'tabla-ejecutivos-notaepa-wrapper' }
        ].forEach(({ btn, wrap }) => {
          const b = document.getElementById(btn);
          const w = document.getElementById(wrap);
          if (b && w) {
            b.onclick = function () {
              const expanded = b.getAttribute('aria-expanded') === 'true';
              b.setAttribute('aria-expanded', String(!expanded));
              if (expanded) {
                w.style.display = 'none';
                b.textContent = '►';
              } else {
                w.style.display = 'block';
                b.textContent = '▼';
              }
            };
          }
        });
      }
      asignarListenersSubmenus();

      // --- Integración Sistema Predictivo ---
      if (window.ejecutarAnalisisPredictivo) {
        setTimeout(window.ejecutarAnalisisPredictivo, 500);
      }
    }
    // --- Sparklines ---
    function renderSparkline(canvasId, kpi) {
      const canvas = document.getElementById(canvasId);
      if (!canvas) return;
      const serie = dashboardData.serie_diaria || [];
      const data = serie.map(s => kpi === 'tmo' ? s.tmo_min : s[kpi]);
      new Chart(canvas, {
        type: 'line',
        data: {
          labels: serie.map(s => formatDate(s.fecha)),
          datasets: [{
            data,
            borderColor: kpi === 'tmo' ? '#1976d2' : (kpi === 'epa' ? '#F9A825' : '#2E7D32'),
            backgroundColor: 'rgba(0,0,0,0)',
            pointRadius: 0,
            borderWidth: 2,
            tension: 0.3
          }]
        },
        options: {
          plugins: { legend: { display: false } },
          scales: { x: { display: false }, y: { display: false } },
          elements: { line: { borderJoinStyle: 'round' } },
          responsive: false,
          maintainAspectRatio: false
        }
      });
    }
    function renderSparklineEjecutivo(canvasId, ej, kpi) {
      const canvas = document.getElementById(canvasId);
      if (!canvas) return;
      const serie = (ej.serie || []).map(s => kpi === 'tmo' ? s.tmo_min : s[kpi]);
      new Chart(canvas, {
        type: 'line',
        data: {
          labels: (ej.serie || []).map(s => formatDate(s.fecha)),
          datasets: [{
            data: serie,
            borderColor: kpi === 'tmo' ? '#1976d2' : (kpi === 'epa' ? '#F9A825' : '#2E7D32'),
            backgroundColor: 'rgba(0,0,0,0)',
            pointRadius: 0,
            borderWidth: 2,
            tension: 0.3
          }]
        },
        options: {
          plugins: { legend: { display: false } },
          scales: { x: { display: false }, y: { display: false } },
          elements: { line: { borderJoinStyle: 'round' } },
          responsive: false,
          maintainAspectRatio: false
        }
      });
    }
    // --- Gráficos principales ---
    function renderChartTipificaciones(stat) {
      const canvas = document.getElementById('chart-tipificaciones');
      if (!canvas) return;
      const ctx = canvas.getContext('2d');
      new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Actual', 'Brecha'],
          datasets: [{
            data: [stat.actual, Math.max(0, stat.meta - stat.actual)],
            backgroundColor: ['#2E7D32', '#CFD8DC'],
            borderWidth: 0
          }]
        },
        options: {
          cutout: '70%',
          plugins: {
            legend: { display: false },
            annotation: {
              annotations: {
                metaLine: {
                  type: 'line',
                  borderColor: '#F9A825',
                  borderWidth: 3,
                  scaleID: 'r',
                  value: stat.meta,
                  borderDash: [6, 6],
                  label: {
                    display: true,
                    content: 'Meta',
                    color: '#F9A825',
                    position: 'end',
                    font: { weight: 'bold' }
                  }
                }
              }
            },
            tooltip: {
              callbacks: {
                label: ctx => ctx.label + ': ' + roundPct(ctx.parsed)
              }
            }
          }
        }
      });
    }
    function renderChartEPA(stat) {
      const ctx = document.getElementById('chart-epa').getContext('2d');
      new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Actual', 'Brecha'],
          datasets: [{
            data: [stat.actual, Math.max(0, stat.meta - stat.actual)],
            backgroundColor: ['#F9A825', '#CFD8DC'],
            borderWidth: 0
          }]
        },
        options: {
          cutout: '70%',
          plugins: {
            legend: { display: false },
            annotation: {
              annotations: {
                metaLine: {
                  type: 'line',
                  borderColor: '#2E7D32',
                  borderWidth: 3,
                  scaleID: 'r',
                  value: stat.meta,
                  borderDash: [6, 6],
                  label: {
                    display: true,
                    content: 'Meta',
                    color: '#2E7D32',
                    position: 'end',
                    font: { weight: 'bold' }
                  }
                }
              }
            },
            tooltip: {
              callbacks: {
                label: ctx => ctx.label + ': ' + roundPct(ctx.parsed)
              }
            }
          }
        }
      });
    }
    function renderChartTMO(stat) {
      const ctx = document.getElementById('chart-tmo').getContext('2d');
      new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Actual', 'Brecha'],
          datasets: [{
            data: [stat.actual, Math.max(0, stat.meta - stat.actual)],
            backgroundColor: ['#1976d2', '#CFD8DC'],
            borderWidth: 0
          }]
        },
        options: {
          rotation: -90,
          circumference: 180,
          cutout: '70%',
          plugins: {
            legend: { display: false },
            annotation: {
              annotations: {
                metaLine: {
                  type: 'line',
                  borderColor: '#C62828',
                  borderWidth: 3,
                  scaleID: 'r',
                  value: stat.meta,
                  borderDash: [6, 6],
                  label: {
                    display: true,
                    content: 'Meta',
                    color: '#C62828',
                    position: 'end',
                    font: { weight: 'bold' }
                  }
                }
              }
            },
            tooltip: {
              callbacks: {
                label: ctx => ctx.label + ': ' + roundMin(ctx.parsed)
              }
            }
          }
        }
      });
    }
    function renderChartSerie(labels, tip, epa, tmo, resumen) {
      const ctx = document.getElementById('chart-serie').getContext('2d');
      new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [
            {
              label: 'Tipificaciones',
              data: tip,
              borderColor: '#2E7D32',
              backgroundColor: 'rgba(46,125,50,0.08)',
              tension: 0.3,
              pointRadius: 2,
              yAxisID: 'y1'
            },
            {
              label: 'EPA',
              data: epa,
              borderColor: '#F9A825',
              backgroundColor: 'rgba(249,168,37,0.08)',
              tension: 0.3,
              pointRadius: 2,
              yAxisID: 'y1'
            },
            {
              label: 'TMO',
              data: tmo,
              borderColor: '#1976d2',
              backgroundColor: 'rgba(25,118,210,0.08)',
              tension: 0.3,
              pointRadius: 2,
              yAxisID: 'y2'
            }
          ]
        },
        options: {
          plugins: {
            legend: { position: 'top' },
            annotation: {
              annotations: {
                tipMeta: {
                  type: 'line',
                  yMin: resumen.tipificaciones?.meta ?? config.meta_tipificaciones,
                  yMax: resumen.tipificaciones?.meta ?? config.meta_tipificaciones,
                  borderColor: '#2E7D32',
                  borderWidth: 2,
                  borderDash: [6, 6],
                  label: {
                    display: true,
                    content: 'Meta Tipificaciones',
                    color: '#2E7D32',
                    position: 'start',
                    font: { weight: 'bold' }
                  }
                },
                epaMeta: {
                  type: 'line',
                  yMin: resumen.epa?.meta ?? config.meta_epa,
                  yMax: resumen.epa?.meta ?? config.meta_epa,
                  borderColor: '#F9A825',
                  borderWidth: 2,
                  borderDash: [6, 6],
                  label: {
                    display: true,
                    content: 'Meta EPA',
                    color: '#F9A825',
                    position: 'start',
                    font: { weight: 'bold' }
                  }
                },
                tmoMeta: {
                  type: 'line',
                  yMin: resumen.tmo?.meta_min ?? config.meta_tmo,
                  yMax: resumen.tmo?.meta_min ?? config.meta_tmo,
                  borderColor: '#1976d2',
                  borderWidth: 2,
                  borderDash: [6, 6],
                  label: {
                    display: true,
                    content: 'Meta TMO',
                    color: '#1976d2',
                    position: 'start',
                    font: { weight: 'bold' }
                  }
                }
              }
            },
            tooltip: {
              callbacks: {
                label: ctx => ctx.dataset.label + ': ' + (ctx.dataset.label === 'TMO' ? roundMin(ctx.parsed.y) : roundPct(ctx.parsed.y))
              }
            }
          },
          scales: {
            y1: {
              type: 'linear',
              position: 'left',
              min: 0, max: 1,
              title: { display: true, text: 'Porcentaje' },
              ticks: { callback: v => (v * 100).toFixed(0) + '%' }
            },
            y2: {
              type: 'linear',
              position: 'right',
              min: 0, max: 10,
              title: { display: true, text: 'TMO (min)' },
              grid: { drawOnChartArea: false },
              ticks: { callback: v => roundMin(v) }
            }
          }
        }
      });
    }
    // --- Configuración y eventos ---
    function openConfigPanel() {
      let clave = prompt('Ingrese la clave de acceso para la Configuración:');
      if (clave !== 'ADMIN2026') {
        alert('Clave incorrecta. Acceso denegado.');
        return;
      }
      document.getElementById('config-panel').classList.add('open');
      document.getElementById('config-panel').focus();
      // Cargar valores actuales
      document.getElementById('meta-tipificaciones').value = roundPctNum(config.meta_tipificaciones);
      document.getElementById('meta-epa').value = roundPctNum(config.meta_epa);
      document.getElementById('meta-tmo').value = config.meta_tmo;
      document.getElementById('deviation-method').value = config.deviation_method;
      document.getElementById('color-green').value = (config.color_green * 100).toFixed(1);
      document.getElementById('color-amber').value = (config.color_amber * 100).toFixed(1);
      document.getElementById('date-range').value = config.date_range || '';
      document.getElementById('kpi-focus').value = config.kpi_focus;
    }
    function closeConfigPanel() {
      document.getElementById('config-panel').classList.remove('open');
    }
    function applyConfigForm(e) {
      e.preventDefault();
      config.meta_tipificaciones = clamp(Number(document.getElementById('meta-tipificaciones').value) / 100, 0, 1);
      config.meta_epa = clamp(Number(document.getElementById('meta-epa').value) / 100, 0, 1);
      config.meta_tmo = clamp(Number(document.getElementById('meta-tmo').value), 0, 60);
      config.deviation_method = document.getElementById('deviation-method').value;
      config.color_green = clamp(Number(document.getElementById('color-green').value) / 100, 0, 1);
      config.color_amber = clamp(Number(document.getElementById('color-amber').value) / 100, 0, 1);
      config.date_range = document.getElementById('date-range').value.trim() || null;
      config.kpi_focus = document.getElementById('kpi-focus').value;
      closeConfigPanel();
      renderDashboard();
    }
    function resetConfigForm() {
      config = { ...DEFAULTS };
      closeConfigPanel();
      renderDashboard();
    }
    // --- Tema claro/oscuro ---
    function setTheme(t) {
      theme = t;
      document.documentElement.setAttribute('data-theme', t);
      localStorage.setItem('achs-theme', t);
      document.getElementById('theme-toggle').textContent = t === 'dark' ? '☀️' : '🌙';
    }
    // --- Tooltips accesibles ---
    function setupTooltips() {
      const tooltip = document.getElementById('kpi-tooltip');
      document.body.addEventListener('mouseover', e => {
        const el = e.target.closest('[title]');
        if (el && el.title) {
          tooltip.textContent = el.title;
          tooltip.style.left = (e.pageX + 12) + 'px';
          tooltip.style.top = (e.pageY + 12) + 'px';
          tooltip.classList.add('visible');
          tooltip.setAttribute('aria-hidden', 'false');
        }
      });
      document.body.addEventListener('mousemove', e => {
        if (tooltip.classList.contains('visible')) {
          tooltip.style.left = (e.pageX + 12) + 'px';
          tooltip.style.top = (e.pageY + 12) + 'px';
        }
      });
      document.body.addEventListener('mouseout', e => {
        tooltip.classList.remove('visible');
        tooltip.setAttribute('aria-hidden', 'true');
      });
    }
    // --- Inicialización ---
    function loadDemoData() {
      const el = document.getElementById('demo-data');
      if (!el) return null;
      try {
        return JSON.parse(el.textContent);
      } catch {
        return null;
      }
    }
    // --- Componente Evolutivo (3 meses) ---
    let evolutivoChart = null;
    let currentEvolutivoExec = null;
    let currentEvolutivoKPI = 'nota_epa';

    // --- MANTENEDOR DE DATOS (NUEVO) ---
    const M_METRICS = [
      { key: 'tmo', label: 'TMO' },
      { key: 'epa', label: 'Transferencia a EPA' },
      { key: 'tipificaciones', label: 'Tipificaciones' },
      { key: 'satisfaccion_ep', label: 'Satisfacción EP' },
      { key: 'resolucion_ep', label: 'Resolución EP' },
      { key: 'satisfaccion_snl', label: 'Satisfacción SNL' },
      { key: 'resolucion_snl', label: 'Resolución SNL' }
    ];

    function getDynamicExecutives() {
      // Obtenemos todos los nombres únicos de los ejecutivos guardados en maintainerData
      // Nombres a excluir explícitamente del listado (por privacidad o limpieza)
      const EXCLUDED_NAMES = [
        "Gutiérrez Bermúdez Elizabeth Caterina",
        "Vásquez Suárez Constanza Camily",
        "Vasquez Suarez Constanza Camily"
      ];
      const names = new Set();
      Object.keys(maintainerData).forEach(metric => {
        if (maintainerData[metric]) {
          Object.keys(maintainerData[metric]).forEach(name => {
            if (!EXCLUDED_NAMES.includes(name)) names.add(name);
          });
        }
      });
      return Array.from(names).sort();
    }

    function getExecListForDashboard() {
      const latestField = 'm' + (M_MONTH_LABELS ? M_MONTH_LABELS.length : 3);
      return getDynamicExecutives().map(name => {
        return {
          nombre: name,
          tipificaciones_actual: (maintainerData.tipificaciones?.[name]?.[latestField] || 0) / 100,
          epa_actual: (maintainerData.epa?.[name]?.[latestField] || 0) / 100,
          tmo_min_actual: maintainerData.tmo?.[name]?.[latestField] || 0,
          q_llamadas: 0,
          serie: []
        };
      });
    }

    let maintainerData = JSON.parse(localStorage.getItem('achs-maintainer-data')) || {};
    let currentMaintainerMetric = 'nota_epa';

    // Meses dinámicos (Últimos 5 meses, incluyendo el mes actual)
    const M_MONTH_LABELS = (function () {
      const labels = [];
      for (let i = 4; i >= 0; i--) {
        const d = new Date();
        d.setMonth(d.getMonth() - i);
        const name = getShiftedMonth(d, { month: 'long' }, 'es-ES');
        labels.push(name.charAt(0).toUpperCase() + name.slice(1));
      }
      return labels;
    })();
    window.M_MONTH_LABELS = M_MONTH_LABELS;
    window.maintainerData = maintainerData;

    function updateDynamicLabels() {
      // Headers Historial (orden cronológico: m1, m2, m3, m4, m5)
      if (document.getElementById('th-m1')) document.getElementById('th-m1').textContent = M_MONTH_LABELS[0].toUpperCase();
      if (document.getElementById('th-m2')) document.getElementById('th-m2').textContent = M_MONTH_LABELS[1].toUpperCase();
      if (document.getElementById('th-m3')) document.getElementById('th-m3').textContent = M_MONTH_LABELS[2].toUpperCase();
      if (document.getElementById('th-m4')) document.getElementById('th-m4').textContent = M_MONTH_LABELS[3].toUpperCase();
      if (document.getElementById('th-m5')) document.getElementById('th-m5').textContent = M_MONTH_LABELS[4].toUpperCase();
      // Radio Labels Actualizar (m1..m5 en secuencia cronológica)
      if (document.getElementById('label-m1')) document.getElementById('label-m1').textContent = M_MONTH_LABELS[0];
      if (document.getElementById('label-m2')) document.getElementById('label-m2').textContent = M_MONTH_LABELS[1];
      if (document.getElementById('label-m3')) document.getElementById('label-m3').textContent = M_MONTH_LABELS[2];
      if (document.getElementById('label-m4')) document.getElementById('label-m4').textContent = M_MONTH_LABELS[3];
      if (document.getElementById('label-m5')) document.getElementById('label-m5').textContent = M_MONTH_LABELS[4];
      // Descripciones
      const labelsFormat = document.querySelectorAll('input[name="import-format"] + span, input[name="import-format"]');
      // Buscamos el texto específico en el label
      const format4 = document.querySelector('input[name="import-format"][value="4cols"]').parentElement;
      if (format4) format4.innerHTML = `<input type="radio" name="import-format" value="4cols" checked> Ejecutivo, ${M_MONTH_LABELS[0]}, ${M_MONTH_LABELS[1]}, ${M_MONTH_LABELS[2]}, ${M_MONTH_LABELS[3]}, ${M_MONTH_LABELS[4]}`;
    }

    function initMaintainerData() {
      // 1. Asegurar que todas las métricas existan
      M_METRICS.forEach(m => {
        if (!maintainerData[m.key]) maintainerData[m.key] = {};
      });
      // 2. Asegurar que todos los ejecutivos existan en todas las métricas
      const allNames = getDynamicExecutives();
      allNames.forEach(name => {
        M_METRICS.forEach(m => {
          if (!maintainerData[m.key][name]) {
            maintainerData[m.key][name] = { m1: 0, m2: 0, m3: 0, m4: 0, m5: 0 };
          } else {
            // Asegurar que tenga todos los campos m1..m5
            if (maintainerData[m.key][name].m1 === undefined) maintainerData[m.key][name].m1 = 0;
            if (maintainerData[m.key][name].m2 === undefined) maintainerData[m.key][name].m2 = 0;
            if (maintainerData[m.key][name].m3 === undefined) maintainerData[m.key][name].m3 = 0;
            if (maintainerData[m.key][name].m4 === undefined) maintainerData[m.key][name].m4 = 0;
            if (maintainerData[m.key][name].m5 === undefined) maintainerData[m.key][name].m5 = 0;
          }
        });
      });
    }

    function saveMaintainerData() {
      localStorage.setItem('achs-maintainer-data', JSON.stringify(maintainerData));
    }

    // --- Historial (Edición Manual) ---
    function renderHistorialTable(filter = "") {
      const tbody = document.getElementById('historial-tbody');
      const data = maintainerData[currentMaintainerMetric];

      tbody.innerHTML = getDynamicExecutives()
        .filter(name => name.toLowerCase().includes(filter.toLowerCase()))
        .map(name => {
          const vals = data[name] || { m1: 0, m2: 0, m3: 0, m4: 0, m5: 0 };
          const avg = ((vals.m1 + vals.m2 + vals.m3 + vals.m4 + vals.m5) / 5).toFixed(2);
          return `
            <tr>
              <td style="text-align:left; font-weight:600;">${name}</td>
              <td><input type="number" step="0.01" value="${vals.m1}" oninput="updateMVal('${name}', 'm1', this.value)"></td>
              <td><input type="number" step="0.01" value="${vals.m2}" oninput="updateMVal('${name}', 'm2', this.value)"></td>
              <td><input type="number" step="0.01" value="${vals.m3}" oninput="updateMVal('${name}', 'm3', this.value)"></td>
              <td><input type="number" step="0.01" value="${vals.m4}" oninput="updateMVal('${name}', 'm4', this.value)"></td>
              <td><input type="number" step="0.01" value="${vals.m5}" oninput="updateMVal('${name}', 'm5', this.value)"></td>
              <td id="avg-${name.replace(/\s/g, '')}" style="font-weight:700; color:var(--achs-primary);">${avg}</td>
              <td style="text-align:center;">
                <button onclick="deleteExecutive('${name}')" title="Eliminar ejecutivo permanentemente" style="background:none;border:none;cursor:pointer;font-size:1.1em;">🗑️</button>
              </td>
            </tr>
          `;
        }).join('');
    }

    window.updateMVal = function (name, field, val) {
      const num = parseFloat(val) || 0;
      maintainerData[currentMaintainerMetric][name][field] = num;
      // Actualizar promedio visualmente
      const vals = maintainerData[currentMaintainerMetric][name];
      const avg = ((vals.m1 + vals.m2 + vals.m3 + vals.m4 + (vals.m5 || 0)) / 5).toFixed(2);
      const avgEl = document.getElementById(`avg-${name.replace(/\s/g, '')}`);
      if (avgEl) avgEl.textContent = avg;
    };

    window.deleteExecutive = function (name) {
      if (!confirm(`¿Estás seguro de que deseas eliminar a ${name} de todas las métricas? Esta acción no se puede deshacer.`)) return;

      M_METRICS.forEach(m => {
        if (maintainerData[m.key] && maintainerData[m.key][name]) {
          delete maintainerData[m.key][name];
        }
      });
      saveMaintainerData();
      renderHistorialTable(document.getElementById('historial-search').value);
      // Actualizar datos evolutivos y dashboard 
      window.evolutivoRawData = generateEvolutivoData();
      renderDashboard();
      alert(`Ejecutivo ${name} eliminado correctamente.`);
    };

    function setupMaintainerTabs() {
      const tabs = document.getElementById('historial-tabs');
      tabs.innerHTML = M_METRICS.map(m => `
        <div class="m-tab ${m.key === currentMaintainerMetric ? 'active' : ''}" data-metric="${m.key}">${m.label}</div>
      `).join('');

      tabs.onclick = (e) => {
        const tab = e.target.closest('.m-tab');
        if (tab) {
          currentMaintainerMetric = tab.dataset.metric;
          setupMaintainerTabs();
          renderHistorialTable(document.getElementById('historial-search').value);
        }
      };

      // Select de importación
      const impSelect = document.getElementById('import-metric');
      impSelect.innerHTML = M_METRICS.map(m => `<option value="${m.key}">${m.label}</option>`).join('');
    }

    // --- Importación Excel (Parser) ---
    function normalizeName(n) {
      return n.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
    }

    // Parsea un valor pegado desde Excel/CSV y acepta comas como decimales y '%' opcional.
    function parseImportNumber(raw) {
      if (raw === null || raw === undefined) return 0;
      let s = String(raw).trim();
      if (s === '') return 0;
      // Eliminar símbolo de porcentaje y espacios, convertir coma a punto
      s = s.replace('%', '').replace(/\s+/g, '').replace(',', '.');
      // Intentar parsear número
      const n = parseFloat(s);
      return isNaN(n) ? 0 : n;
    }

    function fuzzyMatch(name) {
      const normInput = normalizeName(name);
      const execList = getDynamicExecutives();
      // Prueba exacta
      let match = execList.find(e => normalizeName(e) === normInput);
      if (match) return { name: match, type: 'exact' };

      // Prueba por inclusión
      match = execList.find(e => normalizeName(e).includes(normInput) || normInput.includes(normalizeName(e)));
      if (match) return { name: match, type: 'fuzzy' };

      return null;
    }

    function handleExcelPaste() {
      const input = document.getElementById('import-input').value;
      const metric = document.getElementById('import-metric').value;
      const format = document.querySelector('input[name="import-format"]:checked').value;
      const targetMonth = document.querySelector('input[name="target-month"]:checked').value;

      if (!input.trim()) return;

      const lines = input.trim().split('\n');
      const results = [];
      let validCount = 0;

      lines.forEach(line => {
        // Intentar separar por tabulador primero (pegado desde Excel), luego por punto y coma,
        // y por último por comas. Si se usaron comas como separador pero el valor contiene
        // una coma decimal (ej. "95,25"), intentamos recomponerlo.
        let parts = line.split('\t');
        if (parts.length === 1) parts = line.split(';');
        if (parts.length === 1) parts = line.split(',');
        parts = parts.map(p => p.trim());
        // Recombinar posible coma decimal si se detectó separación por comas incorrecta
        if (line.indexOf(',') !== -1 && line.indexOf('\t') === -1 && parts.length > 2) {
          // Buscar patrón numérico dividido: ej. ['Nombre','95','25'] -> recomponer '95,25'
          const maybeNum = parts[1];
          const maybeFrac = parts[2];
          if (/^\d+$/.test(maybeNum) && /^\d+$/.test(maybeFrac) && maybeNum.length <= 3 && maybeFrac.length <= 3) {
            parts[1] = maybeNum + ',' + maybeFrac;
            parts.splice(2, 1);
          }
        }
        if (parts.length < 2) return;

        const nameInput = parts[0];
        let match = fuzzyMatch(nameInput);

        let rowData = {
          originalName: nameInput,
          matchedName: match ? match.name : nameInput, // Si no hay match, usamos el nombre tal cual (NUEVO)
          status: match ? (match.type === 'exact' ? 'match' : 'warning') : 'new',
          vals: []
        };

        if (format === '4cols') {
          if (M_MONTH_LABELS && M_MONTH_LABELS.length >= 5) {
            rowData.vals = [parseImportNumber(parts[1]), parseImportNumber(parts[2]), parseImportNumber(parts[3]), parseImportNumber(parts[4]), parseImportNumber(parts[5])];
          } else {
            rowData.vals = [parseImportNumber(parts[1]), parseImportNumber(parts[2]), parseImportNumber(parts[3]), parseImportNumber(parts[4])];
          }
        } else {
          rowData.vals = [parseImportNumber(parts[1])];
        }

        validCount++;
        results.push(rowData);
      });

      renderImportPreview(results, format, targetMonth);
    }

    function renderImportPreview(results, format, targetMonth) {
      const container = document.getElementById('import-preview-list');
      const summary = document.getElementById('import-summary');
      const applyBtn = document.getElementById('btn-actualizar-apply');

      const metric = document.getElementById('import-metric') ? document.getElementById('import-metric').value : '';
      function fmt(v) {
        if (v === null || v === undefined) return '0.00';
        const n = Number(v) || 0;
        return n.toFixed(2);
      }

      document.getElementById('import-preview-container').style.display = 'block';

      summary.innerHTML = `Detectadas <b>${results.length}</b> filas válidas para actualizar. Los nombres se han normalizado según el listado oficial.`;

      const headerHtml = `
        <div class="preview-row" style="font-weight:700; background:var(--kpi-table-bg); border-bottom:2px solid var(--kpi-line);">
          <div>EJECUTIVO</div>
          <div>${format === '4cols' ? M_MONTH_LABELS[0] : (targetMonth ? M_MONTH_LABELS[parseInt(targetMonth.replace('m', '')) - 1] : 'VALOR')}</div>
          <div>${format === '4cols' ? M_MONTH_LABELS[1] : '-'}</div>
          <div>${format === '4cols' ? M_MONTH_LABELS[2] : '-'}</div>
          <div>${format === '4cols' ? M_MONTH_LABELS[3] : '-'}</div>
          <div>${format === '4cols' ? M_MONTH_LABELS[4] : '-'}</div>
          <div style="text-align:right;">ESTADO</div>
        </div>
      `;

      container.innerHTML = headerHtml + results.map(r => `
        <div class="preview-row ${r.status}">
          <div title="Original: ${r.originalName}">${r.matchedName}</div>
          <div>${fmt(r.vals[0])}</div>
          <div>${format === '4cols' ? fmt(r.vals[1]) : '-'}</div>
          <div>${format === '4cols' ? fmt(r.vals[2]) : '-'}</div>
          <div>${format === '4cols' ? fmt(r.vals[3]) : '-'}</div>
          <div style="text-align:right;">${r.status === 'match' ? 'EXACTO' : (r.status === 'warning' ? 'APROXIMADO' : 'NUEVO')}</div>
        </div>
      `).join('');

      applyBtn.disabled = results.every(r => r.status === 'error');
      applyBtn.style.background = applyBtn.disabled ? '#bdbdbd' : 'var(--achs-primary)';
      applyBtn.style.cursor = applyBtn.disabled ? 'not-allowed' : 'pointer';

      // Guardamos resultados temporalmente para el botón aplicar
      window.lastImportResults = { results, format, targetMonth, metric: document.getElementById('import-metric').value };
    }

    function applyImport() {
      const { results, format, targetMonth, metric } = window.lastImportResults;
      results.forEach(r => {
        // Asegurar que el ejecutivo exista en todas las métricas si es nuevo
        M_METRICS.forEach(m => {
          if (!maintainerData[m.key][r.matchedName]) {
            maintainerData[m.key][r.matchedName] = { m1: 0, m2: 0, m3: 0, m4: 0, m5: 0 };
          }
        });

        if (format === '4cols') {
          maintainerData[metric][r.matchedName] = { m1: r.vals[0], m2: r.vals[1], m3: r.vals[2], m4: r.vals[3], m5: (r.vals[4] || 0) };
        } else {
          maintainerData[metric][r.matchedName][targetMonth] = r.vals[0];
        }
      });
      saveMaintainerData();
      window.evolutivoRawData = generateEvolutivoData(); // Actualizar datos evolutivos
      alert('Datos actualizados correctamente.');
      document.getElementById('import-input').value = "";
      document.getElementById('import-preview-container').style.display = 'none';
      document.getElementById('modal-actualizar').classList.remove('open');
      renderDashboard();
    }

    function generateEvolutivoData() {
      const data = [];
      const names = getDynamicExecutives();
      if (names.length === 0) return [];

      // M_MONTH_LABELS contiene los últimos 4 meses cerrados (nombres)
      // Usaremos fechas ficticias que correspondan a esos meses para que Chart.js las ordene
      const today = new Date();
      const monthDates = [
        new Date(today.getFullYear(), today.getMonth() - 4, 1),
        new Date(today.getFullYear(), today.getMonth() - 3, 1),
        new Date(today.getFullYear(), today.getMonth() - 2, 1),
        new Date(today.getFullYear(), today.getMonth() - 1, 1),
        new Date(today.getFullYear(), today.getMonth(), 1)
      ];

      names.forEach(name => {
        monthDates.forEach((date, idx) => {
          const mKey = `m${idx + 1}`;
          const row = {
            nombre: name,
            fecha: date.toISOString().split('T')[0]
          };
          // Agregar todas las métricas dinámicamente
          M_METRICS.forEach(metric => {
            row[metric.key] = maintainerData[metric.key]?.[name]?.[mKey] || 0;
          });
          data.push(row);
        });
      });
      return data;
    }

    window.evolutivoRawData = generateEvolutivoData();

    window.openGuionEpa = function () {
      document.getElementById('modal-guion-epa').classList.add('open');
    };

    window.closeGuionEpa = function () {
      document.getElementById('modal-guion-epa').classList.remove('open');
    };

    function getMetrics(name, kpiKey) {
      const series = evolutivoRawData.filter(d => d.nombre === name).sort((a, b) => new Date(a.fecha) - new Date(b.fecha));
      if (series.length === 0) return null;

      const values = series.map(s => s[kpiKey]);
      const first = values[0], last = values[values.length - 1];
      const diffPct = ((last - first) / (first || 1)) * 100;
      const n = values.length;
      let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0;
      for (let i = 0; i < n; i++) {
        sumX += i; sumY += values[i]; sumXY += i * values[i]; sumX2 += i * i;
      }
      const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
      let tag = "estable";
      if (kpiKey === 'tmo') {
        if (diffPct <= -10 && slope < 0) tag = "mejorando";
        else if (diffPct >= 10 && slope > 0) tag = "empeorando";
      } else {
        if (diffPct >= 10 && slope > 0) tag = "mejorando";
        else if (diffPct <= -10 && slope < 0) tag = "empeorando";
      }
      return {
        series, last, first, diffPct, slope, tag,
        max: kpiKey === 'tmo' ? Math.min(...values) : Math.max(...values),
        // Calcular promedio de los últimos 3 meses (aprox 13 semanas)
        avg3m: values.slice(-13).reduce((a, b) => a + b, 0) / Math.min(values.length, 13),
        fechas: series.map(s => s.fecha)
      };
    }

    window.showEvolutivoDetail = function (name, kpiKey = currentEvolutivoKPI) {
      currentEvolutivoExec = name;
      currentEvolutivoKPI = kpiKey;
      const m = getMetrics(name, kpiKey);
      if (!m) return;
      document.querySelectorAll('.kpi-tab').forEach(btn => btn.classList.toggle('active', btn.dataset.kpi === kpiKey));
      document.getElementById('evolutivo-empty').style.display = 'none';
      document.getElementById('evolutivo-detail').style.display = 'block';
      document.getElementById('evolutivo-detail-name').textContent = name;
      document.getElementById('evolutivo-detail-trend').innerHTML = `<span class="trend-tag trend-${m.tag}">${m.tag.toUpperCase()}</span>`;
      const formatVal = (v) => kpiKey === 'tmo' ? v.toFixed(2) + ' min' : Math.round(v) + '%';
      document.getElementById('ev-val-last').textContent = formatVal(m.last);
      document.getElementById('ev-val-avg').textContent = formatVal(m.avg3m);
      // Mostrar el mes correspondiente al mejor valor
      if (m.max != null && m.series && m.series.length) {
        let idx = m.series.findIndex(v => v === m.max);
        let fecha = (m.fechas && m.fechas[idx]) || null;
        let mes = '-';
        if (fecha) {
          let d = new Date(fecha);
          mes = getShiftedMonth(d, { month: 'long' }, 'es-ES') + ' ' + d.getFullYear();
        }
        document.getElementById('ev-val-max').textContent = mes + ' (' + formatVal(m.max) + ')';
      } else {
        document.getElementById('ev-val-max').textContent = formatVal(m.max);
      }
      const diffEl = document.getElementById('ev-val-diff');
      diffEl.textContent = (m.diffPct > 0 ? '+' : '') + Math.round(m.diffPct) + '%';
      diffEl.style.color = (kpiKey === 'tmo' ? m.diffPct < 0 : m.diffPct > 0) ? '#2e7d32' : '#c62828';
      const kpiLabel = getKpiLabel(kpiKey);

      function generatePlanDeMejora(name, kpiKey, m) {
        let meta = getKpiMetaValue(kpiKey, dashboardData.resumen);
        const actual = m.last;
        const trend = m.tag;
        const isTmo = kpiKey === 'tmo';
        if (!isTmo) meta = meta * 100;

        const cumple = isTmo ? (actual <= meta) : (actual >= meta);
        const brecha = Math.abs(actual - meta);

        // Determinar Nivel (GOLD, SILVER, BRONZE, CRITICAL)
        let status = "CRITICAL";
        if (cumple) {
          status = brecha <= (isTmo ? 0.5 : 5) ? "GOLD" : "SILVER";
        } else {
          status = brecha >= (isTmo ? 0.5 : 5) ? "CRITICAL" : "BRONZE";
        }

        const kpiActions = {
          tmo: {
            focus: "Eficiencia y Control de Tiempos",
            steps: ["Identificar cuellos de botella en la post-llamada.", "Optimizar el uso de scripts de respuesta rápida.", "Reducir silencios prolongados mediante parafraseo."],
            phrases: ["Sr/Sra [Nombre], mientras valido la información en sistema...", "Para agilizar su solicitud, voy a proceder con..."]
          },
          satisfaccion_ep: {
            focus: "Pilares de Experiencia (EP)",
            steps: ["Empatía: Validar la emoción del paciente al inicio.", "Resolución: Evitar que el paciente repita su historia.", "Cierre: Confirmar si todas las dudas fueron resueltas."],
            phrases: ["Comprendo perfectamente su situación, vamos a darle prioridad.", "¿Hay algo adicional en lo que pueda apoyarle hoy?"]
          },
          epa: {
            focus: "Promoción de Encuesta",
            steps: ["Mencionar la encuesta como una herramienta de mejora para el ejecutivo.", "Explicar que solo son 2 preguntas (escala 1 a 7).", "Asegurar un cierre positivo antes de la transferencia."],
            phrases: ["Su valoración es fundamental para mi crecimiento profesional.", "Lo transferiré a una encuesta de 10 segundos, ¡agradezco su apoyo!"]
          },
          tipificaciones: {
            focus: "Precisión de Datos",
            steps: ["Validar el motivo de llamado antes de colgar.", "Evitar el uso de 'Otros' si existe una categoría específica.", "Asegurar que el resumen coincida con la tipificación."],
            phrases: ["Entonces, el motivo de su contacto es por [Motivo], ¿es correcto?"]
          },
          defecto: {
            focus: "Mejora Continua",
            steps: ["Revisar pauta de calidad vigente.", "Escucha de llamadas ejemplo con mejores prácticas.", "Feedback quincenal con supervisor."],
            phrases: ["Gracias por permitirnos mejorar nuestro servicio."]
          }
        };

        const action = kpiActions[kpiKey] || kpiActions.defecto;

        // Guardar el status calculado para usarlo en el diagnóstico de feedback
        window._lastPlanStatus = status;
        return `
          <div class="robust-plan">
            <div class="plan-header">
              <h4>🎯 Plan de Acción: ${getKpiLabel(kpiKey)}</h4>
              <div style="display:flex; align-items:center; gap:10px;">
                 <button onclick="openGuionEpa()" style="background:var(--achs-primary); color:white; border:none; padding:4px 8px; border-radius:4px; cursor:pointer; font-size:0.8em;">📜 Ver Guion EPA</button>
                 <span class="status-badge status-${status.toLowerCase()}">${status}</span>
              </div>
            </div>
            <div class="plan-body">
              <div>
                <div class="plan-section-title">🔍 Diagnóstico</div>
                <p style="font-size: 0.9em; margin:0 0 10px 0;">
                  El ejecutivo presenta un desempeño <span class="status-badge status-${status.toLowerCase()}" style="vertical-align:middle;">${status}</span> con una brecha de <b>${isTmo ? brecha.toFixed(2) : Math.round(brecha)} ${getKpiUnit(kpiKey)}</b> respecto a la meta.
                  La tendencia actual es <b>${trend.toUpperCase()}</b>.
                </p>
                <div class="plan-section-title">🗣️ Frase Sugerida</div>
                <div class="phrase-box">"${action.phrases[0]}"</div>
              </div>
              <div>
                <div class="plan-section-title">🚀 Acciones Prioritarias</div>
                <ul class="plan-list">
                  ${action.steps.map(s => `<li>${s}</li>`).join('')}
                </ul>
              </div>
            </div>
          </div>
        `;
      }

      const planEl = document.getElementById('ev-action-plan');
      planEl.innerHTML = generatePlanDeMejora(name, kpiKey, m);
      // Mostrar y rellenar ficha feedback
      const ficha = document.getElementById('ev-feedback-ficha');
      ficha.style.display = 'block';
      const fecha = new Date();
      const fechaStr = fecha.toLocaleDateString('es-CL', { year: 'numeric', month: 'long', day: 'numeric' });
      document.getElementById('ev-feedback-ficha-date').textContent = fechaStr;
      document.getElementById('ev-feedback-ficha-nombre').textContent = name;
      document.getElementById('ev-feedback-ficha-kpi').textContent = getKpiLabel(kpiKey);
      document.getElementById('ev-feedback-ficha-actual').textContent = kpiKey === 'tmo' ? m.last.toFixed(2) + ' min' : Math.round(m.last) + '%';
      let meta = getKpiMetaValue(kpiKey, dashboardData.resumen);
      if (kpiKey !== 'tmo') meta = Math.round(meta * 100);
      document.getElementById('ev-feedback-ficha-meta').textContent = kpiKey === 'tmo' ? meta.toFixed(2) + ' min' : meta + '%';
      const brecha = Math.abs(m.last - getKpiMetaValue(kpiKey, dashboardData.resumen));
      let status = 'CRITICAL';
      const isTmo = kpiKey === 'tmo';
      if (isTmo ? (m.last <= getKpiMetaValue(kpiKey, dashboardData.resumen)) : (m.last >= getKpiMetaValue(kpiKey, dashboardData.resumen))) {
        status = brecha <= (isTmo ? 0.5 : 5) ? 'GOLD' : 'SILVER';
      } else {
        status = brecha >= (isTmo ? 0.5 : 5) ? 'CRITICAL' : 'BRONZE';
      }
      // Usar el mismo status que el badge de arriba
      const badgeStatus = window._lastPlanStatus || status;
      document.getElementById('ev-feedback-ficha-diagnostico').innerHTML = `Desempeño <span class="status-badge status-${badgeStatus.toLowerCase()}" style="vertical-align:middle;">${badgeStatus}</span> (${isTmo ? m.last.toFixed(2) + ' min' : Math.round(m.last) + '%'}), brecha de <b>${isTmo ? brecha.toFixed(2) : Math.round(brecha)} ${getKpiUnit(kpiKey)}</b> respecto a la meta. Tendencia: <b>${m.tag.toUpperCase()}</b>.`;
      // Botón imprimir solo la ficha
      setTimeout(() => {
        // Botón imprimir
        const btn = document.getElementById('btn-imprimir-ficha');
        if (btn) btn.onclick = () => {
          const fichaDiv = document.getElementById('ev-feedback-ficha');
          // Clonar el HTML y reemplazar el textarea por su valor para impresión
          let fichaHtml = fichaDiv.innerHTML;
          const compromisos = document.getElementById('ev-feedback-ficha-compromisos').value;
          fichaHtml = fichaHtml.replace(/<textarea[^>]*id="ev-feedback-ficha-compromisos"[^>]*>[\s\S]*?<\/textarea>/,
            `<div style='min-height:40px; border-bottom:1px dashed #B0BEC5; margin-top:4px;white-space:pre-line;'>${compromisos ? compromisos.replace(/</g, '&lt;').replace(/>/g, '&gt;') : '&nbsp;'}</div>`);
          // Eliminar cualquier canvas/botón de firma en impresión si existiera
          fichaHtml = fichaHtml.replace(/<canvas[^>]*id="firma-supervisor-canvas"[^>]*>[\s\S]*?<\/canvas>/, '');
          fichaHtml = fichaHtml.replace(/<button[^>]*id="firma-supervisor-clear"[^>]*>[\s\S]*?<\/button>/, '');
          const win = window.open('', '', 'width=800,height=900');
          win.document.write('<html><head><title>Ficha de Feedback</title><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Segoe+UI:400,700&display=swap"><style>body{font-family:Segoe UI,Arial,sans-serif;background:#fff;color:#263238;padding:0;margin:0;}button{display:none;}img{max-height:38px;}div{box-sizing:border-box;}</style></head><body>' + fichaHtml + '</body></html>');
          win.document.close();
          setTimeout(() => { win.print(); win.close(); }, 400);
        };
        // Inicializar canvas de firma supervisor y botón borrar
        const canvas = document.getElementById('firma-supervisor-canvas');
        const clearBtn = document.getElementById('firma-supervisor-clear');
        if (canvas && canvas.getContext) {
          const ctx = canvas.getContext('2d');
          let drawing = false, lastX = 0, lastY = 0;
          const getXY = e => {
            const rect = canvas.getBoundingClientRect();
            return [
              (e.touches ? e.touches[0].clientX : e.clientX) - rect.left,
              (e.touches ? e.touches[0].clientY : e.clientY) - rect.top
            ];
          };
          const start = e => { drawing = true;[lastX, lastY] = getXY(e); };
          const move = e => {
            if (!drawing) return;
            const [x, y] = getXY(e);
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(x, y);
            ctx.strokeStyle = '#263238';
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.stroke();
            [lastX, lastY] = [x, y];
          };
          const stop = () => { drawing = false; };
          canvas.addEventListener('mousedown', start);
          canvas.addEventListener('mousemove', move);
          canvas.addEventListener('mouseup', stop);
          canvas.addEventListener('mouseout', stop);
          canvas.addEventListener('touchstart', start);
          canvas.addEventListener('touchmove', move);
          canvas.addEventListener('touchend', stop);
        }
        if (clearBtn && canvas && canvas.getContext) {
          clearBtn.onclick = () => {
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
          };
        }
      }, 0);
      if (evolutivoChart) evolutivoChart.destroy();
      const ctx = document.getElementById('evolutivo-chart').getContext('2d');
      const values = m.series.map(s => s[kpiKey]);
      // Calcular promedio del equipo para cada fecha
      const fechas = m.series.map(s => s.fecha);
      const equipoProm = fechas.map(f => {
        // Filtrar todos los registros de esa fecha
        const todos = evolutivoRawData.filter(d => d.fecha === f);
        // Promedio de ese KPI en esa fecha
        const arr = todos.map(d => d[kpiKey]).filter(v => typeof v === 'number' && !isNaN(v));
        if (!arr.length) return null;
        return arr.reduce((a, b) => a + b, 0) / arr.length;
      });
      // --- Integración con Sistema Predictivo para Gráfico ---
      let proyeccionData = Array(values.length - 1).fill(null);
      proyeccionData.push(values[values.length - 1]); // Conectar con el último punto real

      const configKpi = window.sistemaPredictivo ? window.sistemaPredictivo.analizarEjecutivo(name, { [kpiKey]: m.last }) : null;
      let valorProyectado = null;

      if (configKpi && configKpi.kpis[kpiKey]) {
        valorProyectado = configKpi.kpis[kpiKey].prediccion.valorProyectado;
        proyeccionData.push(valorProyectado);
      }

      const labels = m.series.map(s => {
        const d = new Date(s.fecha + 'T00:00:00');
        const month = getShiftedMonth(d, { month: 'long' }, 'es-ES');
        return month.charAt(0).toUpperCase() + month.slice(1);
      });

      if (valorProyectado !== null) {
        labels.push("Proyección (7d)");
      }

      evolutivoChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            {
              label: kpiLabel,
              data: values,
              borderColor: '#2e7d32',
              backgroundColor: 'rgba(46,125,50,0.1)',
              fill: true,
              tension: 0.4
            },
            {
              label: 'Proyección Predictiva',
              data: proyeccionData,
              borderColor: '#2563eb',
              borderDash: [5, 5],
              pointStyle: 'circle',
              pointRadius: 6,
              pointBackgroundColor: '#2563eb',
              fill: false,
              tension: 0.4
            },
            {
              label: 'Promedio Móvil (2s)',
              data: values.map((v, i, arr) => i === 0 ? v : (arr[i] + arr[i - 1]) / 2),
              borderColor: '#f9a825',
              borderDash: [5, 5],
              pointRadius: 0,
              fill: false
            },
            {
              label: 'Promedio Equipo',
              data: equipoProm,
              borderColor: '#888',
              borderDash: [2, 6],
              pointRadius: 0,
              fill: false,
              tension: 0.4
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: { boxWidth: 12, font: { size: 10 } }
            },
            tooltip: {
              callbacks: {
                label: function (context) {
                  let label = context.dataset.label || '';
                  if (label) label += ': ';
                  if (context.parsed.y !== null) {
                    label += kpiKey === 'tmo' ? context.parsed.y.toFixed(2) + ' min' : Math.round(context.parsed.y) + '%';
                  }
                  return label;
                }
              }
            }
          },
          scales: {
            y: { ticks: { font: { size: 10 }, callback: v => kpiKey === 'tmo' ? v : v + '%' } },
            x: { ticks: { font: { size: 10 }, autoSkip: true, maxRotation: 0, maxTicksLimit: 5 } }
          }
        }
      });
      // Refresh list to show 'selected' state
      renderEvolutivoList(document.getElementById('evolutivo-search').value);
    };

    // Helper de Estado
    function getExecStatus(kpiKey, m) {
      if (!m || !dashboardData || !dashboardData.resumen) return "CRITICAL";
      let meta = getKpiMetaValue(kpiKey, dashboardData.resumen);
      const actual = m.last;
      const isTmo = kpiKey === 'tmo';
      if (!isTmo) meta = meta * 100;

      const cumple = isTmo ? (actual <= meta) : (actual >= meta);
      const brecha = Math.abs(actual - meta);

      if (cumple) {
        return brecha > (isTmo ? 0.5 : 5) ? "GOLD" : "SILVER";
      } else {
        return brecha < (isTmo ? 0.5 : 5) ? "BRONZE" : "CRITICAL";
      }
    }

    function getStatusIcon(status) {
      switch (status) {
        case 'GOLD': return '🥇';
        case 'SILVER': return '🥈';
        case 'BRONZE': return '🥉';
        case 'CRITICAL': return '🚨';
        default: return '';
      }
    }

    // Lógica de alertas inteligentes
    function getExecAlerts(name) {
      const alerts = [];
      // 1. 3+ días bajo meta consecutivos
      const kpis = ['satisfaccion_snl', 'resolucion_snl', 'satisfaccion_ep', 'resolucion_ep', 'tmo', 'epa', 'tipificaciones'];
      kpis.forEach(kpi => {
        const series = evolutivoRawData.filter(d => d.nombre === name).sort((a, b) => new Date(a.fecha) - new Date(b.fecha));
        let meta = getKpiMetaValue(kpi, dashboardData.resumen);
        if (kpi !== 'tmo') meta = meta * 100;
        let count = 0, maxStreak = 0;
        for (let i = 0; i < series.length; ++i) {
          const val = series[i][kpi];
          const bajo = kpi === 'tmo' ? val > meta : val < meta;
          if (bajo) { count++; maxStreak = Math.max(maxStreak, count); } else { count = 0; }
        }
        if (maxStreak >= 3) alerts.push({ type: 'bajo-meta', kpi });
      });
      // 2. Caída >10% vs semana anterior
      kpis.forEach(kpi => {
        const series = evolutivoRawData.filter(d => d.nombre === name).sort((a, b) => new Date(a.fecha) - new Date(b.fecha));
        for (let i = 1; i < series.length; ++i) {
          const prev = series[i - 1][kpi], curr = series[i][kpi];
          if (typeof prev === 'number' && typeof curr === 'number' && prev !== 0) {
            const diff = ((curr - prev) / Math.abs(prev)) * 100;
            if ((kpi === 'tmo' ? diff > 10 : diff < -10)) alerts.push({ type: 'caida', kpi });
          }
        }
      });
      // 3. Riesgo de perder Top 3 (simplificado: si está en top 3 y su valor es igual o menor al 4to)
      // (Solo para el KPI actual)
      const kpi = currentEvolutivoKPI;
      const all = [...new Set(evolutivoRawData.map(d => d.nombre))].map(n => {
        const m = getMetrics(n, kpi); return { n, v: m ? m.last : 0 };
      }).sort((a, b) => kpi === 'tmo' ? a.v - b.v : b.v - a.v);
      const idx = all.findIndex(e => e.n === name);
      if (idx >= 0 && idx < 3 && all[3] && ((kpi === 'tmo' && all[idx].v >= all[3].v) || (kpi !== 'tmo' && all[idx].v <= all[3].v))) {
        alerts.push({ type: 'top3', kpi });
      }
      return alerts;
    }

    function renderEvolutivoList(filter = "") {
      if (typeof currentEvolutivoKPI === 'undefined') window.currentEvolutivoKPI = 'satisfaccion_snl';
      const container = document.getElementById('evolutivo-exec-list');
      const names = [...new Set(evolutivoRawData.map(d => d.nombre))].filter(n => n.toLowerCase().includes(filter.toLowerCase()));
      container.innerHTML = names.map(name => {
        const m = getMetrics(name, currentEvolutivoKPI);
        const status = getExecStatus(currentEvolutivoKPI, m);
        const icon = getStatusIcon(status);
        const alerts = getExecAlerts(name);
        const badge = alerts.length ? '<span class="alert-badge" title="Alerta"></span>' : '';
        return `<div class="exec-item ${currentEvolutivoExec === name ? 'selected' : ''}" onclick="showEvolutivoDetail('${name}')"><span>${badge}${name} <span title="${status}" style="cursor:help;">${icon}</span></span><span class="trend-tag trend-${m.tag}">${m.tag}</span></div>`;
      }).join('');
    }

    function main() {
      // 1. Inicializar Datos y Mantenimiento
      initMaintainerData();

      // 2. Cargar Datos y UI Inicial
      dashboardData = loadDemoData();
      // Regenerar datos evolutivos basados en los nombres actuales
      window.evolutivoRawData = generateEvolutivoData();

      setTheme(theme);
      setupTooltips();
      setupMaintainerTabs(); // Asegurar que el select de importación se llene al inicio
      updateDynamicLabels(); // Asegurar que las etiquetas se llenen al inicio

      // 3. Listeners Globales (No recrear en cada render)
      document.addEventListener('change', (e) => {
        if (e.target && e.target.id === 'filtro-ejecutivo') {
          window.selectedExecutive = e.target.value || '';
          renderDashboard();
        }
        if (e.target && e.target.id === 'granularity-select') {
          window.kpiGranularity = e.target.value;
          renderDashboard();
        }
      });

      document.addEventListener('click', (e) => {
        if (e.target.id === 'btn-mostrar-todos') {
          window.mostrarTodosExpandido = !window.mostrarTodosExpandido;
          // Resetear filtro de ejecutivo
          window.selectedExecutive = '';
          const filterSelect = document.getElementById('filtro-ejecutivo');
          if (filterSelect) filterSelect.value = '';
          renderDashboard();
        }
      });

      // 4. Listeners Mantenimiento (Botones Header / Modales)
      const btnH = document.getElementById('btn-historial');
      const btnA = document.getElementById('btn-actualizar-excel');
      const modH = document.getElementById('modal-historial');
      const modA = document.getElementById('modal-actualizar');

      if (btnH && modH) {
        btnH.onclick = () => { modH.classList.add('open'); setupMaintainerTabs(); renderHistorialTable(); };
        const closeH = document.getElementById('historial-close');
        if (closeH) closeH.onclick = () => modH.classList.remove('open');
        const closeH2 = document.getElementById('btn-historial-close');
        if (closeH2) closeH2.onclick = () => modH.classList.remove('open');
        const saveH = document.getElementById('btn-historial-save');
        if (saveH) {
          saveH.onclick = () => {
            saveMaintainerData();
            alert('Cambios guardados localmente.');
            modH.classList.remove('open');
            renderDashboard();
          };
        }
        const searchH = document.getElementById('historial-search');
        if (searchH) searchH.oninput = (e) => renderHistorialTable(e.target.value);
      }

      if (btnA && modA) {
        btnA.onclick = () => { modA.classList.add('open'); document.getElementById('import-input').value = ""; document.getElementById('import-preview-container').style.display = 'none'; };
        const closeA = document.getElementById('actualizar-close');
        if (closeA) closeA.onclick = () => modA.classList.remove('open');
        const cancelA = document.getElementById('btn-actualizar-cancel');
        if (cancelA) cancelA.onclick = () => modA.classList.remove('open');

        const inputA = document.getElementById('import-input');
        if (inputA) inputA.oninput = handleExcelPaste;
        const selectA = document.getElementById('import-metric');
        if (selectA) selectA.onchange = handleExcelPaste;

        const applyA = document.getElementById('btn-actualizar-apply');
        if (applyA) applyA.onclick = applyImport;

        // Mostrar/ocultar selector de mes y actualizar preview
        document.querySelectorAll('input[name="import-format"]').forEach(radio => {
          radio.onchange = () => {
            const isSingle = document.querySelector('input[name="import-format"]:checked').value !== '4cols';
            const mSelect = document.getElementById('import-month-select');
            if (mSelect) mSelect.style.display = isSingle ? 'flex' : 'none';
            handleExcelPaste();
          };
        });
        document.querySelectorAll('input[name="target-month"]').forEach(radio => {
          radio.onchange = handleExcelPaste;
        });

        const tplA = document.getElementById('btn-download-tpl');
        if (tplA) {
          tplA.onclick = () => {
            const metricLabel = M_METRICS.find(m => m.key === document.getElementById('import-metric').value).label;
            const csv = `Nombre del Ejecutivo\t${M_MONTH_LABELS[0]}\t${M_MONTH_LABELS[1]}\t${M_MONTH_LABELS[2]}\t${M_MONTH_LABELS[3]}\t${M_MONTH_LABELS[4]}\n` + getDynamicExecutives().map(n => n + "\t0\t0\t0\t0\t0").join("\n");
            const blob = new Blob([csv], { type: 'text/tab-separated-values' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = "Plantilla_" + metricLabel.replace(/\s/g, '_') + ".tsv";
            a.click();
          };
        }
      }

      // 5. Otros Componentes
      const btnE = document.getElementById('btn-evolutivo-3m');
      if (btnE) {
        btnE.onclick = () => {
          // Protección con clave para el evolutivo
          let clave = prompt('Ingrese la clave de acceso para el Evolutivo:');
          if (clave !== 'ADMIN2026') {
            alert('Clave incorrecta. Acceso denegado.');
            return;
          }
          document.getElementById('evolutivo-panel').classList.add('open');
          document.getElementById('evolutivo-search').value = "";
          renderEvolutivoList();
        };
      }
      const closeE = document.getElementById('evolutivo-close');
      if (closeE) closeE.onclick = () => document.getElementById('evolutivo-panel').classList.remove('open');

      const searchE = document.getElementById('evolutivo-search');
      if (searchE) searchE.oninput = (e) => renderEvolutivoList(e.target.value);

      const tabsE = document.getElementById('evolutivo-kpi-tabs');
      if (tabsE) {
        tabsE.onclick = (e) => {
          const tab = e.target.closest('.kpi-tab');
          if (tab && currentEvolutivoExec) showEvolutivoDetail(currentEvolutivoExec, tab.dataset.kpi);
        };
      }

      document.getElementById('theme-toggle').onclick = () => { theme = theme === 'dark' ? 'light' : 'dark'; setTheme(theme); };
      document.getElementById('config-toggle').onclick = openConfigPanel;
      document.getElementById('config-close').onclick = closeConfigPanel;
      document.getElementById('config-form').onsubmit = applyConfigForm;
      document.getElementById('config-reset').onclick = resetConfigForm;

      document.getElementById('btn-export-permanente').onclick = () => {
        const htmlContent = document.documentElement.outerHTML;
        // Reemplazar la línea de maintainerData por defecto
        const defaultDataRegex = /let maintainerData = JSON.parse\(localStorage.getItem\('achs-maintainer-data'\)\) \|\| \{.*\};/;
        const currentDataStr = JSON.stringify(maintainerData);
        const newCode = `let maintainerData = JSON.parse(localStorage.getItem('achs-maintainer-data')) || ${currentDataStr};`;
        const updatedHtml = htmlContent.replace(defaultDataRegex, newCode);

        const blob = new Blob([updatedHtml], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = "Dashboard_ACHS_Actualizado.html";
        a.click();
        alert('Se ha descargado el archivo. Si lo guardas sobre el archivo original, los datos serán permanentes al abrirlo en cualquier PC.');
      };

      document.querySelectorAll('.kpi-config-panel, .evolutivo-panel, .modal-overlay').forEach(p => {
        p.addEventListener('keydown', e => { if (e.key === 'Escape') p.classList.remove('open'); });
      });

      // 6. Primera Carga del Tablero
      updateDynamicLabels();
      renderDashboard();
    } window.onload = main;
  </script>
  <script>
    // Eliminar badges 'Sin dato' y emoji gris generados por bloques duplicados
    document.addEventListener('DOMContentLoaded', function () {
      document.querySelectorAll('.kpi__estado').forEach(chip => {
        const txt = (chip.textContent || '').trim();
        if (!txt || txt.includes('Sin dato') || txt.includes('⚪')) {
          chip.remove();
        }
      });
    });
  </script>
  <!-- Podio 3 más bajos (KPIs solicitados) -->
  <script>
    (function(){
      const STORAGE_KEY = 'dashboard_metricas_historial';
      const KPI_KEYS = ['satisfaccion_snl','resolucion_snl','satisfaccion_ep','resolucion_ep','tmo','epa','tipificaciones'];
      const THRESHOLDS = { satisfaccion_snl:95, resolucion_snl:90, satisfaccion_ep:95, resolucion_ep:90, tmo:5, epa:85, tipificaciones:95 };

      function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
      function latest(series){ if(!series||!Array.isArray(series)||series.length===0) return null; const last = series[series.length-1]; return (typeof last.valor!=='undefined'? last.valor : (last.value!==undefined? last.value : null)); }

      function readHist(){ try{ const r = localStorage.getItem(STORAGE_KEY); return r? JSON.parse(r): null; }catch(e){ console.warn('leer historial',e); return null; } }

      function computeTop3(){
        const data = readHist(); if(!data) return [];
        const execs = Object.keys(data||{});
        const results = execs.map(name=>{
          const raw = data[name]; const vals = {}; const scores = [];
          KPI_KEYS.forEach(k=>{
            const series = raw && (raw[k] || raw[k.toLowerCase()]) ? (raw[k]||raw[k.toLowerCase()]) : null;
            const v = latest(series);
            let value = (v===null||v===undefined||isNaN(v))? null: Number(v);
            if(value!==null && k!=='tmo'){ if(value<=1) value = value*100; }
            let normalized = null;
            if(value!==null && !isNaN(value)){
              if(k==='tmo'){ if(value>0) normalized = Math.min(100,(THRESHOLDS.tmo / value)*100); }
              else normalized = Math.max(0,Math.min(100,Number(value)));
            }
            if(normalized!==null) scores.push(normalized);
            vals[k] = { raw: v, normalized };
          });
          const score = scores.length? scores.reduce((a,b)=>a+b,0)/scores.length : null;
          return { id:name, label:name, vals, score };
        }).filter(r=>r.score!==null && !isNaN(r.score));
        return results.sort((a,b)=>a.score - b.score).slice(0,3);
      }

      function makeButton(){
        if(document.getElementById('podio-btn')) return document.getElementById('podio-btn');
        const b = document.createElement('button');
        b.id = 'podio-btn';
        b.textContent = 'Podio 3 bajos';
        // estilos base
        Object.assign(b.style,{
          background: '#b00020',
          color: '#fff',
          border: 'none',
          padding: '10px 12px',
          borderRadius: '8px',
          cursor: 'pointer'
        });
        // intentar insertar dentro del modal de cuartiles si existe
        const cuartModal = document.getElementById('cuartiles-modal');
        if(cuartModal){
          // colocar antes del contenido principal para que quede junto al título
          const content = cuartModal.querySelector('#cuartiles-content');
          if(content) cuartModal.insertBefore(b, content);
          else cuartModal.appendChild(b);
          // ajustar margen para separación
          b.style.margin = '6px 0 8px 0';
        } else {
          Object.assign(b.style,{position:'fixed',left:'18px',bottom:'18px',zIndex:12000});
          document.body.appendChild(b);
        }
        return b;
      }
      function makeModal(){ if(document.getElementById('podio-modal')) return document.getElementById('podio-modal'); const m=document.createElement('div'); m.id='podio-modal'; Object.assign(m.style,{display:'none',position:'fixed',left:'18px',bottom:'70px',zIndex:12000,background:'#fff',borderRadius:'8px',boxShadow:'0 8px 30px rgba(0,0,0,0.2)',maxWidth:'520px',width:'480px',padding:'12px',fontFamily:'Segoe UI,Arial'}); m.innerHTML='<button id="podio-close" style="float:right;background:transparent;border:none;cursor:pointer">✕</button><h4 style="margin:6px 0 8px 0">Podio — 3 ejecutivos con menor score</h4><div id="podio-content">Cargando...</div>'; document.body.appendChild(m); return m; }

      function render(){ const modal = makeModal(); const content = modal.querySelector('#podio-content'); content.innerHTML='Calculando...'; const top = computeTop3(); if(!top||!top.length){ content.innerHTML='<div style="color:#666">No hay datos en el historial.</div>'; return; } let html='<ol style="padding-left:18px">'; top.forEach(t=>{ html+='<li style="margin:8px 0"><strong>'+escapeHtml(t.label)+'</strong> — Score: '+(t.score!==null?Number(t.score).toFixed(2):'–')+'<div style="font-size:12px;color:#666;margin-top:6px">'; KPI_KEYS.forEach(k=>{ const meta=THRESHOLDS[k]; const raw=t.vals[k].raw; const norm=t.vals[k].normalized; let disp=(raw===null||raw===undefined)?'–':(k==='tmo'? Number(raw).toFixed(2)+' min': (Number(raw)>1? Number(raw).toFixed(1)+'%': (Number(raw)*100).toFixed(1)+'%')); let flag=''; if(raw!==null&&raw!==undefined&&!isNaN(raw)){ if(k==='tmo'){ if(Number(raw)>THRESHOLDS.tmo) flag=' ⚠️'; } else { let v=Number(raw); if(v<=1) v=v*100; if(v<meta) flag=' ⚠️'; } } html+='<div>'+escapeHtml(k)+': <strong style="float:right">'+disp+flag+'</strong></div>'; }); html+='</div></li>'; }); html+='</ol>'; content.innerHTML=html; }

      document.addEventListener('DOMContentLoaded', function(){
        // Mostrar botón solo después de autenticación en sessionStorage
        function createLogin(){
          if(document.getElementById('podio-login')) return document.getElementById('podio-login');
          const m = document.createElement('div'); m.id='podio-login'; Object.assign(m.style,{position:'fixed',left:'50%',top:'50%',transform:'translate(-50%,-50%)',zIndex:12001,background:'#fff',borderRadius:'8px',boxShadow:'0 12px 40px rgba(0,0,0,0.25)',width:'380px',padding:'18px',fontFamily:'Segoe UI,Arial'});
          m.innerHTML = '<h3 style="margin-top:0">Ingreso requerido</h3><div style="margin:8px 0"><label>RUT</label><input id="podio-rut" style="width:100%;padding:8px;margin-top:6px"/></div><div style="margin:8px 0"><label>Clave</label><input id="podio-clave" type="password" style="width:100%;padding:8px;margin-top:6px"/></div><div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px"><button id="podio-cancel" style="background:transparent;border:1px solid #ccc;padding:8px 12px;border-radius:6px;">Cancelar</button><button id="podio-ok" style="background:#1E7F4F;color:#fff;border:none;padding:8px 12px;border-radius:6px">Ingresar</button></div>';
          document.body.appendChild(m);
          return m;
        }

        function downloadCSV(top){
          const hdr = ['id','label','score'].concat(KPI_KEYS);
          const rows = top.map(t=>{
            const rawVals = KPI_KEYS.map(k=>{ const v = t.vals && t.vals[k] ? t.vals[k].raw : null; return (v===null||v===undefined)?'':String(v); });
            return [t.id, t.label, (t.score!==null?Number(t.score).toFixed(2):'')].concat(rawVals);
          });
          const csv = [hdr].concat(rows).map(r=>r.map(c=>'"'+String(c).replace(/"/g,'""')+'"').join(',')).join('\n');
          const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
          const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'podio_3_bajos.csv'; a.click(); URL.revokeObjectURL(url);
        }

        function showUI(){
          const btn = makeButton(); const modal = makeModal(); btn.style.display='';
          btn.addEventListener('click', function(){ render(); modal.style.display='block';
            // añadir botón export si no existe
            if(!document.getElementById('podio-export')){
              const content = modal.querySelector('#podio-content');
              const exp = document.createElement('button'); exp.id='podio-export'; exp.textContent='Exportar CSV'; Object.assign(exp.style,{marginTop:'8px',background:'#0a62a3',color:'#fff',border:'none',padding:'6px 10px',borderRadius:'6px',cursor:'pointer'});
              content.parentNode.insertBefore(exp, content.nextSibling);
              exp.addEventListener('click', function(){ const top = computeTop3(); downloadCSV(top); });
            }
          });
          modal.addEventListener('click', function(e){ if(e.target && e.target.id==='podio-close') modal.style.display='none'; });
          document.addEventListener('click', function(e){ if(!modal.contains(e.target) && e.target !== btn) modal.style.display='none'; }, true);
          document.addEventListener('keydown', function(e){ if(e.key==='Escape') modal.style.display='none'; });
        }
        // Exponer para que otros scripts (p.ej. el login principal) puedan activar el Podio
        try{ window.achs_showPodioUI = showUI; }catch(e){}

        if(sessionStorage.getItem('achs_auth') === '1'){
          showUI();
          return;
        }

        // Omite el cuadro de "Ingreso requerido" y muestra la UI directamente
        sessionStorage.setItem('achs_auth','1');
        showUI();
      });
    })();
  </script>
</body>
<style>
  :root {
    --kpi-verde: #1E7F4F;
    --kpi-amarillo: #C79200;
    --kpi-rojo: #B00020;
    --kpi-gris: #6B7280;
  }

  .kpi {
    display: inline-flex;
    align-items: center;
    gap: 0.5em;
    margin: 0.2em 0.5em 0.2em 0;
    border-radius: 0.5em;
    padding: 0.2em 0.6em 0.2em 0.4em;
  }

  .kpi__valor {
    font-weight: bold;
    margin-left: 0.2em;
  }

  .kpi__estado {
    display: inline-block;
    margin-left: 0.5em;
    padding: 0.1em 0.7em;
    border-radius: 1em;
    font-size: 0.95em;
    font-weight: 600;
    letter-spacing: 0.01em;
    color: #fff;
    vertical-align: middle;
    min-width: 4.5em;
    text-align: center;
  }

  .kpi--verde {
    background: rgba(30, 127, 79, 0.08);
  }

  .kpi--amarillo {
    background: rgba(199, 146, 0, 0.08);
  }

  .kpi--rojo {
    background: rgba(176, 0, 32, 0.08);
  }

  .kpi--gris {
    background: rgba(107, 114, 128, 0.08);
  }

  .kpi--verde .kpi__estado {
    background: var(--kpi-verde);
  }

  .kpi--amarillo .kpi__estado {
    background: var(--kpi-amarillo);
  }

  .kpi--rojo .kpi__estado {
    background: var(--kpi-rojo);
  }

  .kpi--gris .kpi__estado {
    background: var(--kpi-gris);
  }
</style>
<script>
  (function () {
    // Configuración de umbrales y mapeo de KPI
    const kpiMap = [
      {
        keys: ['satisfaccion-snl', 'satisfacción-snl', 'satisfaccion snl', 'satisfacción snl'],
        label: /satisfac[ci][óo]n\\s*snl/i,
        type: 'porcentaje',
        umbrales: { verde: 95, amarillo: 85, rojo: 85, sentido: 'mayor' }
      },
      {
        keys: ['satisfaccion-ep', 'satisfacción-ep', 'satisfaccion ep', 'satisfacción ep'],
        label: /satisfac[ci][óo]n\\s*ep/i,
        type: 'porcentaje',
        umbrales: { verde: 95, amarillo: 85, rojo: 85, sentido: 'mayor' }
      },
      {
        keys: ['resolucion-snl', 'resolución-snl', 'resolucion snl', 'resolución snl'],
        label: /resoluci[óo]n\\s*snl/i,
        type: 'porcentaje',
        umbrales: { verde: 95, amarillo: 94, rojo: 80, sentido: 'mayor' }
      },
      {
        keys: ['resolucion-ep', 'resolución-ep', 'resolucion ep', 'resolución ep'],
        label: /resoluci[óo]n\\s*ep/i,
        type: 'porcentaje',
        umbrales: { verde: 95, amarillo: 94, rojo: 80, sentido: 'mayor' }
      },
      {
        keys: ['tmo', 'tiempo-medio-operacion', 'tiempo medio de operacion', 'tiempo medio de operación'],
        label: /tmo|tiempo\\s*medio\\s*de\\s*operaci[óo]n/i,
        type: 'minutos',
        umbrales: { verde: 3.00, amarillo: 5.00, rojo: 5.00, sentido: 'menor' }
      },
      {
        keys: ['transferencia-epa', 'transferencia a epa'],
        label: /transferencia\\s*a\\s*epa/i,
        type: 'porcentaje',
        umbrales: { verde: 85, amarillo: 70, rojo: 70, sentido: 'mayor' }
      },
      {
        keys: ['tipificaciones', 'tipificacion'],
        label: /tipificaci[óo]n|tipificaciones/i,
        type: 'porcentaje',
        umbrales: { verde: 90, amarillo: 80, rojo: 80, sentido: 'mayor' }
      }
    ];

    // Utilidades de parseo
    function parsePorcentaje(str) {
      if (!str) return null;
      let val = str.replace(',', '.').replace('%', '').trim();
      let num = parseFloat(val);
      return isNaN(num) ? null : num;
    }
    function parseMinutos(str) {
      if (!str) return null;
      str = str.replace(',', '.');
      if (/^[0-9]+([\\.,][0-9]+)?$/.test(str)) return parseFloat(str); // decimal
      let partes = str.split(':').map(s => parseFloat(s.replace(',', '.')));
      if (partes.length === 2) return partes[0] + (partes[1] / 60);
      if (partes.length === 3) return partes[0] * 60 + (partes[1]) + (partes[2] / 60);
      return null;
    }
    function normalizaTexto(txt) {
      return txt.normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase();
    }
    function getKpiType(el) {
      // Estrategia A: data-kpi
      let kpi = el.getAttribute('data-kpi');
      if (kpi) {
        kpi = normalizaTexto(kpi);
        for (const def of kpiMap) {
          if (def.keys.some(key => normalizaTexto(key) === kpi)) return def;
        }
      }
      // Estrategia B: clase
      for (const def of kpiMap) {
        if (def.keys.some(key => el.classList.contains('kpi--' + key))) return def;
      }
      // Estrategia C: label cercano
      let label = '';
      let labelEl = el.querySelector('.kpi__label');
      if (labelEl) label = labelEl.textContent || '';
      else label = el.textContent || '';
      label = normalizaTexto(label);
      for (const def of kpiMap) {
        if (def.keys.some(key => label.includes(normalizaTexto(key)))) return def;
        if (def.label && def.label.test(label)) return def;
      }
      return null;
    }
    function getValorKpi(el, tipo) {
      // data-kpi-value
      let valEl = el.querySelector('[data-kpi-value]') || el.querySelector('.kpi__valor') || el;
      let raw = valEl.textContent || '';
      if (tipo === 'porcentaje') return parsePorcentaje(raw);
      if (tipo === 'minutos') return parseMinutos(raw);
      return null;
    }
    function getEstadoKpi(valor, def) {
      if (valor === null || valor === undefined || isNaN(valor)) return { estado: 'gris', texto: 'Sin dato', emoji: '⚪' };
      if (def.type === 'porcentaje') {
        if (valor >= def.umbrales.verde) return { estado: 'verde', texto: 'Verde', emoji: '🟢' };
        if (valor >= def.umbrales.amarillo) return { estado: 'amarillo', texto: 'Amarillo', emoji: '🟡' };
        return { estado: 'rojo', texto: 'Rojo', emoji: '🔴' };
      }
      if (def.type === 'minutos') {
        if (valor <= def.umbrales.verde) return { estado: 'verde', texto: 'Verde', emoji: '🟢' };
        if (valor <= def.umbrales.amarillo) return { estado: 'amarillo', texto: 'Amarillo', emoji: '🟡' };
        return { estado: 'rojo', texto: 'Rojo', emoji: '🔴' };
      }
      return { estado: 'gris', texto: 'Sin dato', emoji: '⚪' };
    }

    // 1. Buscar todos los posibles contenedores KPI
    let kpiEls = Array.from(document.querySelectorAll('.kpi, [data-kpi]'));
    // Eliminar duplicados
    kpiEls = kpiEls.filter((el, i, arr) => arr.indexOf(el) === i);

    kpiEls.forEach(el => {
      // 2. Inferir tipo de KPI
      const def = getKpiType(el);
      // 3. Extraer valor
      const valor = def ? getValorKpi(el, def.type) : null;
      // 4. Evaluar estado
      const estado = def ? getEstadoKpi(valor, def) : { estado: 'gris', texto: 'Sin dato', emoji: '⚪' };
      // 5. Limpiar clases previas de estado
      el.classList.remove('kpi--verde', 'kpi--amarillo', 'kpi--rojo', 'kpi--gris');
      el.classList.add('kpi--' + estado.estado);
      // 6. Insertar/actualizar badget de estado
      let chip = el.querySelector('.kpi__estado');
      if (!chip) {
        chip = document.createElement('span');
        chip.className = 'kpi__estado';
        el.appendChild(chip);
      }
      chip.textContent = estado.texto;
      chip.setAttribute('aria-label', 'Estado: ' + estado.texto);
      chip.setAttribute('title', 'Estado: ' + estado.texto);
      chip.innerText = estado.emoji + ' ' + estado.texto;
    });
  })();
</script>

<!-- Sistema Predictivo con Historial -->
<script src="sistema_predictivo_historial.js"></script>

<script>
  /**
   * Lógica de Integración del Sistema Predictivo
   * Escanea las tablas y aplica el análisis basado en el historial
   */
  (function () {
    'use strict';

    window.ejecutarAnalisisPredictivo = function () {
      if (!window.sistemaPredictivo) {
        console.warn('Sistema Predictivo no cargado');
        return;
      }

      // 0. Depurar ejecutivos que ya no están en la base de datos (Maintainer)
      const ejecutivosBase = typeof getDynamicExecutives === 'function' ? getDynamicExecutives() : [];
      if (ejecutivosBase.length > 0) {
        window.sistemaPredictivo.historial.depurarHistorial(ejecutivosBase);
      }

      // 1. Obtener todas las tablas de ejecutivos
      const tablas = [
        'tabla-ejecutivos',
        'tabla-ejecutivos-epa',
        'tabla-ejecutivos-tmo',
        'tabla-ejecutivos-notaepa'
      ];

      const ejecutivosAnalizados = new Set();

      tablas.forEach(id => {
        const tabla = document.getElementById(id);
        if (!tabla) return;

        const filas = tabla.querySelectorAll('tbody tr');
        filas.forEach(fila => {
          // Obtener nombre del ejecutivo (primera celda)
          const nombre = fila.cells[0]?.textContent.trim();
          if (!nombre || nombre === 'No hay datos' || nombre.includes('Selecciona')) return;

          // Si ya lo analizamos en otra tabla, solo aplicamos la alerta visual
          if (ejecutivosAnalizados.has(nombre)) {
            const analisisExistente = window.ultimoAnalisisPredictivo?.[nombre];
            if (analisisExistente) {
              window.sistemaPredictivo.aplicarAlertasVisuales(fila, analisisExistente);
            }
            return;
          }

          // Extraer todas las métricas posibles de este ejecutivo
          // Alimentamos el sistema con el historial de los 5 meses para que tenga tendencia real
          const histMetricas = extraerHistorialCompleto(nombre);
          let analisis = null;

          if (Object.keys(histMetricas).length > 0) {
            // Registramos el historial en orden cronológico (m1 -> m5)
            for (let i = 1; i <= 5; i++) {
              const mKey = 'm' + i;
              const date = new Date();
              date.setMonth(date.getMonth() - (5 - i));

              Object.entries(histMetricas).forEach(([kpiId, values]) => {
                if (values[mKey] !== undefined) {
                  window.sistemaPredictivo.historial.registrarMetricaConFecha(nombre, kpiId, values[mKey], date.toISOString());
                }
              });
            }

            // Ahora analizamos con el último valor
            const metricasActuales = extraerMetricasEjecutivo(nombre);
            analisis = window.sistemaPredictivo.analizarEjecutivo(nombre, metricasActuales);
            window.sistemaPredictivo.aplicarAlertasVisuales(fila, analisis);

            // Guardar para referencia rápida
            window.ultimoAnalisisPredictivo = window.ultimoAnalisisPredictivo || {};
            window.ultimoAnalisisPredictivo[nombre] = analisis;
            ejecutivosAnalizados.add(nombre);
          }
        });
      });

      console.log(`🚀 Análisis Predictivo completado para ${ejecutivosAnalizados.size} ejecutivos`);
    };

    /**
     * Extrae las métricas actuales de un ejecutivo desde el dashboardData
     */
    function extraerMetricasEjecutivo(nombre) {
      const metricas = {};

      // Intentar sacar de getExecListForDashboard (que es lo que usa el render)
      const execs = typeof getExecListForDashboard === 'function' ? getExecListForDashboard() : [];
      const ej = execs.find(e => e.nombre === nombre);

      if (ej) {
        // Mapeo de campos de index.html a IDs de sistema_predictivo
        if (ej.tipificaciones_actual !== undefined) metricas['tipificaciones'] = ej.tipificaciones_actual * 100;
        if (ej.epa_actual !== undefined) metricas['epa'] = ej.epa_actual * 100;
        if (ej.tmo_min_actual !== undefined) metricas['tmo'] = ej.tmo_min_actual;

        // Nota EPA (si existe maintainerData)
        if (window.maintainerData) {
          const latestField = 'm' + (window.M_MONTH_LABELS ? window.M_MONTH_LABELS.length : 3);
          if (window.maintainerData.satisfaccion_snl?.[nombre])
            metricas['satisfaccion_snl'] = window.maintainerData.satisfaccion_snl[nombre][latestField] || 0;
          if (window.maintainerData.resolucion_snl?.[nombre])
            metricas['resolucion_snl'] = window.maintainerData.resolucion_snl[nombre][latestField] || 0;
          if (window.maintainerData.satisfaccion_ep?.[nombre])
            metricas['satisfaccion_ep'] = window.maintainerData.satisfaccion_ep[nombre][latestField] || 0;
          if (window.maintainerData.resolucion_ep?.[nombre])
            metricas['resolucion_ep'] = window.maintainerData.resolucion_ep[nombre][latestField] || 0;
        }
      }

      return metricas;
    }

    /**
     * Extrae el historial de los 5 meses para un ejecutivo
     */
    function extraerHistorialCompleto(nombre) {
      const hist = {};
      const kpis = ['tipificaciones', 'epa', 'tmo', 'satisfaccion_snl', 'resolucion_snl', 'satisfaccion_ep', 'resolucion_ep'];

      kpis.forEach(kpi => {
        if (window.maintainerData?.[kpi]?.[nombre]) {
          hist[kpi] = window.maintainerData[kpi][nombre];
        } else if (kpi === 'tipificaciones' || kpi === 'epa' || kpi === 'tmo') {
          // Intentar sacar de la lista de dashboard si es una métrica base
          const execs = typeof getExecListForDashboard === 'function' ? getExecListForDashboard() : [];
          const ej = execs.find(e => e.nombre === nombre);
          if (ej) {
            // Estas métricas base no tienen historial m1-m5 en la estructura simplificada de execs,
            // así que confiamos en que maintainerData las tenga.
          }
        }
      });
      return hist;
    }

    // Ejecutar al cargar
    document.addEventListener('DOMContentLoaded', function () {
      setTimeout(window.ejecutarAnalisisPredictivo, 2000);
    });

  })();
</script>

<script>
  // Eliminar badges 'Sin dato' y emoji gris generados por bloques duplicados
  document.addEventListener('DOMContentLoaded', function () {
    document.querySelectorAll('.kpi__estado').forEach(chip => {
      const txt = (chip.textContent || '').trim();
      if (!txt || txt.includes('Sin dato') || txt.includes('⚪')) {
        chip.remove();
      }
    });
  });
</script>

<script>
  (function () {
    // Añade controles de Exportar/Importar y persistencia via fichero JSON
    function ensureKpiIds() {
      const els = Array.from(document.querySelectorAll('.kpi, [data-kpi]'));
      els.forEach((el, i) => {
        if (!el.dataset.kpiId) el.dataset.kpiId = 'kpi-' + (i + 1);
      });
      return els;
    }

    function getValorElemento(el) {
      const valEl = el.querySelector('[data-kpi-value]') || el.querySelector('.kpi__valor') || el;
      return (valEl.textContent || '').trim();
    }

    function setValorElemento(el, texto) {
      const valEl = el.querySelector('[data-kpi-value]') || el.querySelector('.kpi__valor') || el;
      if (valEl) valEl.textContent = texto;
    }

    function downloadJSON(obj, filename) {
      const dataStr = 'data:application/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(obj, null, 2));
      const a = document.createElement('a');
      a.setAttribute('href', dataStr);
      a.setAttribute('download', filename || 'kpi-values.json');
      document.body.appendChild(a);
      a.click();
      a.remove();
    }

    function parsePorcentaje(str) {
      if (!str) return null;
      let val = str.replace(',', '.').replace('%', '').trim();
      let num = parseFloat(val);
      return isNaN(num) ? null : num;
    }
    function parseMinutos(str) {
      if (!str) return null;
      str = str.replace(',', '.');
      if (/^[0-9]+([\.,][0-9]+)?$/.test(str)) return parseFloat(str);
      const partes = str.split(':').map(s => parseFloat(s.replace(',', '.')));
      if (partes.length === 2) return partes[0] + (partes[1] / 60);
      if (partes.length === 3) return partes[0] * 60 + partes[1] + (partes[2] / 60);
      return null;
    }

    // Versión reducida del mapping usado en el HTML para evaluar estado
    const kpiMap = [
      { keys: ['satisfaccion-snl'], label: /satisfac[ci][óo]n\s*snl/i, type: 'porcentaje', umbrales: { verde: 95, amarillo: 85 } },
      { keys: ['satisfaccion-ep'], label: /satisfac[ci][óo]n\s*ep/i, type: 'porcentaje', umbrales: { verde: 95, amarillo: 85 } },
      { keys: ['resolucion-snl'], label: /resoluci[óo]n\s*snl/i, type: 'porcentaje', umbrales: { verde: 95, amarillo: 94 } },
      { keys: ['resolucion-ep'], label: /resoluci[óo]n\s*ep/i, type: 'porcentaje', umbrales: { verde: 95, amarillo: 94 } },
      { keys: ['tmo'], label: /tmo|tiempo\s*medio\s*de\s*operaci[óo]n/i, type: 'minutos', umbrales: { verde: 3.0, amarillo: 5.0 } },
      { keys: ['transferencia-epa'], label: /transferencia\s*a\s*epa/i, type: 'porcentaje', umbrales: { verde: 85, amarillo: 70 } },
      { keys: ['tipificaciones'], label: /tipificaci[óo]n|tipificaciones/i, type: 'porcentaje', umbrales: { verde: 95, amarillo: 94 } }
    ];

    function normalizaTexto(txt) {
      return (txt || '').normalize ? txt.normalize('NFD').replace(/[\u0000-\u036f]/g, '') .toLowerCase() : (txt || '').toLowerCase();
    }

    function inferDef(el) {
      const kpi = el.getAttribute('data-kpi') || '';
      if (kpi) {
        const nk = normalizaTexto(kpi);
        for (const def of kpiMap) if (def.keys.some(key => normalizaTexto(key) === nk)) return def;
      }
      const labelEl = el.querySelector('.kpi__label');
      const label = normalizaTexto(labelEl ? (labelEl.textContent || '') : (el.textContent || ''));
      for (const def of kpiMap) {
        if (def.keys.some(key => label.includes(normalizaTexto(key)))) return def;
        if (def.label && def.label.test(label)) return def;
      }
      return null;
    }

    function evaluateKPIs() {
      const els = Array.from(document.querySelectorAll('.kpi, [data-kpi]'));
      els.forEach(el => {
        const def = inferDef(el);
        const raw = getValorElemento(el);
        let valor = null;
        if (def && def.type === 'porcentaje') valor = parsePorcentaje(raw);
        else if (def && def.type === 'minutos') valor = parseMinutos(raw);
        // limpiar clases
        el.classList.remove('kpi--verde', 'kpi--amarillo', 'kpi--rojo', 'kpi--gris');
        let estado = 'gris', texto = '' , emoji = '';
        if (valor !== null && !isNaN(valor)) {
          if (def.type === 'porcentaje') {
            if (valor >= def.umbrales.verde) { estado='verde'; texto='Verde'; emoji='🟢'; }
            else if (valor >= def.umbrales.amarillo) { estado='amarillo'; texto='Amarillo'; emoji='🟡'; }
            else { estado='rojo'; texto='Rojo'; emoji='🔴'; }
          } else if (def.type === 'minutos') {
            if (valor <= def.umbrales.verde) { estado='verde'; texto='Verde'; emoji='🟢'; }
            else if (valor <= def.umbrales.amarillo) { estado='amarillo'; texto='Amarillo'; emoji='🟡'; }
            else { estado='rojo'; texto='Rojo'; emoji='🔴'; }
          }
        }
        el.classList.add('kpi--' + estado);
        let chip = el.querySelector('.kpi__estado');
        if (texto) {
          if (!chip) { chip = document.createElement('span'); chip.className = 'kpi__estado'; el.appendChild(chip); }
          chip.textContent = (emoji ? (emoji + ' ' + texto) : texto);
          chip.setAttribute('aria-label', 'Estado: ' + texto);
          chip.setAttribute('title', 'Estado: ' + texto);
        } else if (chip) chip.remove();
      });
    }

    // Exportar valores actuales a JSON
    function exportKpis() {
      const els = ensureKpiIds();
      const items = els.map(el => ({ id: el.dataset.kpiId, value: getValorElemento(el) }));
      const payload = { exportedAt: new Date().toISOString(), items };
      downloadJSON(payload, 'kpi-values.json');
    }

    // Importar desde JSON (archivo)
    function importKpisFile(file) {
      const reader = new FileReader();
      reader.onload = function (e) {
        try {
          const obj = JSON.parse(e.target.result);
          if (!obj || !Array.isArray(obj.items)) throw new Error('Formato JSON inválido');
          ensureKpiIds();
          obj.items.forEach(it => {
            if (!it.id) return;
            const el = document.querySelector('[data-kpi-id="' + it.id + '"]');
            if (el) setValorElemento(el, it.value);
          });
          evaluateKPIs();
          alert('Valores KPI cargados correctamente');
        } catch (err) {
          alert('Error al cargar JSON: ' + err.message);
        }
      };
      reader.readAsText(file);
    }

    // Crear UI mínima (botones) y file input
    function createControls() {
      const container = document.createElement('div');
      container.style.position = 'fixed';
      container.style.right = '12px';
      container.style.bottom = '12px';
      container.style.zIndex = 9999;
      container.style.display = 'flex';
      container.style.flexDirection = 'column';
      container.style.gap = '6px';

      const btnExport = document.createElement('button');
      btnExport.textContent = 'Exportar KPI';
      btnExport.style.padding = '8px 10px';
      btnExport.style.background = '#0b5fff';
      btnExport.style.color = '#fff';
      btnExport.style.border = 'none';
      btnExport.style.borderRadius = '6px';
      btnExport.style.cursor = 'pointer';
      btnExport.addEventListener('click', exportKpis);

      const btnImport = document.createElement('button');
      btnImport.textContent = 'Importar KPI';
      btnImport.style.padding = '8px 10px';
      btnImport.style.background = '#10b981';
      btnImport.style.color = '#fff';
      btnImport.style.border = 'none';
      btnImport.style.borderRadius = '6px';
      btnImport.style.cursor = 'pointer';

      const inputFile = document.createElement('input');
      inputFile.type = 'file';
      inputFile.accept = 'application/json';
      inputFile.style.display = 'none';
      inputFile.addEventListener('change', function (e) {
        const f = e.target.files && e.target.files[0];
        if (f) importKpisFile(f);
        inputFile.value = '';
      });
      btnImport.addEventListener('click', () => inputFile.click());

      container.appendChild(btnExport);
      container.appendChild(btnImport);
      container.appendChild(inputFile);
      document.body.appendChild(container);
    }

    document.addEventListener('DOMContentLoaded', function () {
      ensureKpiIds();
      createControls();
      // evaluar inicialmente para consistencia
      evaluateKPIs();
    });

    // Hacer la función accesible desde consola si se desea
    window.exportKpis = exportKpis;
    window.importKpisFile = importKpisFile;
    window.evaluateKPIs = evaluateKPIs;
  })();
</script>

</html>